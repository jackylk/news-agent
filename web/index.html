<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§‘æŠ€æ–°é—» - ç½‘é¡µç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* æ–°é—»æºè¿‡æ»¤å¡ç‰‡ */
    .source-filter {
      background: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .source-filter-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .source-filter-title {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .source-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .source-tag {
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .source-tag:hover {
      background-color: #e8e8e8;
      border-color: #667eea;
    }

    .source-tag.active {
      background-color: #667eea;
      color: white;
      border-color: #667eea;
    }

    .source-tag-count {
      font-size: 12px;
      opacity: 0.7;
      background-color: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .source-tag.active .source-tag-count {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .loading, .error, .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .error {
      color: #e74c3c;
    }

    .retry-btn {
      margin-top: 20px;
      padding: 10px 30px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .retry-btn:hover {
      background-color: #5568d3;
    }

    .refresh-btn {
      padding: 8px 16px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.3s;
      margin-bottom: 12px;
    }

    .refresh-btn:hover {
      background-color: #218838;
    }

    .refresh-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .refresh-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .date-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .date-header {
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .date-text {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .news-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .news-item {
      background: #fafafa;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #e0e0e0;
    }

    .news-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      border-color: #667eea;
    }

    .news-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .news-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .news-summary {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.5;
    }

    .news-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #999;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .news-source {
      color: #667eea;
      font-weight: 500;
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-box {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-btn {
      padding: 12px 24px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .search-btn:hover {
      background-color: #5568d3;
    }

    .search-btn:active {
      transform: scale(0.98);
    }

    .clear-search-btn {
      padding: 12px 20px;
      background-color: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .clear-search-btn:hover {
      background-color: #e0e0e0;
    }


    .search-results-header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-results-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .search-results-count {
      font-size: 14px;
      color: #666;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* è¯¦æƒ…é¡µé¢æ ·å¼ */
    #detailView {
      display: none;
    }

    .detail-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .detail-header {
      padding: 30px 40px;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      transition: all 0.3s;
      text-decoration: none;
    }

    .back-btn:hover {
      background-color: #e0e0e0;
      transform: translateX(-2px);
    }

    .detail-title {
      font-size: 36px;
      font-weight: bold;
      color: #1a1a1a;
      line-height: 1.4;
      margin-bottom: 20px;
    }

    .detail-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
      color: #666;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .detail-source {
      color: #667eea;
      font-weight: 600;
    }

    .detail-date {
      color: #999;
    }

    .detail-image {
      width: 100%;
      max-height: 500px;
      object-fit: cover;
      display: block;
    }

    .detail-content {
      padding: 40px;
    }

    .detail-summary {
      font-size: 20px;
      color: #555;
      line-height: 1.8;
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 4px;
    }

    .detail-text {
      font-size: 18px;
      line-height: 1.9;
      color: #333;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .detail-text p {
      margin-bottom: 20px;
    }

    .detail-footer {
      padding: 30px 40px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .source-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background-color: #667eea;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .source-link:hover {
      background-color: #5568d3;
    }

    .share-btn {
      padding: 12px 24px;
      background-color: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .share-btn:hover {
      background-color: #e0e0e0;
    }

    mark {
      background-color: #fff3cd;
      color: #856404;
      padding: 2px 4px;
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .news-items {
        grid-template-columns: 1fr;
      }

      .search-box {
        flex-direction: column;
      }

      .search-input {
        width: 100%;
      }

      .search-btn, .clear-search-btn {
        width: 100%;
      }

      .source-tags {
        gap: 8px;
      }

      .source-tag {
        font-size: 13px;
        padding: 6px 12px;
      }

      .detail-title {
        font-size: 28px;
      }

      .detail-content {
        padding: 24px;
      }

      .detail-header {
        padding: 20px 24px;
      }

      .detail-footer {
        padding: 20px 24px;
        flex-direction: column;
        gap: 12px;
      }

      .detail-text {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- æ–°é—»æºè¿‡æ»¤å¡ç‰‡ -->
    <div class="source-filter">
      <div class="source-filter-header">
        <div class="source-filter-title">æ–°é—»æ¥æº</div>
      </div>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshNews()">
        <span id="refreshIcon">ğŸ”„</span>
        <span id="refreshText">åˆ·æ–°æ–°é—»</span>
      </button>
      <div class="source-tags" id="sourceTags">
        <div class="source-tag active" onclick="filterBySource(null)">
          <span>å…¨éƒ¨</span>
        </div>
        <!-- åŠ¨æ€åŠ è½½æ–°é—»æº -->
      </div>
    </div>

    <!-- æœç´¢æ¡† -->
    <div class="search-container">
      <div class="search-box">
        <input 
          type="text" 
          id="searchInput" 
          class="search-input" 
          placeholder="æœç´¢æ–°é—»æ ‡é¢˜ã€å†…å®¹ã€æ¥æº..." 
          onkeypress="handleSearchKeyPress(event)"
        >
        <button class="search-btn" onclick="performSearch()">æœç´¢</button>
        <button class="clear-search-btn" id="clearSearchBtn" onclick="clearSearch()" style="display: none;">æ¸…é™¤</button>
      </div>
    </div>

    <!-- æœç´¢ç»“æœæ ‡é¢˜ -->
    <div id="searchResultsHeader" class="search-results-header" style="display: none;">
      <div class="search-results-title">æœç´¢ç»“æœ</div>
      <div class="search-results-count" id="searchResultsCount"></div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <p>åŠ è½½ä¸­...</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <p id="errorMsg"></p>
      <button class="retry-btn" onclick="loadNews()">é‡è¯•</button>
    </div>

    <!-- æ–°é—»åˆ—è¡¨è§†å›¾ -->
    <div id="listView">
      <div id="newsList" class="news-list"></div>
    </div>

    <!-- æ–°é—»è¯¦æƒ…è§†å›¾ -->
    <div id="detailView">
      <div class="detail-container">
        <div class="detail-header">
          <button class="back-btn" onclick="showList()">
            â† è¿”å›åˆ—è¡¨
          </button>
          <h1 id="detailTitle" class="detail-title"></h1>
          <div class="detail-meta">
            <span id="detailSource" class="detail-source"></span>
            <span id="detailDate" class="detail-date"></span>
          </div>
        </div>
        <div id="detailImageContainer"></div>
        <div class="detail-content">
          <div id="detailSummary" class="detail-summary"></div>
          <div id="detailText" class="detail-text"></div>
        </div>
        <div class="detail-footer">
          <a id="sourceLink" href="#" target="_blank" class="source-link">
            æŸ¥çœ‹åŸæ–‡ â†’
          </a>
          <button class="share-btn" onclick="shareNews()">åˆ†äº«</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'https://news-agent-production-c5db.up.railway.app/api';
    let isSearchMode = false;
    let currentKeyword = '';
    let currentSource = null; // å½“å‰é€‰ä¸­çš„æ–°é—»æº
    let sources = []; // æ–°é—»æºåˆ—è¡¨
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return 'ä»Šå¤©';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'æ˜¨å¤©';
      } else {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}æœˆ${day}æ—¥`;
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(dateStr) {
      if (!dateStr) return '';
      // å¤„ç†PostgreSQLè¿”å›çš„æ—¶é—´æ ¼å¼
      // å¯èƒ½æ˜¯Dateå¯¹è±¡ã€ISOå­—ç¬¦ä¸²æˆ–å…¶ä»–æ ¼å¼
      let date;
      if (dateStr instanceof Date) {
        date = dateStr;
      } else if (typeof dateStr === 'string') {
        // PostgreSQLè¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²å¯èƒ½æ˜¯ "2024-01-01 12:00:00" æ ¼å¼
        // æˆ–è€…æ˜¯ISOæ ¼å¼ "2024-01-01T12:00:00.000Z"
        date = new Date(dateStr);
      } else {
        return '';
      }
      
      // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
      if (isNaN(date.getTime())) {
        console.warn('æ— æ•ˆçš„æ—¥æœŸ:', dateStr);
        return '';
      }
      
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // åŠ è½½æ–°é—»æºåˆ—è¡¨
    async function loadSources() {
      try {
        const response = await fetch(`${API_BASE_URL}/news/sources`);
        const result = await response.json();

        if (result.success) {
          sources = result.data;
          renderSourceTags();
        }
      } catch (error) {
        console.error('åŠ è½½æ–°é—»æºå¤±è´¥:', error);
      }
    }

    // æ¸²æŸ“æ–°é—»æºæ ‡ç­¾
    function renderSourceTags() {
      const sourceTagsEl = document.getElementById('sourceTags');
      let html = '<div class="source-tag active" onclick="filterBySource(null)"><span>å…¨éƒ¨</span></div>';
      
      sources.forEach(source => {
        const sourceName = source.source.trim(); // æ˜¾ç¤ºå’ŒæŸ¥è¯¢éƒ½ä½¿ç”¨trimåçš„åç§°
        // åç«¯å·²ä½¿ç”¨TRIMåŒ¹é…ï¼Œæ‰€ä»¥å‰ç«¯ä¼ é€’trimåçš„åç§°å³å¯
        html += `
          <div class="source-tag" data-source="${sourceName.replace(/"/g, '&quot;')}" onclick="filterBySource('${sourceName.replace(/'/g, "\\'")}')">
            <span>${sourceName}</span>
            <span class="source-tag-count">${source.count}</span>
          </div>
        `;
      });
      
      sourceTagsEl.innerHTML = html;
    }

    // æŒ‰æ–°é—»æºè¿‡æ»¤
    async function filterBySource(source) {
      // æ— è®ºå½“å‰åœ¨ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å…ˆå›åˆ°åˆ—è¡¨è§†å›¾
      showList();
      
      currentSource = source;
      isSearchMode = false;
      currentKeyword = '';
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearchBtn').style.display = 'none';
      document.getElementById('searchResultsHeader').style.display = 'none';
      
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (source === null) {
          // ç‚¹å‡»"å…¨éƒ¨"
          if (tag.textContent.includes('å…¨éƒ¨')) {
            tag.classList.add('active');
          }
        } else {
          // ç‚¹å‡»å…·ä½“æ–°é—»æºï¼Œä½¿ç”¨data-sourceå±æ€§åŒ¹é…
          const tagSource = tag.getAttribute('data-source');
          if (tagSource === source) {
            tag.classList.add('active');
          }
        }
      });
      
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';

      try {
        let url;
        if (source) {
          url = `${API_BASE_URL}/news/source/${encodeURIComponent(source)}`;
        } else {
          url = `${API_BASE_URL}/news/list`;
        }
        
        const response = await fetch(url);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'è·å–æ–°é—»å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, false);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // æ¸²æŸ“æ–°é—»åˆ—è¡¨
    function renderNewsList(data, isSearch = false) {
      const newsListEl = document.getElementById('newsList');
      
      if (!data || data.length === 0) {
        if (isSearch) {
          newsListEl.innerHTML = `
            <div class="no-results">
              <div class="no-results-icon">ğŸ”</div>
              <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–°é—»</p>
              <p style="font-size: 14px; margin-top: 8px;">è¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
            </div>
          `;
        } else {
          newsListEl.innerHTML = '<div class="empty"><p>æš‚æ— æ–°é—»</p></div>';
        }
        return;
      }

      // è®¡ç®—æ€»æ–°é—»æ•°
      let totalCount = 0;
      data.forEach(section => {
        totalCount += section.news.length;
      });

      // æ˜¾ç¤ºæœç´¢ç»“æœæ ‡é¢˜
      if (isSearch) {
        document.getElementById('searchResultsHeader').style.display = 'block';
        document.getElementById('searchResultsCount').textContent = `æ‰¾åˆ° ${totalCount} æ¡ç›¸å…³æ–°é—»`;
      } else {
        document.getElementById('searchResultsHeader').style.display = 'none';
      }

      // æ¸²æŸ“æ–°é—»åˆ—è¡¨
      let html = '';
      data.forEach(section => {
        html += `
          <div class="date-section">
            <div class="date-header">
              <div class="date-text">${formatDate(section.date)}</div>
            </div>
            <div class="news-items">
        `;

        section.news.forEach(news => {
          // é«˜äº®æœç´¢å…³é”®è¯
          let title = news.title;
          let summary = news.summary || '';
          if (isSearch && currentKeyword) {
            const regex = new RegExp(`(${currentKeyword})`, 'gi');
            title = title.replace(regex, '<mark>$1</mark>');
            summary = summary.replace(regex, '<mark>$1</mark>');
          }

          html += `
            <div class="news-item" onclick="viewDetail(${news.id})">
              ${news.image_url ? `<img src="${news.image_url}" alt="${news.title}" class="news-image" onerror="this.style.display='none'">` : ''}
              <div class="news-title">${title}</div>
              ${summary ? `<div class="news-summary">${summary}</div>` : ''}
              <div class="news-meta">
                <span class="news-source">${news.source}</span>
                <span class="news-time">${formatTime(news.publish_date)}</span>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      newsListEl.innerHTML = html;
    }

    // åŠ è½½å…¨éƒ¨æ–°é—»
    async function loadNewsAll() {
      const apiUrl = API_BASE_URL;
      
      // æ¸…é™¤æœç´¢çŠ¶æ€
      isSearchMode = false;
      currentKeyword = '';
      currentSource = null;
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearchBtn').style.display = 'none';
      document.getElementById('searchResultsHeader').style.display = 'none';
      
      // é‡ç½®æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.includes('å…¨éƒ¨')) {
          tag.classList.add('active');
        }
      });
      
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';

      try {
        const response = await fetch(`${apiUrl}/news/list`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'è·å–æ–°é—»å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, false);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // åŠ è½½æ–°é—»åˆ—è¡¨ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    async function loadNews() {
      if (currentSource) {
        await filterBySource(currentSource);
      } else {
        await loadNewsAll();
      }
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
      const keyword = document.getElementById('searchInput').value.trim();
      
      if (!keyword) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
      }

      const apiUrl = API_BASE_URL;
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';
      isSearchMode = true;
      currentKeyword = keyword;
      document.getElementById('clearSearchBtn').style.display = 'inline-block';

      try {
        const response = await fetch(`${apiUrl}/news/search?q=${encodeURIComponent(keyword)}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'æœç´¢å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, true);
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearSearchBtn').style.display = 'none';
      isSearchMode = false;
      currentKeyword = '';
      if (currentSource) {
        filterBySource(currentSource);
      } else {
        loadNewsAll();
      }
    }

    // æ‰‹åŠ¨åˆ·æ–°æ–°é—»ï¼ˆè§¦å‘æœåŠ¡å™¨æŠ“å–æœ€æ–°æ–°é—»ï¼‰
    async function refreshNews() {
      const btn = document.getElementById('refreshBtn');
      const icon = document.getElementById('refreshIcon');
      const text = document.getElementById('refreshText');

      btn.disabled = true;
      icon.innerHTML = '<span class="refresh-spinner"></span>';
      text.textContent = 'æ­£åœ¨æŠ“å–...';

      try {
        const res = await fetch(`${API_BASE_URL}/collect`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await res.json();

        if (!result.success) {
          throw new Error(result.message || 'åˆ·æ–°å¤±è´¥');
        }

        text.textContent = 'åˆ·æ–°æˆåŠŸ';

        // å…ˆé‡æ–°åŠ è½½æ–°é—»æºï¼ˆåˆ·æ–°é¡¶éƒ¨æ¥æºå¡ç‰‡ï¼‰
        await loadSources();

        // å†æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶é‡æ–°åŠ è½½æ–°é—»åˆ—è¡¨
        if (currentSource) {
          await filterBySource(currentSource);
        } else {
          await loadNewsAll();
        }
      } catch (err) {
        console.error('åˆ·æ–°å¤±è´¥:', err);
        alert('åˆ·æ–°å¤±è´¥ï¼š' + err.message);
      } finally {
        // æ¢å¤æŒ‰é’®
        icon.textContent = 'ğŸ”„';
        text.textContent = 'åˆ·æ–°æ–°é—»';
        btn.disabled = false;
      }
    }


    // å¤„ç†æœç´¢æ¡†å›è½¦é”®
    function handleSearchKeyPress(event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    }

    // æ˜¾ç¤ºåˆ—è¡¨è§†å›¾
    function showList() {
      document.getElementById('listView').style.display = 'block';
      document.getElementById('detailView').style.display = 'none';
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æ˜¾ç¤ºè¯¦æƒ…è§†å›¾
    function showDetail() {
      document.getElementById('listView').style.display = 'none';
      document.getElementById('detailView').style.display = 'block';
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æŸ¥çœ‹è¯¦æƒ…
    async function viewDetail(id) {
      const apiUrl = API_BASE_URL;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showDetail();
      document.getElementById('detailTitle').textContent = 'åŠ è½½ä¸­...';
      document.getElementById('detailText').textContent = '';
      
      try {
        const response = await fetch(`${apiUrl}/news/${id}`);
        const result = await response.json();

        if (result.success) {
          const news = result.data;
          
          // å¡«å……è¯¦æƒ…é¡µé¢
          document.getElementById('detailTitle').textContent = news.title;
          document.getElementById('detailSource').textContent = news.source || 'æœªçŸ¥æ¥æº';
          document.getElementById('detailDate').textContent = formatFullDate(news.publish_date);
          
          // å›¾ç‰‡
          const imageContainer = document.getElementById('detailImageContainer');
          if (news.image_url) {
            imageContainer.innerHTML = `<img src="${news.image_url}" alt="${news.title}" class="detail-image" onerror="this.style.display='none'">`;
          } else {
            imageContainer.innerHTML = '';
          }
          
          // æ‘˜è¦
          const summaryEl = document.getElementById('detailSummary');
          if (news.summary) {
            summaryEl.textContent = news.summary;
            summaryEl.style.display = 'block';
          } else {
            summaryEl.style.display = 'none';
          }
          
          // æ­£æ–‡å†…å®¹
          const contentEl = document.getElementById('detailText');
          if (news.content) {
            // æ¸…ç†HTMLæ ‡ç­¾å¹¶æ ¼å¼åŒ–
            let content = news.content
              .replace(/<[^>]*>/g, '') // ç§»é™¤HTMLæ ‡ç­¾
              .replace(/&nbsp;/g, ' ') // æ›¿æ¢&nbsp;
              .replace(/&amp;/g, '&')
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&quot;/g, '"')
              .trim();
            
            // æŒ‰æ®µè½åˆ†å‰²ï¼ˆåŒæ¢è¡Œï¼‰
            content = content.split(/\n\s*\n/).map(para => para.trim()).filter(para => para.length > 0);
            contentEl.innerHTML = content.map(para => `<p>${para}</p>`).join('');
          } else {
            contentEl.textContent = 'æš‚æ— è¯¦ç»†å†…å®¹';
          }
          
          // åŸæ–‡é“¾æ¥
          const sourceLink = document.getElementById('sourceLink');
          if (news.url) {
            sourceLink.href = news.url;
            sourceLink.style.display = 'inline-flex';
          } else {
            sourceLink.style.display = 'none';
          }
          
          // ä¿å­˜å½“å‰æ–°é—»IDç”¨äºåˆ†äº«
          window.currentNewsId = id;
          window.currentNews = news;
        } else {
          document.getElementById('detailText').textContent = 'è·å–æ–°é—»è¯¦æƒ…å¤±è´¥ï¼š' + result.message;
        }
      } catch (error) {
        document.getElementById('detailText').textContent = 'è·å–æ–°é—»è¯¦æƒ…å¤±è´¥ï¼š' + error.message;
      }
    }

    // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸ
    function formatFullDate(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}å¹´${month}æœˆ${day}æ—¥ ${hours}:${minutes}`;
    }

    // åˆ†äº«åŠŸèƒ½
    function shareNews() {
      if (navigator.share && window.currentNews) {
        navigator.share({
          title: window.currentNews.title,
          text: window.currentNews.summary || '',
          url: window.currentNews.url || window.location.href
        }).catch(err => console.log('åˆ†äº«å¤±è´¥:', err));
      } else {
        // é™çº§æ–¹æ¡ˆï¼šå¤åˆ¶é“¾æ¥
        const url = window.currentNews?.url || window.location.href;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          });
        } else {
          alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½');
        }
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æ–°é—»å’Œæ–°é—»æº
    window.onload = async function() {
      await loadSources();
      await loadNewsAll();
    };
  </script>
</body>
</html>
