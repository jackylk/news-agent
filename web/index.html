<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§‘æŠ€æ–°é—» - ç½‘é¡µç‰ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .update-info {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .update-info-content {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }

    .update-info-label {
      font-weight: 500;
      color: #999;
    }

    .update-info-time,
    .update-info-count {
      color: #667eea;
      font-weight: 600;
    }

    .update-info-separator {
      color: #ddd;
      margin: 0 4px;
    }

    /* ç”¨æˆ·çŠ¶æ€æ  */
    .user-status-bar,
    .guest-status-bar {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .user-status-content,
    .guest-status-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }

    .user-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .btn-manage,
    .btn-login {
      padding: 8px 16px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .btn-manage:hover,
    .btn-login:hover {
      background-color: #5568d3;
    }

    .btn-logout {
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .btn-logout:hover {
      background-color: #e0e0e0;
    }

    /* æ–°é—»æºè¿‡æ»¤å¡ç‰‡ */
    .source-filter {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .source-filter-header {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .source-filter-title {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }

    .source-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .source-tag {
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .source-tag:hover {
      background-color: #e8e8e8;
      border-color: #667eea;
    }

    .source-tag.active {
      background-color: #667eea;
      color: white;
      border-color: #667eea;
    }

    .source-tag-count {
      font-size: 12px;
      opacity: 0.7;
      background-color: rgba(0, 0, 0, 0.1);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .source-tag.active .source-tag-count {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .loading, .error, .empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .error {
      color: #e74c3c;
    }

    .retry-btn {
      margin-top: 20px;
      padding: 10px 30px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .retry-btn:hover {
      background-color: #5568d3;
    }

    .new-news-notification {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-notification-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .close-notification-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .refresh-spinner {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255, 255, 255, 0.5);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .news-list {
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .date-section {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .date-header {
      padding-bottom: 16px;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 20px;
    }

    .date-text {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .news-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .news-item {
      background: #fafafa;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid #e0e0e0;
    }

    .news-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      border-color: #667eea;
    }

    .news-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .news-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .news-summary {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.5;
    }

    .news-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #999;
      padding-top: 12px;
      border-top: 1px solid #e0e0e0;
    }

    .news-source {
      color: #667eea;
      font-weight: 500;
    }

    /* æœç´¢æ¡†æ ·å¼ */
    .search-container {
      max-width: 1200px;
      margin: 0 auto 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-box {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 12px 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .search-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .search-btn {
      padding: 12px 24px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background-color 0.3s;
    }

    .search-btn:hover {
      background-color: #5568d3;
    }

    .search-btn:active {
      transform: scale(0.98);
    }

    .clear-search-btn {
      padding: 12px 20px;
      background-color: #f5f5f5;
      color: #666;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .clear-search-btn:hover {
      background-color: #e0e0e0;
    }


    .search-results-header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .search-results-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .search-results-count {
      font-size: 14px;
      color: #666;
    }

    .no-results {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .no-results-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    /* è¯¦æƒ…é¡µé¢æ ·å¼ */
    #listView {
      display: block;
    }

    #detailView {
      display: none;
    }

    .detail-container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .detail-header {
      padding: 30px 40px;
      border-bottom: 1px solid #e0e0e0;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      transition: all 0.3s;
      text-decoration: none;
    }

    .back-btn:hover {
      background-color: #e0e0e0;
      transform: translateX(-2px);
    }

    .detail-header-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
    }

    .detail-title {
      font-size: 36px;
      font-weight: bold;
      color: #1a1a1a;
      line-height: 1.4;
      margin: 0;
      flex: 1;
    }

    .translate-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .translate-btn:hover {
      background-color: #5568d3;
    }

    .translate-btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.7;
    }


    .generated-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .generated-summary-header {
      margin-bottom: 20px;
    }

    .generated-summary-header h3 {
      margin: 0;
      font-size: 24px;
      font-weight: 600;
    }
    
    .summary-loading {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.8);
      font-style: italic;
    }

    .generated-summary-content {
      font-size: 16px;
      line-height: 1.8;
      white-space: pre-wrap;
    }

    .detail-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 14px;
      color: #666;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .detail-source {
      color: #667eea;
      font-weight: 600;
    }

    .detail-date {
      color: #999;
    }

    .detail-image {
      width: 100%;
      max-height: 500px;
      object-fit: cover;
      display: block;
    }

    .detail-content {
      padding: 40px;
    }

    .detail-summary {
      font-size: 20px;
      color: #555;
      line-height: 1.8;
      margin-bottom: 30px;
      padding: 20px;
      background-color: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 4px;
    }

    .detail-text {
      font-size: 18px;
      line-height: 1.9;
      color: #333;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .detail-text p {
      margin-bottom: 20px;
    }

    .detail-footer {
      padding: 30px 40px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .source-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background-color: #667eea;
      color: white;
      border-radius: 8px;
      text-decoration: none;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .source-link:hover {
      background-color: #5568d3;
    }

    .share-btn {
      padding: 12px 24px;
      background-color: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .share-btn:hover {
      background-color: #e0e0e0;
    }

    mark {
      background-color: #fff3cd;
      color: #856404;
      padding: 2px 4px;
      border-radius: 3px;
    }

    @media (max-width: 768px) {
      .news-items {
        grid-template-columns: 1fr;
      }

      .search-box {
        flex-direction: column;
      }

      .search-input {
        width: 100%;
      }

      .search-btn, .clear-search-btn {
        width: 100%;
      }

      .source-tags {
        gap: 8px;
      }

      .source-tag {
        font-size: 13px;
        padding: 6px 12px;
      }

      .detail-title {
        font-size: 28px;
      }

      .detail-content {
        padding: 24px;
      }

      .detail-header {
        padding: 20px 24px;
      }

      .detail-footer {
        padding: 20px 24px;
        flex-direction: column;
        gap: 12px;
      }

      .detail-text {
        font-size: 16px;
      }
    }
  </style>
  <script>
    // é¡µé¢åŠ è½½å‰ç«‹å³æ£€æŸ¥è®¤è¯çŠ¶æ€
    (function() {
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        // æ²¡æœ‰ tokenï¼Œç«‹å³è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login.html';
        return;
      }
      
      // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆï¼ˆå¼‚æ­¥ï¼Œä½†ä¸ç­‰å¾…ç»“æœï¼Œå…ˆè·³è½¬ï¼‰
      // å¦‚æœ token æ— æ•ˆï¼Œlogin.html ä¼šå¤„ç†
      const API_BASE_URL = (() => {
        // æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨æœ¬åœ°API
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          return `${window.location.protocol}//${window.location.host}/api`;
        }
        // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ Railway åç«¯åœ°å€
        return 'https://news-agent-production-c5db.up.railway.app/api';
      })();
      
      fetch(`${API_BASE_URL}/auth/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            // token æœ‰æ•ˆï¼Œè·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
            window.location.href = '/dashboard.html';
          } else {
            // token æ— æ•ˆï¼Œæ¸…é™¤å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/login.html';
          }
        })
        .catch(error => {
          // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
          console.error('éªŒè¯ç”¨æˆ·å¤±è´¥:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        });
    })();
  </script>
</head>
<body>
  <div class="container">
    <!-- ç”¨æˆ·çŠ¶æ€æ  -->
    <div id="userStatusBar" class="user-status-bar" style="display: none;">
      <div class="user-status-content">
        <span id="userWelcomeText"></span>
        <div class="user-actions">
          <button class="btn-manage" onclick="showTopicManagement()">ç®¡ç†ä¸»é¢˜</button>
          <button class="btn-manage" onclick="showSubscriptionManagement()">ç®¡ç†è®¢é˜…</button>
          <a href="/dashboard.html#guide" class="btn-manage" style="text-decoration: none; display: inline-block;">ç”¨æˆ·æŒ‡å—</a>
          <a href="/dashboard.html#features" class="btn-manage" style="text-decoration: none; display: inline-block;">ç‰¹æ€§ä»‹ç»</a>
          <button class="btn-logout" onclick="handleLogout()">é€€å‡º</button>
        </div>
      </div>
    </div>
    
    <div id="guestStatusBar" class="guest-status-bar">
      <div class="guest-status-content">
        <span>æ¬¢è¿ä½¿ç”¨ä¸ªäººä¿¡æ¯æ•´ç†ç½‘ç«™</span>
        <a href="/login.html" class="btn-login">ç™»å½•/æ³¨å†Œ</a>
        <span style="margin: 0 8px;">|</span>
        <a href="/dashboard.html" class="btn-login">ç”¨æˆ·ä¸­å¿ƒ</a>
        <span style="margin: 0 8px;">|</span>
        <a href="/dashboard.html#guide" class="btn-login">ç”¨æˆ·æŒ‡å—</a>
        <span style="margin: 0 8px;">|</span>
        <a href="/dashboard.html#features" class="btn-login">ç‰¹æ€§ä»‹ç»</a>
      </div>
    </div>

    <!-- æ›´æ–°ä¿¡æ¯æ˜¾ç¤º -->
    <div class="update-info">
      <div class="update-info-content">
        <span class="update-info-label">æœ€è¿‘æ›´æ–°ï¼š</span>
        <span id="lastUpdateTime" class="update-info-time">åŠ è½½ä¸­...</span>
        <span class="update-info-separator">|</span>
        <span class="update-info-label">æ€»æ–°é—»æ•°ï¼š</span>
        <span id="totalNewsCount" class="update-info-count">åŠ è½½ä¸­...</span>
      </div>
    </div>
    
    <!-- æ–°é—»æºè¿‡æ»¤å¡ç‰‡ -->
    <div class="source-filter">
      <div class="source-filter-header">
        <div class="source-filter-title">æ–°é—»æ¥æº</div>
      </div>
      <div class="source-tags" id="sourceTags">
        <div class="source-tag active" onclick="filterBySource(null)">
          <span>å…¨éƒ¨</span>
        </div>
        <!-- åŠ¨æ€åŠ è½½æ–°é—»æº -->
      </div>
      <div class="category-tags" id="categoryTags" style="margin-top: 12px;">
        <div class="source-tag active" onclick="filterByCategory(null)">
          <span>å…¨éƒ¨åˆ†ç±»</span>
        </div>
        <!-- åŠ¨æ€åŠ è½½åˆ†ç±» -->
      </div>
    </div>
    
    <!-- æ–°æ–°é—»æç¤º -->
    <div id="newNewsNotification" class="new-news-notification" style="display: none;">
      <span id="newNewsText"></span>
      <button class="close-notification-btn" onclick="closeNotification()">Ã—</button>
    </div>

    <!-- æœç´¢ç»“æœæ ‡é¢˜ -->
    <div id="searchResultsHeader" class="search-results-header" style="display: none;">
      <div class="search-results-title">æœç´¢ç»“æœ</div>
      <div class="search-results-count" id="searchResultsCount"></div>
    </div>

    <div id="loading" class="loading" style="display: none;">
      <p>åŠ è½½ä¸­...</p>
    </div>

    <div id="error" class="error" style="display: none;">
      <p id="errorMsg"></p>
      <button class="retry-btn" onclick="loadNews()">é‡è¯•</button>
    </div>

    <!-- æ–°é—»åˆ—è¡¨è§†å›¾ -->
    <div id="listView">
      <div id="newsList" class="news-list"></div>
    </div>

    <!-- æ–°é—»è¯¦æƒ…è§†å›¾ -->
    <div id="detailView">
      <div class="detail-container">
        <div class="detail-header">
          <button class="back-btn" onclick="showList()">
            â† è¿”å›åˆ—è¡¨
          </button>
          <div class="detail-header-content">
            <h1 id="detailTitle" class="detail-title"></h1>
            <button id="translateBtn" class="translate-btn" onclick="toggleTranslate()" style="display: none;">
              <span id="translateIcon">ğŸŒ</span>
              <span id="translateText">ç¿»è¯‘ä¸ºä¸­æ–‡</span>
            </button>
          </div>
          <div class="detail-meta">
            <span id="detailSource" class="detail-source"></span>
            <span id="detailDate" class="detail-date"></span>
          </div>
          <div id="generatedSummary" class="generated-summary" style="display: none;">
            <div class="generated-summary-header">
              <h3>æ–‡ç« æ‘˜è¦</h3>
            </div>
            <div id="generatedSummaryContent" class="generated-summary-content"></div>
          </div>
        </div>
        <div id="detailImageContainer"></div>
        <div class="detail-content">
          <div id="detailSummary" class="detail-summary"></div>
          <div id="detailText" class="detail-text"></div>
        </div>
        <div class="detail-footer">
          <a id="sourceLink" href="#" target="_blank" class="source-link">
            æŸ¥çœ‹åŸæ–‡ â†’
          </a>
          <button class="share-btn" onclick="shareNews()">åˆ†äº«</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¡€åœ°å€ - å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡æˆ–é»˜è®¤å€¼é…ç½®
    const API_BASE_URL = (() => {
      // ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆVercel éƒ¨ç½²æ—¶å¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼‰
      if (typeof window !== 'undefined' && window.API_BASE_URL) {
        return window.API_BASE_URL;
      }
      // æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨å½“å‰åŸŸåå’Œç«¯å£
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return `${window.location.protocol}//${window.location.host}/api`;
      }
      // é»˜è®¤ä½¿ç”¨ Railway åç«¯åœ°å€
      return 'https://news-agent-production-c5db.up.railway.app/api';
    })();
    let isSearchMode = false;
    let currentKeyword = '';
    let currentSource = null; // å½“å‰é€‰ä¸­çš„æ–°é—»æº
    let sources = []; // æ–°é—»æºåˆ—è¡¨
    let savedScrollPosition = 0; // ä¿å­˜è¿›å…¥è¯¦æƒ…é¡µå‰çš„æ»šåŠ¨ä½ç½®
    let currentUser = null; // å½“å‰ç™»å½•ç”¨æˆ·
    let authToken = null; // è®¤è¯token
    
    // æ ¼å¼åŒ–æ—¥æœŸ
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return 'ä»Šå¤©';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return 'æ˜¨å¤©';
      } else {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}æœˆ${day}æ—¥`;
      }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(dateStr) {
      if (!dateStr) return '';
      // å¤„ç†PostgreSQLè¿”å›çš„æ—¶é—´æ ¼å¼
      // å¯èƒ½æ˜¯Dateå¯¹è±¡ã€ISOå­—ç¬¦ä¸²æˆ–å…¶ä»–æ ¼å¼
      let date;
      if (dateStr instanceof Date) {
        date = dateStr;
      } else if (typeof dateStr === 'string') {
        // PostgreSQLè¿”å›çš„æ—¶é—´å­—ç¬¦ä¸²å¯èƒ½æ˜¯ "2024-01-01 12:00:00" æ ¼å¼
        // æˆ–è€…æ˜¯ISOæ ¼å¼ "2024-01-01T12:00:00.000Z"
        date = new Date(dateStr);
      } else {
        return '';
      }
      
      // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
      if (isNaN(date.getTime())) {
        console.warn('æ— æ•ˆçš„æ—¥æœŸ:', dateStr);
        return '';
      }
      
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    // åŠ è½½æ–°é—»æºåˆ—è¡¨
    async function loadSources() {
      try {
        const response = await fetch(`${API_BASE_URL}/news/sources`);
        const result = await response.json();

        if (result.success) {
          sources = result.data;
          renderSourceTags();
        }
      } catch (error) {
        console.error('åŠ è½½æ–°é—»æºå¤±è´¥:', error);
      }
    }

    // æ¸²æŸ“æ–°é—»æºæ ‡ç­¾
    function renderSourceTags() {
      const sourceTagsEl = document.getElementById('sourceTags');
      let html = '<div class="source-tag active" onclick="filterBySource(null)"><span>å…¨éƒ¨</span></div>';
      
      sources.forEach(source => {
        const sourceName = source.source.trim(); // æ˜¾ç¤ºå’ŒæŸ¥è¯¢éƒ½ä½¿ç”¨trimåçš„åç§°
        // åç«¯å·²ä½¿ç”¨TRIMåŒ¹é…ï¼Œæ‰€ä»¥å‰ç«¯ä¼ é€’trimåçš„åç§°å³å¯
        html += `
          <div class="source-tag" data-source="${sourceName.replace(/"/g, '&quot;')}" onclick="filterBySource('${sourceName.replace(/'/g, "\\'")}')">
            <span>${sourceName}</span>
            <span class="source-tag-count">${source.count}</span>
          </div>
        `;
      });
      
      sourceTagsEl.innerHTML = html;
    }

    // åŠ è½½åˆ†ç±»åˆ—è¡¨
    let categories = [];
    async function loadCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/news/categories`);
        const result = await response.json();

        if (result.success) {
          categories = result.data;
          renderCategoryTags();
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
      }
    }

    // æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
    function renderCategoryTags() {
      const categoryTagsEl = document.getElementById('categoryTags');
      let html = '<div class="source-tag active" onclick="filterByCategory(null)"><span>å…¨éƒ¨åˆ†ç±»</span></div>';
      
      categories.forEach(category => {
        const categoryName = category.category || 'æœªåˆ†ç±»';
        html += `
          <div class="source-tag" data-category="${categoryName.replace(/"/g, '&quot;')}" onclick="filterByCategory('${categoryName.replace(/'/g, "\\'")}')">
            <span>${categoryName}</span>
            <span class="source-tag-count">${category.count}</span>
          </div>
        `;
      });
      
      categoryTagsEl.innerHTML = html;
    }

    // æŒ‰åˆ†ç±»è¿‡æ»¤
    let currentCategory = null;
    async function filterByCategory(category) {
      // æ— è®ºå½“å‰åœ¨ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å…ˆå›åˆ°åˆ—è¡¨è§†å›¾
      showList();
      
      // æ›´æ–°åˆ†ç±»æ ‡ç­¾çš„æ¿€æ´»çŠ¶æ€
      document.querySelectorAll('#categoryTags .source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (category === null) {
          // ç‚¹å‡»"å…¨éƒ¨åˆ†ç±»"
          if (tag.textContent.includes('å…¨éƒ¨åˆ†ç±»')) {
            tag.classList.add('active');
          }
        } else {
          // ç‚¹å‡»å…·ä½“åˆ†ç±»
          if (tag.getAttribute('data-category') === category) {
            tag.classList.add('active');
          }
        }
      });
      
      // é‡ç½®æ–°é—»æºæ ‡ç­¾ä¸º"å…¨éƒ¨"
      document.querySelectorAll('#sourceTags .source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.includes('å…¨éƒ¨')) {
          tag.classList.add('active');
        }
      });
      
      // é‡ç½®å½“å‰ç­›é€‰çŠ¶æ€
      currentSource = null;
      currentCategory = category;
      
      // åŠ è½½å¯¹åº”åˆ†ç±»çš„æ–°é—»
      if (category === null) {
        await loadNewsAll();
      } else {
        await loadNewsByCategory(category);
      }
    }

    // æŒ‰åˆ†ç±»åŠ è½½æ–°é—»
    async function loadNewsByCategory(category) {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('listView').style.display = 'block';
      
      try {
        const response = await fetch(`${API_BASE_URL}/news/category/${encodeURIComponent(category)}`);
        const result = await response.json();
        
        document.getElementById('loading').style.display = 'none';
        
        if (result.success) {
          renderNewsList(result.data);
        } else {
          document.getElementById('error').style.display = 'block';
          document.getElementById('errorMsg').textContent = result.message || 'åŠ è½½æ–°é—»å¤±è´¥';
        }
      } catch (error) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('errorMsg').textContent = 'åŠ è½½æ–°é—»å¤±è´¥ï¼š' + error.message;
      }
    }

    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    async function checkUserAuth() {
      authToken = localStorage.getItem('authToken');
      const userInfoStr = localStorage.getItem('userInfo');
      
      if (authToken && userInfoStr) {
        try {
          // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            headers: {
              'Authorization': `Bearer ${authToken}`
            }
          });
          
          const result = await response.json();
          
          if (result.success) {
            currentUser = result.user;
            updateUserUI();
            return true;
          } else {
            // tokenæ— æ•ˆï¼Œæ¸…é™¤
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            authToken = null;
            currentUser = null;
            updateUserUI();
            return false;
          }
        } catch (error) {
          console.error('éªŒè¯ç”¨æˆ·å¤±è´¥:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
          authToken = null;
          currentUser = null;
          updateUserUI();
          return false;
        }
      } else {
        currentUser = null;
        authToken = null;
        updateUserUI();
        return false;
      }
    }

    // æ›´æ–°ç”¨æˆ·UI
    function updateUserUI() {
      const userStatusBar = document.getElementById('userStatusBar');
      const guestStatusBar = document.getElementById('guestStatusBar');
      
      if (currentUser) {
        if (userStatusBar) userStatusBar.style.display = 'block';
        if (guestStatusBar) guestStatusBar.style.display = 'none';
        const welcomeText = document.getElementById('userWelcomeText');
        if (welcomeText) welcomeText.textContent = `æ¬¢è¿ï¼Œ${currentUser.username}`;
      } else {
        if (userStatusBar) userStatusBar.style.display = 'none';
        if (guestStatusBar) guestStatusBar.style.display = 'block';
      }
    }

    // é€€å‡ºç™»å½•
    function handleLogout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        currentUser = null;
        authToken = null;
        updateUserUI();
        // é‡æ–°åŠ è½½æ–°é—»ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ–°é—»ï¼‰
        loadNewsAll();
      }
    }

    // æ˜¾ç¤ºä¸»é¢˜ç®¡ç†
    function showTopicManagement() {
      window.location.href = '/topics.html';
    }

    // æ˜¾ç¤ºè®¢é˜…ç®¡ç†
    function showSubscriptionManagement() {
      window.location.href = '/subscriptions.html';
    }

    // è·å–è¯·æ±‚å¤´ï¼ˆåŒ…å«è®¤è¯ä¿¡æ¯ï¼‰
    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json'
      };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      return headers;
    }

    // æŒ‰æ–°é—»æºè¿‡æ»¤
    async function filterBySource(source) {
      // æ— è®ºå½“å‰åœ¨ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å…ˆå›åˆ°åˆ—è¡¨è§†å›¾
      showList();
      
      currentSource = source;
      isSearchMode = false;
      currentKeyword = '';
      
      // éšè—æœç´¢ç»“æœæ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const searchResultsHeader = document.getElementById('searchResultsHeader');
      if (searchResultsHeader) {
        searchResultsHeader.style.display = 'none';
      }
      
      // æ›´æ–°æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (source === null) {
          // ç‚¹å‡»"å…¨éƒ¨"
          if (tag.textContent.includes('å…¨éƒ¨')) {
            tag.classList.add('active');
          }
        } else {
          // ç‚¹å‡»å…·ä½“æ–°é—»æºï¼Œä½¿ç”¨data-sourceå±æ€§åŒ¹é…
          const tagSource = tag.getAttribute('data-source');
          if (tagSource === source) {
            tag.classList.add('active');
          }
        }
      });
      
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';

      try {
        let url;
        if (source) {
          url = `${API_BASE_URL}/news/source/${encodeURIComponent(source)}`;
        } else {
          url = `${API_BASE_URL}/news/list`;
        }
        
        const response = await fetch(url);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'è·å–æ–°é—»å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, false);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // æ¸²æŸ“æ–°é—»åˆ—è¡¨
    function renderNewsList(data, isSearch = false) {
      const newsListEl = document.getElementById('newsList');
      
      if (!data || data.length === 0) {
        if (isSearch) {
          newsListEl.innerHTML = `
            <div class="no-results">
              <div class="no-results-icon">ğŸ”</div>
              <p>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–°é—»</p>
              <p style="font-size: 14px; margin-top: 8px;">è¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
            </div>
          `;
        } else {
          newsListEl.innerHTML = '<div class="empty"><p>æš‚æ— æ–°é—»</p></div>';
        }
        return;
      }

      // è®¡ç®—æ€»æ–°é—»æ•°
      let totalCount = 0;
      data.forEach(section => {
        totalCount += section.news.length;
      });

      // æ˜¾ç¤ºæœç´¢ç»“æœæ ‡é¢˜
      if (isSearch) {
        document.getElementById('searchResultsHeader').style.display = 'block';
        document.getElementById('searchResultsCount').textContent = `æ‰¾åˆ° ${totalCount} æ¡ç›¸å…³æ–°é—»`;
      } else {
        document.getElementById('searchResultsHeader').style.display = 'none';
      }

      // æ¸²æŸ“æ–°é—»åˆ—è¡¨
      let html = '';
      data.forEach(section => {
        html += `
          <div class="date-section">
            <div class="date-header">
              <div class="date-text">${formatDate(section.date)}</div>
            </div>
            <div class="news-items">
        `;

        section.news.forEach(news => {
          // é«˜äº®æœç´¢å…³é”®è¯
          let title = news.title;
          let summary = news.summary || '';
          if (isSearch && currentKeyword) {
            const regex = new RegExp(`(${currentKeyword})`, 'gi');
            title = title.replace(regex, '<mark>$1</mark>');
            summary = summary.replace(regex, '<mark>$1</mark>');
          }

          html += `
            <div class="news-item" onclick="viewDetail(${news.id})">
              ${news.image_url ? `<img src="${news.image_url}" alt="${news.title}" class="news-image" onerror="this.style.display='none'">` : ''}
              <div class="news-title">${title}</div>
              ${summary ? `<div class="news-summary">${summary}</div>` : ''}
              <div class="news-meta">
                <span class="news-source">${news.source}</span>
                <span class="news-time">${formatTime(news.publish_date)}</span>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      newsListEl.innerHTML = html;
    }

    // åŠ è½½å…¨éƒ¨æ–°é—»
    async function loadNewsAll() {
      const apiUrl = API_BASE_URL;
      
      // æ¸…é™¤æœç´¢çŠ¶æ€
      isSearchMode = false;
      currentKeyword = '';
      currentSource = null;
      
      // éšè—æœç´¢ç»“æœæ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const searchResultsHeader = document.getElementById('searchResultsHeader');
      if (searchResultsHeader) {
        searchResultsHeader.style.display = 'none';
      }
      
      // é‡ç½®æ ‡ç­¾çŠ¶æ€
      document.querySelectorAll('.source-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.textContent.includes('å…¨éƒ¨')) {
          tag.classList.add('active');
        }
      });
      
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';

      try {
        const response = await fetch(`${apiUrl}/news/list`, {
          headers: getHeaders()
        });
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'è·å–æ–°é—»å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, false);
      } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // åŠ è½½æ–°é—»åˆ—è¡¨ï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
    async function loadNews() {
      if (currentSource) {
        await filterBySource(currentSource);
      } else {
        await loadNewsAll();
      }
    }

    // æ‰§è¡Œæœç´¢ï¼ˆå·²ç§»é™¤æœç´¢åŠŸèƒ½ï¼Œä¿ç•™å‡½æ•°ä»¥é˜²å¼•ç”¨ï¼‰
    async function performSearch() {
      // æœç´¢åŠŸèƒ½å·²ç§»é™¤
      return;
      
      if (!keyword) {
        alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
      }

      const apiUrl = API_BASE_URL;
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const newsListEl = document.getElementById('newsList');
      
      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      newsListEl.innerHTML = '';
      isSearchMode = true;
      currentKeyword = keyword;
      document.getElementById('clearSearchBtn').style.display = 'inline-block';

      try {
        const response = await fetch(`${apiUrl}/news/search?q=${encodeURIComponent(keyword)}`);
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.message || 'æœç´¢å¤±è´¥');
        }

        const data = result.data;
        loadingEl.style.display = 'none';
        renderNewsList(data, true);
      } catch (error) {
        console.error('æœç´¢å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        document.getElementById('errorMsg').textContent = error.message || 'æœç´¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ';
      }
    }

    // æ¸…é™¤æœç´¢ï¼ˆå·²ç§»é™¤æœç´¢åŠŸèƒ½ï¼Œä¿ç•™å‡½æ•°ä»¥é˜²å¼•ç”¨ï¼‰
    function clearSearch() {
      // æœç´¢åŠŸèƒ½å·²ç§»é™¤
      return;
    }

    // åŠ è½½æ›´æ–°ä¿¡æ¯
    async function loadUpdateInfo() {
      try {
        const response = await fetch(`${API_BASE_URL}/news/update-info`);
        const result = await response.json();
        
        if (result.success && result.data) {
          const { lastUpdateTime, totalCount } = result.data;
          
          // æ›´æ–°æ€»æ–°é—»æ•°
          document.getElementById('totalNewsCount').textContent = totalCount + ' æ¡';
          
          // æ›´æ–°æœ€è¿‘æ›´æ–°æ—¶é—´
          if (lastUpdateTime) {
            const updateTime = new Date(lastUpdateTime);
            const now = new Date();
            const diffMs = now - updateTime;
            const diffMins = Math.floor(diffMs / 60000);
            
            let timeText = '';
            if (diffMins < 1) {
              timeText = 'åˆšåˆš';
            } else if (diffMins < 60) {
              timeText = `${diffMins}åˆ†é’Ÿå‰`;
            } else {
              const hours = Math.floor(diffMins / 60);
              if (hours < 24) {
                timeText = `${hours}å°æ—¶å‰`;
              } else {
                const days = Math.floor(hours / 24);
                timeText = `${days}å¤©å‰`;
              }
            }
            
            document.getElementById('lastUpdateTime').textContent = timeText;
          }
        }
      } catch (error) {
        console.error('åŠ è½½æ›´æ–°ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    // æ£€æŸ¥æ–°æ–°é—»
    let lastCheckTime = Date.now();
    let notificationShown = false;
    let lastTotalCount = 0;
    
    async function checkNewNews() {
      try {
        // å…ˆè·å–æ›´æ–°ä¿¡æ¯
        const updateResponse = await fetch(`${API_BASE_URL}/news/update-info`);
        const updateResult = await updateResponse.json();
        
        if (updateResult.success && updateResult.data) {
          const { totalCount } = updateResult.data;
          
          // å¦‚æœæ€»æ•°å¢åŠ äº†ï¼Œè¯´æ˜æœ‰æ–°æ–°é—»
          if (lastTotalCount > 0 && totalCount > lastTotalCount) {
            const newCount = totalCount - lastTotalCount;
            const minutesSinceLastCheck = Math.floor((Date.now() - lastCheckTime) / 60000);
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showNewNewsNotification(newCount, minutesSinceLastCheck);
            
            // æ›´æ–°æ–°é—»åˆ—è¡¨å’Œæ–°é—»æº
            await loadSources();
            await loadCategories();
            if (currentSource) {
              await filterBySource(currentSource);
            } else {
              await loadNewsAll();
            }
          }
          
          lastTotalCount = totalCount;
          await loadUpdateInfo(); // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
        }
        
        lastCheckTime = Date.now();
      } catch (error) {
        console.error('æ£€æŸ¥æ–°æ–°é—»å¤±è´¥:', error);
      }
    }
    
    // æ˜¾ç¤ºæ–°æ–°é—»æç¤º
    function showNewNewsNotification(count, minutes) {
      const notification = document.getElementById('newNewsNotification');
      const text = document.getElementById('newNewsText');
      
      let timeText = '';
      if (minutes < 60) {
        timeText = `è¿‡å»${minutes}åˆ†é’Ÿ`;
      } else {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        if (mins === 0) {
          timeText = `è¿‡å»${hours}å°æ—¶`;
        } else {
          timeText = `è¿‡å»${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
        }
      }
      
      text.textContent = `ğŸ“° ${timeText}å‡ºç°äº†${count}æ¡æ–°æ–°é—»`;
      notification.style.display = 'flex';
      notificationShown = true;
      
      // 5ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        if (notificationShown) {
          closeNotification();
        }
      }, 5000);
    }
    
    // å…³é—­æç¤º
    function closeNotification() {
      const notification = document.getElementById('newNewsNotification');
      notification.style.display = 'none';
      notificationShown = false;
    }
    
    // å¯åŠ¨å®šæœŸæ£€æŸ¥ï¼ˆæ¯2åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ï¼‰
    setInterval(checkNewNews, 2 * 60 * 1000);


    // å¤„ç†æœç´¢æ¡†å›è½¦é”®
    function handleSearchKeyPress(event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    }

    // æ˜¾ç¤ºåˆ—è¡¨è§†å›¾
    function showList() {
      document.getElementById('listView').style.display = 'block';
      document.getElementById('detailView').style.display = 'none';
      // æ¢å¤åˆ°è¿›å…¥è¯¦æƒ…é¡µå‰çš„æ»šåŠ¨ä½ç½®
      setTimeout(() => {
        window.scrollTo({ top: savedScrollPosition, behavior: 'smooth' });
      }, 100);
    }

    // æ˜¾ç¤ºè¯¦æƒ…è§†å›¾
    function showDetail() {
      document.getElementById('listView').style.display = 'none';
      document.getElementById('detailView').style.display = 'block';
      // æ»šåŠ¨åˆ°é¡¶éƒ¨
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // æŸ¥çœ‹è¯¦æƒ…
    async function viewDetail(id) {
      const apiUrl = API_BASE_URL;
      
      // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
      savedScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      showDetail();
      document.getElementById('detailTitle').textContent = 'åŠ è½½ä¸­...';
      document.getElementById('detailText').textContent = '';
      
      // æ¸…é™¤ä¹‹å‰çš„æ‘˜è¦
      const generatedSummaryEl = document.getElementById('generatedSummary');
      generatedSummaryEl.style.display = 'none';
      document.getElementById('generatedSummaryContent').textContent = '';
      isGeneratingSummary = false; // é‡ç½®ç”ŸæˆçŠ¶æ€
      
      try {
        const response = await fetch(`${apiUrl}/news/${id}`);
        const result = await response.json();

        if (result.success) {
          const news = result.data;
          
          // å¡«å……è¯¦æƒ…é¡µé¢
          const titleEl = document.getElementById('detailTitle');
          titleEl.textContent = news.title;
          titleEl.setAttribute('data-original', news.title); // ä¿å­˜åŸå§‹æ ‡é¢˜
          document.getElementById('detailSource').textContent = news.source || 'æœªçŸ¥æ¥æº';
          document.getElementById('detailDate').textContent = formatFullDate(news.publish_date);
          
          // å›¾ç‰‡
          const imageContainer = document.getElementById('detailImageContainer');
          if (news.image_url) {
            imageContainer.innerHTML = `<img src="${news.image_url}" alt="${news.title}" class="detail-image" onerror="this.style.display='none'">`;
          } else {
            imageContainer.innerHTML = '';
          }
          
          // æ£€æµ‹è¯­è¨€å¹¶æ˜¾ç¤ºç¿»è¯‘æŒ‰é’®
          const textToCheck = (news.title + ' ' + (news.summary || '') + ' ' + (news.content || '')).substring(0, 500);
          const isEnglish = detectLanguage(textToCheck);
          const translateBtn = document.getElementById('translateBtn');
          if (isEnglish) {
            translateBtn.style.display = 'inline-flex';
            translateBtn.setAttribute('data-translated', 'false');
            document.getElementById('translateText').textContent = 'ç¿»è¯‘ä¸ºä¸­æ–‡';
            window.isTranslated = false;
          } else {
            translateBtn.style.display = 'none';
          }
          
          // æ‘˜è¦
          const summaryEl = document.getElementById('detailSummary');
          let originalSummary = '';
          if (news.summary) {
            originalSummary = news.summary;
            summaryEl.textContent = news.summary;
            summaryEl.style.display = 'block';
            summaryEl.setAttribute('data-original', originalSummary);
          } else {
            summaryEl.style.display = 'none';
          }
          
          // æ­£æ–‡å†…å®¹
          const contentEl = document.getElementById('detailText');
          let originalContent = '';
          if (news.content) {
            // æ¸…ç†HTMLæ ‡ç­¾å¹¶æ ¼å¼åŒ–
            let content = news.content
              .replace(/<[^>]*>/g, '') // ç§»é™¤HTMLæ ‡ç­¾
              .replace(/&nbsp;/g, ' ') // æ›¿æ¢&nbsp;
              .replace(/&amp;/g, '&')
              .replace(/&lt;/g, '<')
              .replace(/&gt;/g, '>')
              .replace(/&quot;/g, '"')
              .trim();
            
            originalContent = content;
            contentEl.setAttribute('data-original', originalContent);
            
            // æŒ‰æ®µè½åˆ†å‰²ï¼ˆåŒæ¢è¡Œï¼‰
            content = content.split(/\n\s*\n/).map(para => para.trim()).filter(para => para.length > 0);
            contentEl.innerHTML = content.map(para => `<p>${para}</p>`).join('');
            
            // æ£€æµ‹æ–‡ç« é•¿åº¦ï¼Œå¦‚æœè¶…è¿‡500å­—ï¼Œè‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
            const contentLength = originalContent.length;
            if (contentLength > 500) {
              // è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦
              autoGenerateSummary(originalContent);
            }
          } else {
            contentEl.textContent = 'æš‚æ— è¯¦ç»†å†…å®¹';
          }
          
          // åŸæ–‡é“¾æ¥
          const sourceLink = document.getElementById('sourceLink');
          if (news.url) {
            sourceLink.href = news.url;
            sourceLink.style.display = 'inline-flex';
          } else {
            sourceLink.style.display = 'none';
          }
          
          // ä¿å­˜å½“å‰æ–°é—»IDç”¨äºåˆ†äº«
          window.currentNewsId = id;
          window.currentNews = news;
        } else {
          document.getElementById('detailText').textContent = 'è·å–æ–°é—»è¯¦æƒ…å¤±è´¥ï¼š' + result.message;
        }
      } catch (error) {
        document.getElementById('detailText').textContent = 'è·å–æ–°é—»è¯¦æƒ…å¤±è´¥ï¼š' + error.message;
      }
    }

    // æ ¼å¼åŒ–å®Œæ•´æ—¥æœŸï¼ˆæ–‡ç« è¯¦æƒ…é¡µé¢ä½¿ç”¨ï¼Œåªæ˜¾ç¤ºæ—¥æœŸï¼‰
    function formatFullDate(dateStr) {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    // æ£€æµ‹è¯­è¨€ï¼ˆç®€å•æ£€æµ‹ï¼šå¦‚æœä¸»è¦æ˜¯è‹±æ–‡å­—ç¬¦ï¼Œè¿”å›trueï¼‰
    function detectLanguage(text) {
      if (!text || text.length === 0) return false;
      
      // è®¡ç®—è‹±æ–‡å­—ç¬¦çš„æ¯”ä¾‹
      const englishChars = text.match(/[a-zA-Z]/g) || [];
      const totalChars = text.match(/[a-zA-Z\u4e00-\u9fa5]/g) || [];
      
      if (totalChars.length === 0) return false;
      
      // å¦‚æœè‹±æ–‡å­—ç¬¦å æ¯”è¶…è¿‡60%ï¼Œè®¤ä¸ºæ˜¯è‹±æ–‡
      const englishRatio = englishChars.length / totalChars.length;
      return englishRatio > 0.6;
    }

    // ç¿»è¯‘åŠŸèƒ½
    let isTranslating = false;
    window.isTranslated = false;
    
    async function toggleTranslate() {
      const translateBtn = document.getElementById('translateBtn');
      const translateText = document.getElementById('translateText');
      const titleEl = document.getElementById('detailTitle');
      const contentEl = document.getElementById('detailText');
      const summaryEl = document.getElementById('detailSummary');
      
      if (isTranslating) return;
      
      if (window.isTranslated) {
        // æ¢å¤åŸæ–‡
        const originalTitle = titleEl.getAttribute('data-original') || '';
        const originalContent = contentEl.getAttribute('data-original') || '';
        const originalSummary = summaryEl.getAttribute('data-original') || '';
        
        if (originalTitle) {
          titleEl.textContent = originalTitle;
        }
        
        if (originalContent) {
          const paragraphs = originalContent.split(/\n\s*\n/).map(para => para.trim()).filter(para => para.length > 0);
          contentEl.innerHTML = paragraphs.map(para => `<p>${para}</p>`).join('');
        }
        
        if (originalSummary) {
          summaryEl.textContent = originalSummary;
        }
        
        translateText.textContent = 'ç¿»è¯‘ä¸ºä¸­æ–‡';
        translateBtn.setAttribute('data-translated', 'false');
        window.isTranslated = false;
      } else {
        // ç¿»è¯‘ä¸ºä¸­æ–‡
        translateBtn.disabled = true;
        translateText.textContent = 'ç¿»è¯‘ä¸­...';
        isTranslating = true;
        
        try {
          const titleToTranslate = titleEl.textContent || '';
          const textToTranslate = contentEl.textContent || '';
          const summaryToTranslate = summaryEl.textContent || '';
          
          // ä½¿ç”¨å…è´¹çš„ç¿»è¯‘API
          const translatedTitle = titleToTranslate ? await translateTextAPI(titleToTranslate) : '';
          const translatedText = textToTranslate ? await translateTextAPI(textToTranslate) : '';
          const translatedSummary = summaryToTranslate ? await translateTextAPI(summaryToTranslate) : '';
          
          if (translatedTitle) {
            titleEl.textContent = translatedTitle;
          }
          
          if (translatedText) {
            const paragraphs = translatedText.split(/\n\s*\n/).map(para => para.trim()).filter(para => para.length > 0);
            if (paragraphs.length > 0) {
              contentEl.innerHTML = paragraphs.map(para => `<p>${para}</p>`).join('');
            }
          }
          
          if (translatedSummary) {
            summaryEl.textContent = translatedSummary;
          }
          
          translateText.textContent = 'æ˜¾ç¤ºåŸæ–‡';
          translateBtn.setAttribute('data-translated', 'true');
          window.isTranslated = true;
        } catch (error) {
          console.error('ç¿»è¯‘å¤±è´¥:', error);
          alert('ç¿»è¯‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
          translateText.textContent = 'ç¿»è¯‘ä¸ºä¸­æ–‡';
        } finally {
          translateBtn.disabled = false;
          isTranslating = false;
        }
      }
    }

    // è°ƒç”¨ç¿»è¯‘API
    async function translateTextAPI(text) {
      if (!text || text.trim().length === 0) return '';
      
      // ä½¿ç”¨ LibreTranslate çš„å…¬å…±APIï¼ˆå…è´¹ï¼Œæ— éœ€API keyï¼‰
      try {
        const response = await fetch('https://libretranslate.de/translate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            q: text.substring(0, 5000), // é™åˆ¶é•¿åº¦
            source: 'en',
            target: 'zh',
            format: 'text'
          })
        });
        
        if (!response.ok) {
          throw new Error('ç¿»è¯‘æœåŠ¡ä¸å¯ç”¨');
        }
        
        const result = await response.json();
        return result.translatedText || text;
      } catch (error) {
        // å¦‚æœ LibreTranslate ä¸å¯ç”¨ï¼Œå°è¯•ä½¿ç”¨ MyMemory API
        try {
          const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.substring(0, 500))}&langpair=en|zh`);
          const result = await response.json();
          
          if (result.responseStatus === 200 && result.responseData) {
            return result.responseData.translatedText || text;
          }
          throw new Error('ç¿»è¯‘å¤±è´¥');
        } catch (error2) {
          console.error('ç¿»è¯‘APIé”™è¯¯:', error2);
          throw error2;
        }
      }
    }

    // åˆ†äº«åŠŸèƒ½
    function shareNews() {
      if (navigator.share && window.currentNews) {
        navigator.share({
          title: window.currentNews.title,
          text: window.currentNews.summary || '',
          url: window.currentNews.url || window.location.href
        }).catch(err => console.log('åˆ†äº«å¤±è´¥:', err));
      } else {
        // é™çº§æ–¹æ¡ˆï¼šå¤åˆ¶é“¾æ¥
        const url = window.currentNews?.url || window.location.href;
        if (navigator.clipboard) {
          navigator.clipboard.writeText(url).then(() => {
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
          });
        } else {
          alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåˆ†äº«åŠŸèƒ½');
        }
      }
    }

    // è‡ªåŠ¨ç”Ÿæˆæ‘˜è¦åŠŸèƒ½
    let isGeneratingSummary = false;
    
    async function autoGenerateSummary(text) {
      if (isGeneratingSummary) return;
      
      const generatedSummaryEl = document.getElementById('generatedSummary');
      const generatedSummaryContent = document.getElementById('generatedSummaryContent');
      
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      generatedSummaryEl.style.display = 'block';
      generatedSummaryContent.innerHTML = '<div class="summary-loading">æ­£åœ¨ç”Ÿæˆæ‘˜è¦...</div>';
      isGeneratingSummary = true;
      
      try {
        if (!text || text.trim().length === 0) {
          throw new Error('æ²¡æœ‰å¯ç”¨çš„å†…å®¹');
        }
        
        // è°ƒç”¨æ‘˜è¦ç”ŸæˆAPI
        const summary = await generateSummaryAPI(text);
        
        if (summary) {
          generatedSummaryContent.textContent = summary;
        } else {
          throw new Error('ç”Ÿæˆæ‘˜è¦å¤±è´¥');
        }
      } catch (error) {
        console.error('ç”Ÿæˆæ‘˜è¦å¤±è´¥:', error);
        // å¦‚æœç”Ÿæˆå¤±è´¥ï¼Œéšè—æ‘˜è¦åŒºåŸŸ
        generatedSummaryEl.style.display = 'none';
      } finally {
        isGeneratingSummary = false;
      }
    }

    // è°ƒç”¨æ‘˜è¦ç”ŸæˆAPIï¼ˆä½¿ç”¨å¤§æ¨¡å‹æœåŠ¡ï¼‰
    async function generateSummaryAPI(text) {
      if (!text || text.trim().length === 0) return '';
      
      // é™åˆ¶æ–‡æœ¬é•¿åº¦ï¼ˆé¿å…APIé™åˆ¶ï¼‰
      const textToSummarize = text.substring(0, 4000);
      
      try {
        // ä¼˜å…ˆä½¿ç”¨åç«¯APIï¼ˆå¦‚æœé…ç½®äº†ï¼‰
        const backendAPI = API_BASE_URL + '/news/summarize';
        try {
          const response = await fetch(backendAPI, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              text: textToSummarize
            })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.success && result.summary) {
              return result.summary;
            }
          }
        } catch (backendError) {
          console.log('åç«¯APIä¸å¯ç”¨ï¼Œä½¿ç”¨å‰ç«¯AIæœåŠ¡:', backendError);
        }
        
        // ä½¿ç”¨å…è´¹çš„AIæ‘˜è¦æœåŠ¡ï¼ˆHugging Face Inference APIï¼‰
        return await generateAISummary(textToSummarize);
      } catch (error) {
        console.error('ç”Ÿæˆæ‘˜è¦é”™è¯¯:', error);
        // å¦‚æœAIæœåŠ¡å¤±è´¥ï¼Œä½¿ç”¨ç®€å•çš„æå–å¼æ‘˜è¦ä½œä¸ºå¤‡é€‰
        return generateSimpleSummary(textToSummarize);
      }
    }

    // ä½¿ç”¨AIæœåŠ¡ç”Ÿæˆæ‘˜è¦
    async function generateAISummary(text) {
      // æ–¹æ¡ˆ1: ä½¿ç”¨ Hugging Face Inference APIï¼ˆå…è´¹ï¼Œä½†éœ€è¦tokenï¼‰
      // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨å…¬å¼€æ¨¡å‹ï¼Œå¯èƒ½éœ€è¦é…ç½®token
      try {
        // ä½¿ç”¨ facebook/bart-large-cnn æ¨¡å‹ï¼ˆä¸“é—¨ç”¨äºæ‘˜è¦ï¼‰
        const response = await fetch('https://api-inference.huggingface.co/models/facebook/bart-large-cnn', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // å¦‚æœéœ€è¦tokenï¼Œå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶æ·»åŠ ä½ çš„token
            // 'Authorization': 'Bearer YOUR_HUGGINGFACE_TOKEN'
          },
          body: JSON.stringify({
            inputs: text,
            parameters: {
              max_length: 150,  // æœ€å¤§é•¿åº¦
              min_length: 50,   // æœ€å°é•¿åº¦
              do_sample: false
            }
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result[0] && result[0].summary_text) {
            return result[0].summary_text;
          }
        } else if (response.status === 503) {
          // æ¨¡å‹æ­£åœ¨åŠ è½½ï¼Œç­‰å¾…åé‡è¯•
          await new Promise(resolve => setTimeout(resolve, 5000));
          return await generateAISummary(text);
        }
      } catch (error) {
        console.warn('Hugging Face APIé”™è¯¯:', error);
      }
      
      // æ–¹æ¡ˆ2: ä½¿ç”¨ OpenAI å…¼å®¹çš„å…è´¹APIï¼ˆå¦‚ Groqã€Together AI ç­‰ï¼‰
      // æ³¨æ„ï¼šè¿™äº›æœåŠ¡å¯èƒ½éœ€è¦API keyï¼Œå»ºè®®åœ¨åç«¯å®ç°
      
      // æ–¹æ¡ˆ3: ä½¿ç”¨ç®€å•çš„æå–å¼æ‘˜è¦ä½œä¸ºå¤‡é€‰
      return generateSimpleSummary(text);
    }

    // ç®€å•çš„æå–å¼æ‘˜è¦ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
    function generateSimpleSummary(text) {
      // æŒ‰æ®µè½åˆ†å‰²
      const paragraphs = text.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
      
      if (paragraphs.length === 0) return '';
      
      // å¦‚æœåªæœ‰ä¸€æ®µï¼Œæå–å‰å‡ å¥
      if (paragraphs.length === 1) {
        const sentences = paragraphs[0].split(/[.!?ã€‚ï¼ï¼Ÿ]\s+/).filter(s => s.trim().length > 20);
        const summaryLength = Math.min(3, Math.ceil(sentences.length * 0.3));
        return sentences.slice(0, summaryLength).join('ã€‚') + 'ã€‚';
      }
      
      // å¦‚æœæœ‰å¤šæ®µï¼Œæå–å‰ä¸¤æ®µ
      const summaryParagraphs = paragraphs.slice(0, Math.min(2, paragraphs.length));
      return summaryParagraphs.join('\n\n');
    }

    // æ£€æŸ¥è®¤è¯çŠ¶æ€å¹¶å†³å®šè·³è½¬
    async function checkAuthAndRedirect() {
      const token = localStorage.getItem('authToken');
      
      if (!token) {
        // æ²¡æœ‰ tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = '/login.html';
        return false;
      }
      
      // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
      try {
        const response = await fetch(`${API_BASE_URL}/auth/me`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        const result = await response.json();
        
        if (result.success) {
          // token æœ‰æ•ˆï¼Œè·³è½¬åˆ°ç”¨æˆ·ä¸­å¿ƒ
          window.location.href = '/dashboard.html';
          return true;
        } else {
          // token æ— æ•ˆï¼Œæ¸…é™¤å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
          return false;
        }
      } catch (error) {
        // éªŒè¯å¤±è´¥ï¼Œæ¸…é™¤å¹¶è·³è½¬åˆ°ç™»å½•é¡µ
        console.error('éªŒè¯ç”¨æˆ·å¤±è´¥:', error);
        localStorage.removeItem('authToken');
        localStorage.removeItem('userInfo');
        window.location.href = '/login.html';
        return false;
      }
    }

    // é¡µé¢åŠ è½½æ—¶å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€
    window.onload = async function() {
      // å…ˆæ£€æŸ¥è®¤è¯çŠ¶æ€ï¼Œå¦‚æœæœ‰æœ‰æ•ˆ token ä¼šè·³è½¬åˆ° dashboard
      const isAuthenticated = await checkAuthAndRedirect();
      
      // å¦‚æœæ²¡æœ‰è®¤è¯ï¼ˆä¼šè·³è½¬åˆ° loginï¼‰ï¼Œä¸‹é¢çš„ä»£ç ä¸ä¼šæ‰§è¡Œ
      // å¦‚æœè®¤è¯äº†ï¼ˆä¼šè·³è½¬åˆ° dashboardï¼‰ï¼Œä¸‹é¢çš„ä»£ç ä¹Ÿä¸ä¼šæ‰§è¡Œ
      // ä½†ä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ£€æŸ¥ä¸€ä¸‹
      if (!isAuthenticated) {
        return; // å·²è·³è½¬åˆ°ç™»å½•é¡µï¼Œåœæ­¢æ‰§è¡Œ
      }
      
      // å¦‚æœç”¨æˆ·ä»ç„¶åœ¨è¿™ä¸ªé¡µé¢ï¼ˆç†è®ºä¸Šä¸åº”è¯¥ï¼‰ï¼Œç»§ç»­åŠ è½½å†…å®¹
      await loadUpdateInfo(); // å…ˆåŠ è½½æ›´æ–°ä¿¡æ¯
      await loadSources();
      await loadCategories();
      await loadNewsAll();
      
      // è·å–åˆå§‹æ€»æ•°
      try {
        const response = await fetch(`${API_BASE_URL}/news/update-info`);
        const result = await response.json();
        if (result.success && result.data) {
          lastTotalCount = result.data.totalCount || 0;
        }
      } catch (error) {
        console.error('è·å–åˆå§‹æ€»æ•°å¤±è´¥:', error);
      }
      
      // åˆå§‹åŒ–æ–°æ–°é—»æ£€æŸ¥ï¼ˆå»¶è¿Ÿ30ç§’åå¼€å§‹ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼‰
      setTimeout(() => {
        checkNewNews();
      }, 30 * 1000);
    };
  </script>
</body>
</html>
