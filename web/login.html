<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»å½• - ä¸ªäººä¿¡æ¯æ•´ç†ç½‘ç«™</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 420px;
      padding: 40px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: #666;
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 2px solid #eee;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .auth-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group input::placeholder {
      color: #999;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.error {
      background-color: #fee;
      color: #c33;
      border: 1px solid #fcc;
    }

    .message.success {
      background-color: #efe;
      color: #3c3;
      border: 1px solid #cfc;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .link-to-main {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #eee;
    }

    .link-to-main a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }

    .link-to-main a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1>ä¸ªäººä¿¡æ¯æ•´ç†</h1>
      <p>ç®¡ç†æ‚¨å…³æ³¨çš„ä¿¡æ¯æº</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">ç™»å½•</div>
      <div class="auth-tab" onclick="switchTab('register')">æ³¨å†Œ</div>
    </div>

    <div id="message" class="message"></div>

    <!-- ç™»å½•è¡¨å• -->
    <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>ç”¨æˆ·åæˆ–é‚®ç®±</label>
        <input type="text" id="loginUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·åæˆ–é‚®ç®±" required>
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
      </div>
      <button type="submit" class="btn-primary" id="loginBtn">
        ç™»å½•
      </button>
    </form>

    <!-- æ³¨å†Œè¡¨å• -->
    <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
      <div class="form-group">
        <label>ç”¨æˆ·å</label>
        <input type="text" id="registerUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required minlength="3">
      </div>
      <div class="form-group">
        <label>é‚®ç®±</label>
        <input type="email" id="registerEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
      </div>
      <div class="form-group">
        <label>å¯†ç </label>
        <input type="password" id="registerPassword" placeholder="è‡³å°‘6ä½å­—ç¬¦" required minlength="6">
      </div>
      <div class="form-group">
        <label>ç¡®è®¤å¯†ç </label>
        <input type="password" id="registerPasswordConfirm" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
      </div>
      <button type="submit" class="btn-primary" id="registerBtn">
        æ³¨å†Œ
      </button>
    </form>

    <div class="link-to-main">
      <a href="/">è¿”å›é¦–é¡µ</a>
    </div>
  </div>

  <script>
    // API åŸºç¡€åœ°å€
    const API_BASE_URL = (() => {
      // æœ¬åœ°å¼€å‘ï¼šä½¿ç”¨æœ¬åœ°API
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return `${window.location.protocol}//${window.location.host}/api`;
      }
      // ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ Railway åç«¯åœ°å€
      return 'https://news-agent-production-c5db.up.railway.app/api';
    })();

    function switchTab(tab) {
      // æ›´æ–°æ ‡ç­¾é¡µ
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('registerForm').classList.add('active');
      }
      
      // æ¸…é™¤æ¶ˆæ¯
      hideMessage();
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type} show`;
      
      setTimeout(() => {
        hideMessage();
      }, 5000);
    }

    function hideMessage() {
      const messageEl = document.getElementById('message');
      messageEl.classList.remove('show');
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      
      if (!username || !password) {
        showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!response.ok) {
          // å¦‚æœå“åº”ä¸æ˜¯ 200-299ï¼Œå°è¯•è·å–é”™è¯¯ä¿¡æ¯
          const errorText = await response.text();
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          
          // å°è¯•è§£æä¸º JSON
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.message || errorMessage;
          } catch (e) {
            // å¦‚æœä¸æ˜¯ JSONï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯ HTML é”™è¯¯é¡µé¢ï¼‰
            if (errorText.includes('The page') || errorText.includes('404') || errorText.includes('Not Found')) {
              errorMessage = 'API åœ°å€é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
            } else if (errorText.length < 200) {
              errorMessage = errorText;
            }
          }
          
          showMessage('ç™»å½•å¤±è´¥: ' + errorMessage, 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'ç™»å½•';
          return;
        }
        
        // æ£€æŸ¥ Content-Type æ˜¯å¦ä¸º JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          showMessage('ç™»å½•å¤±è´¥: æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”ï¼Œè¯·æ£€æŸ¥ API åœ°å€é…ç½®', 'error');
          console.error('é JSON å“åº”:', text.substring(0, 200));
          loginBtn.disabled = false;
          loginBtn.textContent = 'ç™»å½•';
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          // ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
          localStorage.setItem('authToken', result.token);
          localStorage.setItem('userInfo', JSON.stringify(result.user));
          
          showMessage('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
          
          // è·³è½¬åˆ°ä»ªè¡¨ç›˜
          setTimeout(() => {
            window.location.href = '/dashboard.html';
          }, 1000);
        } else {
          showMessage(result.message || 'ç™»å½•å¤±è´¥', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = 'ç™»å½•';
        }
      } catch (error) {
        // ç½‘ç»œé”™è¯¯æˆ– JSON è§£æé”™è¯¯
        let errorMessage = error.message;
        if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
          errorMessage = 'API åœ°å€é…ç½®é”™è¯¯æˆ–åç«¯æœåŠ¡æœªè¿è¡Œã€‚è¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½²\n2. API åœ°å€æ˜¯å¦æ­£ç¡®\n3. åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
        }
        showMessage('ç™»å½•å¤±è´¥: ' + errorMessage, 'error');
        console.error('ç™»å½•é”™è¯¯è¯¦æƒ…:', error);
        loginBtn.disabled = false;
        loginBtn.textContent = 'ç™»å½•';
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      
      const username = document.getElementById('registerUsername').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      const registerBtn = document.getElementById('registerBtn');
      
      if (!username || !email || !password) {
        showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
        return;
      }
      
      if (password.length < 6) {
        showMessage('å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        return;
      }
      
      registerBtn.disabled = true;
      registerBtn.innerHTML = '<span class="loading"></span>æ³¨å†Œä¸­...';
      
      // è®°å½•è¯·æ±‚ä¿¡æ¯
      console.log('ğŸ“ å¼€å§‹æ³¨å†Œè¯·æ±‚');
      console.log('   APIåœ°å€:', `${API_BASE_URL}/auth/register`);
      console.log('   ç”¨æˆ·å:', username);
      console.log('   é‚®ç®±:', email);
      
      try {
        const requestBody = { username, email, password };
        console.log('   è¯·æ±‚ä½“:', { username, email, password: '***' });
        
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('   å“åº”çŠ¶æ€:', response.status, response.statusText);
        console.log('   å“åº”å¤´:', Object.fromEntries(response.headers.entries()));
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!response.ok) {
          const errorText = await response.text();
          console.error('   é”™è¯¯å“åº”å†…å®¹:', errorText.substring(0, 500));
          
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.message || errorMessage;
          } catch (e) {
            if (errorText.includes('The page') || errorText.includes('404') || errorText.includes('Not Found')) {
              errorMessage = 'API åœ°å€é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
            } else if (errorText.length < 200) {
              errorMessage = errorText;
            } else {
              errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—`;
            }
          }
          
          showMessage('æ³¨å†Œå¤±è´¥: ' + errorMessage, 'error');
          registerBtn.disabled = false;
          registerBtn.textContent = 'æ³¨å†Œ';
          return;
        }
        
        // æ£€æŸ¥ Content-Type æ˜¯å¦ä¸º JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('   é JSON å“åº”:', text.substring(0, 500));
          showMessage('æ³¨å†Œå¤±è´¥: æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”ï¼Œè¯·æ£€æŸ¥ API åœ°å€é…ç½®', 'error');
          registerBtn.disabled = false;
          registerBtn.textContent = 'æ³¨å†Œ';
          return;
        }
        
        const result = await response.json();
        console.log('   å“åº”ç»“æœ:', result);
        
        if (result.success) {
          console.log('âœ… æ³¨å†ŒæˆåŠŸ');
          showMessage('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•', 'success');
          
          // åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾é¡µ
          setTimeout(() => {
            switchTab('login');
            document.getElementById('loginUsername').value = username;
            registerBtn.disabled = false;
            registerBtn.textContent = 'æ³¨å†Œ';
          }, 1500);
        } else {
          console.error('âŒ æ³¨å†Œå¤±è´¥:', result.message);
          showMessage(result.message || 'æ³¨å†Œå¤±è´¥', 'error');
          registerBtn.disabled = false;
          registerBtn.textContent = 'æ³¨å†Œ';
        }
      } catch (error) {
        console.error('âŒ æ³¨å†Œè¯·æ±‚å¼‚å¸¸:', error);
        console.error('   é”™è¯¯ç±»å‹:', error.name);
        console.error('   é”™è¯¯æ¶ˆæ¯:', error.message);
        console.error('   é”™è¯¯å †æ ˆ:', error.stack);
        
        let errorMessage = error.message;
        
        // å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMessage = 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ï¼š\n1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. API åœ°å€æ˜¯å¦æ­£ç¡® (' + API_BASE_URL + ')\n3. åç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ\n4. æ˜¯å¦å­˜åœ¨ CORS è·¨åŸŸé—®é¢˜';
        } else if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
          errorMessage = 'API åœ°å€é…ç½®é”™è¯¯æˆ–åç«¯æœåŠ¡æœªè¿è¡Œã€‚è¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦å·²éƒ¨ç½²\n2. API åœ°å€æ˜¯å¦æ­£ç¡®\n3. åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ';
        } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMessage = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ã€‚å¯èƒ½çš„åŸå› ï¼š\n1. åç«¯æœåŠ¡æœªè¿è¡Œæˆ–æ— æ³•è®¿é—®\n2. API åœ°å€é…ç½®é”™è¯¯\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n4. CORS è·¨åŸŸé™åˆ¶\n\nå½“å‰ API åœ°å€: ' + API_BASE_URL;
        }
        
        showMessage('æ³¨å†Œå¤±è´¥: ' + errorMessage, 'error');
        registerBtn.disabled = false;
        registerBtn.textContent = 'æ³¨å†Œ';
      }
    }

    // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    const token = localStorage.getItem('authToken');
    if (token) {
      // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
      fetch(`${API_BASE_URL}/auth/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(async res => {
          // æ£€æŸ¥å“åº”çŠ¶æ€å’Œ Content-Type
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('æœåŠ¡å™¨è¿”å›äº†é JSON å“åº”');
          }
          
          return res.json();
        })
        .then(result => {
          if (result.success) {
            // å·²ç™»å½•ï¼Œè·³è½¬åˆ°ä»ªè¡¨ç›˜
            window.location.href = '/dashboard.html';
          } else {
            // token æ— æ•ˆï¼Œæ¸…é™¤
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
          }
        })
        .catch(error => {
          // token æ— æ•ˆæˆ– API é”™è¯¯ï¼Œæ¸…é™¤
          console.error('éªŒè¯ token å¤±è´¥:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
        });
    }
  </script>
</body>
</html>
