<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>登录 - 个人信息整理网站</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      width: 100%;
      max-width: 420px;
      padding: 40px;
    }

    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .auth-header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 8px;
    }

    .auth-header p {
      color: #666;
      font-size: 14px;
    }

    .auth-tabs {
      display: flex;
      margin-bottom: 24px;
      border-bottom: 2px solid #eee;
    }

    .auth-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .auth-tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .auth-form {
      display: none;
    }

    .auth-form.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group input::placeholder {
      color: #999;
    }

    .btn-primary {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.show {
      display: block;
    }

    .message.error {
      background-color: #fee;
      color: #c33;
      border: 1px solid #fcc;
    }

    .message.success {
      background-color: #efe;
      color: #3c3;
      border: 1px solid #cfc;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .link-to-main {
      text-align: center;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #eee;
    }

    .link-to-main a {
      color: #667eea;
      text-decoration: none;
      font-size: 14px;
    }

    .link-to-main a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-header">
      <h1>个人信息整理</h1>
      <p>管理您关注的信息源</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">登录</div>
      <div class="auth-tab" onclick="switchTab('register')">注册</div>
    </div>

    <div id="message" class="message"></div>

    <!-- 登录表单 -->
    <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label>用户名或邮箱</label>
        <input type="text" id="loginUsername" placeholder="请输入用户名或邮箱" required>
      </div>
      <div class="form-group">
        <label>密码</label>
        <input type="password" id="loginPassword" placeholder="请输入密码" required>
      </div>
      <button type="submit" class="btn-primary" id="loginBtn">
        登录
      </button>
    </form>

    <!-- 注册表单 -->
    <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
      <div class="form-group">
        <label>用户名</label>
        <input type="text" id="registerUsername" placeholder="请输入用户名" required minlength="3">
      </div>
      <div class="form-group">
        <label>邮箱</label>
        <input type="email" id="registerEmail" placeholder="请输入邮箱" required>
      </div>
      <div class="form-group">
        <label>密码</label>
        <input type="password" id="registerPassword" placeholder="至少6位字符" required minlength="6">
      </div>
      <div class="form-group">
        <label>确认密码</label>
        <input type="password" id="registerPasswordConfirm" placeholder="请再次输入密码" required>
      </div>
      <button type="submit" class="btn-primary" id="registerBtn">
        注册
      </button>
    </form>

    <div class="link-to-main">
      <a href="/">返回首页</a>
    </div>
  </div>

  <script>
    // API 基础地址
    const API_BASE_URL = (() => {
      // 本地开发：使用本地API
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return `${window.location.protocol}//${window.location.host}/api`;
      }
      // 生产环境：使用 Railway 后端地址
      return 'https://news-agent-production-c5db.up.railway.app/api';
    })();

    function switchTab(tab) {
      // 更新标签页
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
      
      if (tab === 'login') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('registerForm').classList.add('active');
      }
      
      // 清除消息
      hideMessage();
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type} show`;
      
      setTimeout(() => {
        hideMessage();
      }, 5000);
    }

    function hideMessage() {
      const messageEl = document.getElementById('message');
      messageEl.classList.remove('show');
    }

    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      
      if (!username || !password) {
        showMessage('请填写完整信息', 'error');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="loading"></span>登录中...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
        
        // 检查响应状态
        if (!response.ok) {
          // 如果响应不是 200-299，尝试获取错误信息
          const errorText = await response.text();
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          
          // 尝试解析为 JSON
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.message || errorMessage;
          } catch (e) {
            // 如果不是 JSON，使用原始文本（可能是 HTML 错误页面）
            if (errorText.includes('The page') || errorText.includes('404') || errorText.includes('Not Found')) {
              errorMessage = 'API 地址配置错误，请检查后端服务是否正常运行';
            } else if (errorText.length < 200) {
              errorMessage = errorText;
            }
          }
          
          showMessage('登录失败: ' + errorMessage, 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = '登录';
          return;
        }
        
        // 检查 Content-Type 是否为 JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          showMessage('登录失败: 服务器返回了非 JSON 响应，请检查 API 地址配置', 'error');
          console.error('非 JSON 响应:', text.substring(0, 200));
          loginBtn.disabled = false;
          loginBtn.textContent = '登录';
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          // 保存 token 和用户信息
          localStorage.setItem('authToken', result.token);
          localStorage.setItem('userInfo', JSON.stringify(result.user));
          
          showMessage('登录成功，正在跳转...', 'success');
          
          // 跳转到仪表盘
          setTimeout(() => {
            window.location.href = '/dashboard.html';
          }, 1000);
        } else {
          showMessage(result.message || '登录失败', 'error');
          loginBtn.disabled = false;
          loginBtn.textContent = '登录';
        }
      } catch (error) {
        // 网络错误或 JSON 解析错误
        let errorMessage = error.message;
        if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
          errorMessage = 'API 地址配置错误或后端服务未运行。请检查：\n1. 后端服务是否已部署\n2. API 地址是否正确\n3. 后端服务是否正常运行';
        }
        showMessage('登录失败: ' + errorMessage, 'error');
        console.error('登录错误详情:', error);
        loginBtn.disabled = false;
        loginBtn.textContent = '登录';
      }
    }

    async function handleRegister(event) {
      event.preventDefault();
      
      const username = document.getElementById('registerUsername').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      const registerBtn = document.getElementById('registerBtn');
      
      if (!username || !email || !password) {
        showMessage('请填写完整信息', 'error');
        return;
      }
      
      if (password.length < 6) {
        showMessage('密码长度至少6位', 'error');
        return;
      }
      
      if (password !== passwordConfirm) {
        showMessage('两次输入的密码不一致', 'error');
        return;
      }
      
      registerBtn.disabled = true;
      registerBtn.innerHTML = '<span class="loading"></span>注册中...';
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/register`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, email, password })
        });
        
        // 检查响应状态
        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.message || errorMessage;
          } catch (e) {
            if (errorText.includes('The page') || errorText.includes('404') || errorText.includes('Not Found')) {
              errorMessage = 'API 地址配置错误，请检查后端服务是否正常运行';
            } else if (errorText.length < 200) {
              errorMessage = errorText;
            }
          }
          
          showMessage('注册失败: ' + errorMessage, 'error');
          registerBtn.disabled = false;
          registerBtn.textContent = '注册';
          return;
        }
        
        // 检查 Content-Type 是否为 JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          showMessage('注册失败: 服务器返回了非 JSON 响应，请检查 API 地址配置', 'error');
          console.error('非 JSON 响应:', text.substring(0, 200));
          registerBtn.disabled = false;
          registerBtn.textContent = '注册';
          return;
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('注册成功，请登录', 'success');
          
          // 切换到登录标签页
          setTimeout(() => {
            switchTab('login');
            document.getElementById('loginUsername').value = username;
            registerBtn.disabled = false;
            registerBtn.textContent = '注册';
          }, 1500);
        } else {
          showMessage(result.message || '注册失败', 'error');
          registerBtn.disabled = false;
          registerBtn.textContent = '注册';
        }
      } catch (error) {
        let errorMessage = error.message;
        if (error.message.includes('JSON') || error.message.includes('Unexpected token')) {
          errorMessage = 'API 地址配置错误或后端服务未运行。请检查：\n1. 后端服务是否已部署\n2. API 地址是否正确\n3. 后端服务是否正常运行';
        }
        showMessage('注册失败: ' + errorMessage, 'error');
        console.error('注册错误详情:', error);
        registerBtn.disabled = false;
        registerBtn.textContent = '注册';
      }
    }

    // 检查是否已登录
    const token = localStorage.getItem('authToken');
    if (token) {
      // 验证 token 是否有效
      fetch(`${API_BASE_URL}/auth/me`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(async res => {
          // 检查响应状态和 Content-Type
          if (!res.ok) {
            throw new Error(`HTTP ${res.status}`);
          }
          
          const contentType = res.headers.get('content-type');
          if (!contentType || !contentType.includes('application/json')) {
            throw new Error('服务器返回了非 JSON 响应');
          }
          
          return res.json();
        })
        .then(result => {
          if (result.success) {
            // 已登录，跳转到仪表盘
            window.location.href = '/dashboard.html';
          } else {
            // token 无效，清除
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
          }
        })
        .catch(error => {
          // token 无效或 API 错误，清除
          console.error('验证 token 失败:', error);
          localStorage.removeItem('authToken');
          localStorage.removeItem('userInfo');
        });
    }
  </script>
</body>
</html>
