<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文章详情</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.8;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
    }

    .article-header {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      margin-bottom: 20px;
    }

    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background-color: #f5f5f5;
      color: #333;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      text-decoration: none;
      transition: background-color 0.3s;
    }

    .back-btn:hover {
      background-color: #e0e0e0;
    }

    .article-title {
      font-size: 32px;
      font-weight: bold;
      color: #1a1a1a;
      line-height: 1.4;
      margin-bottom: 16px;
    }

    .article-meta {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }

    .article-content {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      font-size: 16px;
      line-height: 1.8;
    }

    .article-content p {
      margin-bottom: 16px;
    }

    .translate-btn {
      padding: 10px 20px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin-top: 20px;
    }

    .translate-btn:hover {
      background-color: #5568d3;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="article-header">
      <a href="javascript:history.back()" class="back-btn">← 返回</a>
      <h1 id="articleTitle" class="article-title">加载中...</h1>
      <div class="article-meta">
        <span id="articleSource"></span>
        <span id="articleDate"></span>
      </div>
      <button id="translateBtn" class="translate-btn" onclick="toggleTranslate()" style="display: none;">
        翻译为中文
      </button>
    </div>
    <div class="article-content" id="articleContent">
      加载中...
    </div>
  </div>

  <script>
    const API_BASE_URL = (() => {
      // 自动检测：如果是本地开发，使用本地API；否则使用当前域名的API
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return `${window.location.protocol}//${window.location.host}/api`;
      }
      // 生产环境：使用当前域名（Railway会自动提供域名）
      return `${window.location.protocol}//${window.location.host}/api`;
    })();

    const urlParams = new URLSearchParams(window.location.search);
    const articleId = urlParams.get('id');
    let originalTitle = '';
    let originalContent = '';
    let isTranslated = false;

    async function loadArticle() {
      try {
        const response = await fetch(`${API_BASE_URL}/news/${articleId}`);
        const result = await response.json();

        if (result.success) {
          const article = result.data;
          originalTitle = article.title;
          originalContent = article.content || article.summary || '';
          
          document.getElementById('articleTitle').textContent = article.title;
          document.getElementById('articleSource').textContent = `来源：${article.source || '未知'}`;
          document.getElementById('articleDate').textContent = `发布时间：${new Date(article.publish_date).toLocaleString('zh-CN')}`;
          
          // 格式化内容
          let content = originalContent
            .replace(/<[^>]*>/g, '')
            .replace(/&nbsp;/g, ' ')
            .trim();
          
          const paragraphs = content.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
          document.getElementById('articleContent').innerHTML = paragraphs.map(p => `<p>${escapeHtml(p)}</p>`).join('');

          // 检查是否为英文，显示翻译按钮
          const textToCheck = (article.title + ' ' + content).substring(0, 500);
          if (isEnglish(textToCheck)) {
            document.getElementById('translateBtn').style.display = 'inline-block';
          }
        }
      } catch (error) {
        document.getElementById('articleContent').textContent = '加载失败: ' + error.message;
      }
    }

    function isEnglish(text) {
      const englishChars = (text.match(/[a-zA-Z]/g) || []).length;
      const totalChars = text.replace(/\s/g, '').length;
      return totalChars > 0 && englishChars / totalChars > 0.5;
    }

    async function toggleTranslate() {
      const btn = document.getElementById('translateBtn');
      const titleEl = document.getElementById('articleTitle');
      const contentEl = document.getElementById('articleContent');
      
      if (isTranslated) {
        // 恢复原文
        titleEl.textContent = originalTitle;
        let content = originalContent.replace(/<[^>]*>/g, '').trim();
        const paragraphs = content.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
        contentEl.innerHTML = paragraphs.map(p => `<p>${escapeHtml(p)}</p>`).join('');
        btn.textContent = '翻译为中文';
        isTranslated = false;
      } else {
        // 翻译
        btn.disabled = true;
        btn.textContent = '翻译中...';
        
        try {
          // 翻译标题
          const titleResponse = await fetch('https://libretranslate.de/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              q: originalTitle,
              source: 'en',
              target: 'zh',
              format: 'text'
            })
          });
          const titleResult = await titleResponse.json();
          
          // 翻译内容（分段翻译，避免过长）
          const content = originalContent.replace(/<[^>]*>/g, '').trim();
          const paragraphs = content.split(/\n\s*\n/).map(p => p.trim()).filter(p => p.length > 0);
          let translatedContent = '';
          
          for (const para of paragraphs.slice(0, 10)) { // 限制前10段
            try {
              const paraResponse = await fetch('https://libretranslate.de/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  q: para.substring(0, 2000),
                  source: 'en',
                  target: 'zh',
                  format: 'text'
                })
              });
              const paraResult = await paraResponse.json();
              translatedContent += `<p>${escapeHtml(paraResult.translatedText || para)}</p>`;
              await new Promise(resolve => setTimeout(resolve, 500)); // 避免请求过快
            } catch (e) {
              translatedContent += `<p>${escapeHtml(para)}</p>`;
            }
          }
          
          titleEl.textContent = titleResult.translatedText || originalTitle;
          contentEl.innerHTML = translatedContent || contentEl.innerHTML;
          btn.textContent = '显示原文';
          isTranslated = true;
        } catch (error) {
          alert('翻译失败: ' + error.message);
        } finally {
          btn.disabled = false;
        }
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    if (articleId) {
      loadArticle();
    } else {
      document.getElementById('articleContent').textContent = '无效的文章ID';
    }
  </script>
</body>
</html>
