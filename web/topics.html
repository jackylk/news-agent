<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>订阅管理 - 新闻聚合</title>
  <script src="js/global-progress.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 24px; font-weight: 600; }
    .header a {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.5);
      border-radius: 6px;
      transition: all 0.3s;
    }
    .header a:hover { background: rgba(255,255,255,0.2); }
    .content { padding: 30px; }
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      z-index: 1000;
      max-width: 400px;
    }
    .message.show { display: block; }
    .message.error { background: #fee; color: #c33; border: 1px solid #fcc; }
    .message.success { background: #efe; color: #2a2; border: 1px solid #cfc; }

    /* 添加主题区域 */
    .add-topic-section {
      margin-bottom: 25px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .add-topic-section h3 { margin-bottom: 12px; color: #333; font-size: 16px; }
    .add-topic-form { display: flex; gap: 12px; }
    .add-topic-form input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    .add-topic-form input:focus { outline: none; border-color: #667eea; }
    .add-topic-form button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .add-topic-form button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .add-topic-form button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* 主题页签 */
    .topic-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    .topic-tab {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      color: #555;
      transition: all 0.3s;
    }
    .topic-tab:hover { background: #e0e0e0; }
    .topic-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .topic-tab .delete-btn {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(0,0,0,0.1);
      border: none;
      cursor: pointer;
      font-size: 12px;
      line-height: 18px;
      color: inherit;
      transition: background 0.2s;
    }
    .topic-tab .delete-btn:hover { background: rgba(255,0,0,0.3); }
    .topic-tab.active .delete-btn { background: rgba(255,255,255,0.3); }
    .no-topics { text-align: center; padding: 60px 20px; color: #888; }
    .no-topics p { margin-bottom: 10px; font-size: 16px; }

    /* 主题内容区域 */
    .topic-content { display: none; }
    .topic-content.active { display: block; }

</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>订阅管理</h1>
      <a href="index.html">返回首页</a>
    </div>
    <div class="content">
      <div class="add-topic-section">
        <h3>添加主题词</h3>
        <div class="add-topic-form">
          <input type="text" id="topicInput" placeholder="输入主题关键词，如：人工智能、区块链..." onkeypress="if(event.key==='Enter')addNewTopic()" />
          <button onclick="addNewTopic()" id="addTopicBtn">添加主题</button>
        </div>
      </div>
      <div class="topic-tabs" id="topicTabs"></div>
      <div id="topicContents"></div>
      <div class="no-topics" id="noTopics" style="display: none;">
        <p>还没有添加任何主题词</p>
        <p>请在上方输入框中添加您感兴趣的主题</p>
      </div>
    </div>
  </div>
  <div class="message" id="message"></div>

<style>
    /* 已订阅信息源 */
    .subscribed-section { margin-bottom: 25px; }
    .subscribed-section h3 { font-size: 16px; color: #333; margin-bottom: 15px; }
    .subscribed-list { display: flex; flex-wrap: wrap; gap: 10px; }
    .subscribed-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #e8f4fd;
      border: 1px solid #b3d9f7;
      border-radius: 20px;
      font-size: 13px;
      color: #1976d2;
    }
    .subscribed-tag .unsubscribe-btn {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: rgba(25, 118, 210, 0.2);
      border: none;
      cursor: pointer;
      font-size: 10px;
      line-height: 16px;
      color: #1976d2;
      transition: all 0.2s;
    }
    .subscribed-tag .unsubscribe-btn:hover { background: #f44336; color: white; }
    .no-subscriptions {
      color: #888;
      font-size: 14px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      text-align: center;
    }

    /* 推荐信息源表格 */
    .recommend-section { margin-bottom: 25px; }
    .recommend-section h3 { font-size: 16px; color: #333; margin-bottom: 15px; }
    .recommend-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    .recommend-table th, .recommend-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    .recommend-table th {
      background: #f8f9fa;
      font-weight: 500;
      color: #555;
      font-size: 13px;
    }
    .recommend-table th:nth-child(1) { width: 40px; text-align: center; }
    .recommend-table th:nth-child(2) { width: 20%; }
    .recommend-table th:nth-child(3) { width: 70px; text-align: center; }
    .recommend-table th:nth-child(4) { width: 70px; text-align: center; }
    .recommend-table th:nth-child(5) { width: auto; }
    .recommend-table th:nth-child(6) { width: 80px; text-align: center; }
    .recommend-table td:nth-child(1) { text-align: center; }
    .recommend-table td:nth-child(3), .recommend-table td:nth-child(4), .recommend-table td:nth-child(6) { text-align: center; }
    .recommend-table tbody tr:hover { background: #f8f9fa; }
    .recommend-table input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .source-type-tag, .source-region-tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
    }
    .source-type-tag { background: #e3f2fd; color: #1565c0; }
    .source-region-tag { background: #fff3e0; color: #e65100; }
    .source-region-tag.domestic { background: #e8f5e9; color: #2e7d32; }
    .valid-status { font-size: 12px; }
    .valid-status.valid { color: #4caf50; }
    .valid-status.invalid { color: #f44336; }
    .valid-status.pending { color: #ff9800; }

    /* 按钮区域 */
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 20px;
    }
    .action-buttons button {
      padding: 12px 28px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .subscribe-btn {
      background: linear-gradient(135deg, #4caf50, #45a049);
      color: white;
    }
    .subscribe-btn:hover { box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4); }
    .subscribe-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .load-more-btn {
      background: #f0f0f0;
      color: #555;
    }
    .load-more-btn:hover { background: #e0e0e0; }
    .no-recommendations {
      color: #888;
      font-size: 14px;
      padding: 30px;
      background: #f5f5f5;
      border-radius: 8px;
      text-align: center;
    }
</style>

<script>
// API 基础地址（统一部署，前后端同域）
const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;

let topics = [];
let curatedSourcesCache = null;
let topicData = {}; // { keywords: { subscriptions: [], recommendations: [], displayedCount: 0 } }

// 页面初始化
document.addEventListener('DOMContentLoaded', () => {
  checkAuth();
});

function checkAuth() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = 'login.html';
    return;
  }
  loadTopics();
  loadCuratedSources();
}

function getAuthHeaders() {
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  };
}

function showMessage(text, type = 'error') {
  const msg = document.getElementById('message');
  msg.textContent = text;
  msg.className = `message show ${type}`;
  setTimeout(() => msg.classList.remove('show'), 3000);
}

// 加载内置信息源
async function loadCuratedSources() {
  if (curatedSourcesCache) return curatedSourcesCache;
  try {
    const res = await fetch(`${API_BASE_URL}/user/curated-sources`, { headers: getAuthHeaders() });
    const data = await res.json();
    if (data.success) {
      curatedSourcesCache = data.sources || [];
    }
  } catch (e) {
    console.error('加载内置信息源失败:', e);
  }
  return curatedSourcesCache || [];
}

// 匹配内置信息源
function matchCuratedSources(keywords) {
  if (!curatedSourcesCache || curatedSourcesCache.length === 0) return [];
  const kws = keywords.toLowerCase().split(/[,，\s]+/).filter(k => k);
  return curatedSourcesCache.filter(source => {
    const text = `${source.sourceName} ${source.category} ${source.description}`.toLowerCase();
    return kws.some(kw => text.includes(kw));
  });
}

// 加载主题列表
async function loadTopics() {
  try {
    const res = await fetch(`${API_BASE_URL}/user/topics`, { headers: getAuthHeaders() });
    const data = await res.json();
    if (data.success) {
      topics = data.data || [];
      renderTopicTabs();
      if (topics.length > 0) {
        switchTopicTab(0);
      }
    }
  } catch (e) {
    showMessage('加载主题列表失败');
  }
}

// 渲染主题页签
function renderTopicTabs() {
  const tabsContainer = document.getElementById('topicTabs');
  const contentsContainer = document.getElementById('topicContents');
  const noTopics = document.getElementById('noTopics');

  if (topics.length === 0) {
    tabsContainer.innerHTML = '';
    contentsContainer.innerHTML = '';
    noTopics.style.display = 'block';
    return;
  }

  noTopics.style.display = 'none';
  tabsContainer.innerHTML = topics.map((t, i) => `
    <button class="topic-tab" data-index="${i}" onclick="switchTopicTab(${i})">
      <span>${t.keywords}</span>
      <button class="delete-btn" onclick="event.stopPropagation();deleteTopic('${t.keywords.replace(/'/g, "\\'")}')">×</button>
    </button>
  `).join('');

  contentsContainer.innerHTML = topics.map((t, i) => `
    <div class="topic-content" id="topicContent-${i}">
      <div class="subscribed-section">
        <h3>已订阅的信息源 (<span id="subscribedCount-${i}">0</span>个)</h3>
        <div class="subscribed-list" id="subscribedList-${i}"></div>
      </div>
      <div class="recommend-section">
        <h3>推荐信息源</h3>
        <div id="recommendContent-${i}"></div>
        <div class="action-buttons" id="actionButtons-${i}" style="display:none;">
          <button class="subscribe-btn" id="subscribeBtn-${i}" onclick="subscribeSelected(${i})">订阅选中 (0)</button>
          <button class="load-more-btn" id="loadMoreBtn-${i}" onclick="loadMoreRecommendations(${i})">加载更多</button>
        </div>
      </div>
    </div>
  `).join('');
}

// 切换主题页签
function switchTopicTab(index) {
  document.querySelectorAll('.topic-tab').forEach((tab, i) => {
    tab.classList.toggle('active', i === index);
  });
  document.querySelectorAll('.topic-content').forEach((content, i) => {
    content.classList.toggle('active', i === index);
  });

  const keywords = topics[index].keywords;
  if (!topicData[keywords]) {
    topicData[keywords] = { subscriptions: [], recommendations: [], displayedCount: 0 };
    loadSubscriptions(index, keywords);
    loadRecommendationHistory(index, keywords);
  } else {
    renderSubscriptions(index, keywords);
    renderRecommendations(index);
  }
}

// 添加新主题
async function addNewTopic() {
  const input = document.getElementById('topicInput');
  const keywords = input.value.trim();
  if (!keywords) {
    showMessage('请输入主题关键词');
    return;
  }

  const btn = document.getElementById('addTopicBtn');
  btn.disabled = true;
  btn.textContent = '添加中...';

  try {
    const res = await fetch(`${API_BASE_URL}/user/topics`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ keywords })
    });
    const data = await res.json();
    if (data.success) {
      input.value = '';
      topics.push({ keywords });
      topicData[keywords] = { subscriptions: [], recommendations: [], displayedCount: 0 };
      renderTopicTabs();
      const newIndex = topics.length - 1;
      switchTopicTab(newIndex);
      // 自动开始推荐
      startRecommendation(newIndex, keywords);
      showMessage('主题添加成功', 'success');
    } else {
      showMessage(data.message || '添加失败');
    }
  } catch (e) {
    showMessage('添加主题失败');
  } finally {
    btn.disabled = false;
    btn.textContent = '添加主题';
  }
}

// 删除主题
async function deleteTopic(keywords) {
  if (!confirm(`确定要删除主题"${keywords}"吗？\n这将同时删除该主题下的所有订阅和文章。`)) return;

  try {
    const res = await fetch(`${API_BASE_URL}/user/topics/${encodeURIComponent(keywords)}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    const data = await res.json();
    if (data.success) {
      const activeTab = document.querySelector('.topic-tab.active');
      const activeIndex = activeTab ? parseInt(activeTab.dataset.index) : 0;
      const deletedIndex = topics.findIndex(t => t.keywords === keywords);

      delete topicData[keywords];
      topics = topics.filter(t => t.keywords !== keywords);
      renderTopicTabs();

      if (topics.length > 0) {
        const newIndex = deletedIndex === activeIndex
          ? Math.min(deletedIndex, topics.length - 1)
          : (deletedIndex < activeIndex ? activeIndex - 1 : activeIndex);
        switchTopicTab(Math.max(0, newIndex));
      }
      showMessage(data.message || '主题删除成功', 'success');
    } else {
      showMessage(data.message || '删除失败');
    }
  } catch (e) {
    showMessage('删除主题失败');
  }
}

// 加载订阅列表
async function loadSubscriptions(index, keywords) {
  try {
    const res = await fetch(`${API_BASE_URL}/user/subscriptions?topicKeywords=${encodeURIComponent(keywords)}`, {
      headers: getAuthHeaders()
    });
    const data = await res.json();
    if (data.success) {
      topicData[keywords].subscriptions = data.data || [];
      renderSubscriptions(index, keywords);
    }
  } catch (e) {
    console.error('加载订阅失败:', e);
  }
}

// 渲染订阅列表
function renderSubscriptions(index, keywords) {
  const subs = topicData[keywords]?.subscriptions || [];
  document.getElementById(`subscribedCount-${index}`).textContent = subs.length;
  const container = document.getElementById(`subscribedList-${index}`);

  if (subs.length === 0) {
    container.innerHTML = '<div class="no-subscriptions">暂无订阅的信息源</div>';
    return;
  }

  container.innerHTML = subs.map(s => `
    <div class="subscribed-tag">
      <span>${s.source_name}</span>
      <button class="unsubscribe-btn" onclick="unsubscribe(${index},'${keywords.replace(/'/g, "\\'")}','${s.source_name.replace(/'/g, "\\'")}')">×</button>
    </div>
  `).join('');
}

// 取消订阅
async function unsubscribe(index, keywords, sourceName) {
  if (!confirm(`确定要取消订阅"${sourceName}"吗？\n这将同时删除该信息源的所有已抓取文章。`)) return;

  try {
    const res = await fetch(`${API_BASE_URL}/user/subscriptions/${encodeURIComponent(sourceName)}?topicKeywords=${encodeURIComponent(keywords)}`, {
      method: 'DELETE',
      headers: getAuthHeaders()
    });
    const data = await res.json();
    if (data.success) {
      topicData[keywords].subscriptions = topicData[keywords].subscriptions.filter(s => s.source_name !== sourceName);
      renderSubscriptions(index, keywords);
      showMessage(data.message || '取消订阅成功', 'success');
    } else {
      showMessage(data.message || '取消订阅失败');
    }
  } catch (e) {
    showMessage('取消订阅失败');
  }
}


// 加载推荐历史
async function loadRecommendationHistory(index, keywords) {
  try {
    const res = await fetch(`${API_BASE_URL}/user/topics/recommend/history/${encodeURIComponent(keywords)}`, {
      headers: getAuthHeaders()
    });
    const data = await res.json();
    if (data.success && data.data && data.data.sources && data.data.sources.length > 0) {
      // 有历史记录，使用历史数据
      topicData[keywords].recommendations = data.data.sources;
      topicData[keywords].displayedCount = 0;
      renderRecommendations(index);
    } else {
      // 没有历史记录，开始新的推荐
      startRecommendation(index, keywords);
    }
  } catch (e) {
    console.error('加载推荐历史失败:', e);
    startRecommendation(index, keywords);
  }
}

// 开始推荐流程
async function startRecommendation(index, keywords) {
  const taskId = `recommend-${keywords}`;
  GlobalProgress.addTask(taskId, '推荐信息源', keywords, 10, '匹配内置信息源中...');

  // 先匹配内置信息源
  const curatedMatches = matchCuratedSources(keywords);
  let allRecommendations = curatedMatches.map(s => ({
    ...s,
    isValid: true,
    isCurated: true
  }));

  GlobalProgress.updateTask(taskId, 30, `已匹配 ${curatedMatches.length} 个内置信息源，正在调用 AI 推荐...`);

  // 调用 DeepSeek API 获取更多推荐
  try {
    const res = await fetch(`${API_BASE_URL}/user/topics/recommend`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ keywords })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      for (const line of lines) {
        if (!line.trim()) continue;
        try {
          const msg = JSON.parse(line);
          if (msg.type === 'progress') {
            const progressText = msg.message || '';
            let percent = 40;
            if (progressText.includes('验证')) percent = 60;
            if (progressText.includes('完成')) percent = 90;
            GlobalProgress.updateTask(taskId, percent, progressText);
          } else if (msg.type === 'sourcesReceived') {
            // 收到推荐源，合并（去重）
            const newSources = (msg.sources || []).filter(s =>
              !allRecommendations.some(r => r.sourceUrl === s.sourceUrl)
            );
            allRecommendations = [...allRecommendations, ...newSources];
          } else if (msg.type === 'sourceValidated') {
            // 更新验证状态
            const source = msg.source;
            const idx = allRecommendations.findIndex(r => r.sourceUrl === source.sourceUrl);
            if (idx >= 0) {
              allRecommendations[idx] = { ...allRecommendations[idx], ...source };
            }
          } else if (msg.type === 'final') {
            GlobalProgress.completeTask(taskId, msg.message || '推荐完成');
          }
        } catch (e) {}
      }
    }
  } catch (e) {
    console.error('推荐失败:', e);
    GlobalProgress.completeTask(taskId, '部分推荐可能失败');
  }

  // 保存并渲染
  topicData[keywords].recommendations = allRecommendations;
  topicData[keywords].displayedCount = 0;
  renderRecommendations(index);
}

// 渲染推荐列表（每次显示10项）
function renderRecommendations(index) {
  const keywords = topics[index].keywords;
  const data = topicData[keywords];
  if (!data) return;

  const all = data.recommendations || [];
  const displayed = data.displayedCount || 0;
  const toShow = all.slice(0, displayed + 10);
  data.displayedCount = toShow.length;

  const container = document.getElementById(`recommendContent-${index}`);
  const actionBtns = document.getElementById(`actionButtons-${index}`);

  if (all.length === 0) {
    container.innerHTML = '<div class="no-recommendations">暂无推荐信息源，请稍后再试</div>';
    actionBtns.style.display = 'none';
    return;
  }

  // 过滤掉已订阅的
  const subscribedUrls = new Set((data.subscriptions || []).map(s => s.source_url));
  const filtered = toShow.filter(s => !subscribedUrls.has(s.sourceUrl));

  container.innerHTML = `
    <table class="recommend-table">
      <thead>
        <tr>
          <th><input type="checkbox" onchange="toggleAllCheckboxes(${index}, this.checked)" /></th>
          <th>信息源名称</th>
          <th>类型</th>
          <th>地区</th>
          <th>描述</th>
          <th>状态</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map((s, i) => `
          <tr>
            <td><input type="checkbox" class="source-checkbox-${index}" data-index="${i}" onchange="updateSubscribeButton(${index})" ${s.isValid === false ? 'disabled' : ''} /></td>
            <td title="${s.sourceUrl}">${s.sourceName}${s.isCurated ? ' ⭐' : ''}</td>
            <td><span class="source-type-tag">${s.sourceType || 'rss'}</span></td>
            <td><span class="source-region-tag ${s.region === '国内' ? 'domestic' : ''}">${s.region || '国外'}</span></td>
            <td>${s.description || '-'}</td>
            <td><span class="valid-status ${s.isValid === true ? 'valid' : s.isValid === false ? 'invalid' : 'pending'}">${s.isValid === true ? '✓ 有效' : s.isValid === false ? '✗ 无效' : '验证中...'}</span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;

  actionBtns.style.display = 'flex';
  const remaining = all.length - toShow.length;
  document.getElementById(`loadMoreBtn-${index}`).textContent = remaining > 0 ? `加载更多 (${remaining}个)` : '没有更多了';
  document.getElementById(`loadMoreBtn-${index}`).disabled = remaining <= 0;
  updateSubscribeButton(index);
}

function toggleAllCheckboxes(index, checked) {
  document.querySelectorAll(`.source-checkbox-${index}:not(:disabled)`).forEach(cb => cb.checked = checked);
  updateSubscribeButton(index);
}

function updateSubscribeButton(index) {
  const checked = document.querySelectorAll(`.source-checkbox-${index}:checked`).length;
  const btn = document.getElementById(`subscribeBtn-${index}`);
  btn.textContent = `订阅选中 (${checked})`;
  btn.disabled = checked === 0;
}

function loadMoreRecommendations(index) {
  renderRecommendations(index);
}

// 订阅选中的信息源
async function subscribeSelected(index) {
  const keywords = topics[index].keywords;
  const data = topicData[keywords];
  const checkboxes = document.querySelectorAll(`.source-checkbox-${index}:checked`);

  if (checkboxes.length === 0) {
    showMessage('请先选择要订阅的信息源');
    return;
  }

  // 获取选中的信息源
  const all = data.recommendations || [];
  const subscribedUrls = new Set((data.subscriptions || []).map(s => s.source_url));
  const filtered = all.slice(0, data.displayedCount).filter(s => !subscribedUrls.has(s.sourceUrl));

  const selectedSources = [];
  checkboxes.forEach(cb => {
    const idx = parseInt(cb.dataset.index);
    if (filtered[idx]) {
      selectedSources.push(filtered[idx]);
    }
  });

  if (selectedSources.length === 0) return;

  const btn = document.getElementById(`subscribeBtn-${index}`);
  btn.disabled = true;
  btn.textContent = '订阅中...';

  const subTaskId = `subscribe-${keywords}`;
  GlobalProgress.addTask(subTaskId, '订阅信息源', keywords, 20, `准备订阅 ${selectedSources.length} 个信息源`);

  try {
    // 构建订阅数据
    const subscriptions = selectedSources.map(s => ({
      sourceName: s.sourceName,
      sourceUrl: s.sourceUrl,
      sourceType: s.sourceType || 'rss',
      category: s.category || '',
      description: s.description || '',
      region: s.region || '国外',
      topicKeywords: keywords
    }));

    // 调用订阅 API
    const res = await fetch(`${API_BASE_URL}/user/subscriptions`, {
      method: 'POST',
      headers: getAuthHeaders(),
      body: JSON.stringify({ subscriptions })
    });

    const result = await res.json();
    if (result.success) {
      GlobalProgress.updateTask(subTaskId, 50, '开始抓取文章内容...');

      // 更新本地订阅列表
      const newSubs = subscriptions.map(s => ({
        source_name: s.sourceName,
        source_url: s.sourceUrl,
        source_type: s.sourceType
      }));
      data.subscriptions = [...(data.subscriptions || []), ...newSubs];
      renderSubscriptions(index, keywords);

      // 触发抓取
      try {
        const crawlRes = await fetch(`${API_BASE_URL}/collect`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ topicKeywords: keywords })
        });

        const crawlData = await crawlRes.json();
        if (crawlData.success) {
          GlobalProgress.completeTask(subTaskId, crawlData.message || '文章抓取完成');
        } else {
          GlobalProgress.completeTask(subTaskId, '抓取可能部分失败');
        }
      } catch (e) {
        GlobalProgress.completeTask(subTaskId, '文章将在后台抓取');
      }

      renderRecommendations(index);
      showMessage(`成功订阅 ${selectedSources.length} 个信息源`, 'success');
    } else {
      GlobalProgress.removeTask(subTaskId);
      showMessage(result.message || '订阅失败');
    }
  } catch (e) {
    GlobalProgress.removeTask(subTaskId);
    showMessage('订阅失败: ' + e.message);
  } finally {
    btn.disabled = false;
    updateSubscribeButton(index);
  }
}
</script>
</body>
</html>
