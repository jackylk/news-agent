<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°é—»ç®¡ç†åå°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .auth-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 400px;
    }

    .auth-section h3 {
      margin-bottom: 15px;
    }

    .auth-section input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .auth-section button {
      width: 100%;
      padding: 12px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .auth-section button:hover {
      background-color: #5568d3;
    }

    .stats-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }

    table tr:hover {
      background-color: #f8f9fa;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s;
      margin-right: 5px;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #c82333;
    }

    .btn-refresh {
      background-color: #28a745;
      color: white;
    }

    .btn-refresh:hover {
      background-color: #218838;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .message {
      display: none;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-bar input,
    .search-bar select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-bar input {
      flex: 1;
      min-width: 200px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
    }

    .pagination span {
      padding: 0 10px;
    }

    /* é¡µç­¾æ ·å¼ */
    .tabs {
      margin-bottom: 20px;
    }

    .tabs-header {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0;
    }

    .tab-button {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      transition: all 0.3s;
      position: relative;
    }

    .tab-button:hover {
      background: #f8f9fa;
      color: #667eea;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: #f8f9fa;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .status-ok {
      color: #28a745;
      font-weight: bold;
    }

    .status-error {
      color: #dc3545;
      font-weight: bold;
    }

    .status-unknown {
      color: #6c757d;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      margin: 0 2px;
    }

    /* è¡¨æ ¼è®°å½•æ•°æ˜¾ç¤º */
    .table-count {
      margin-bottom: 15px;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
      color: #495057;
      border-left: 3px solid #667eea;
    }

    .table-count strong {
      color: #667eea;
      font-weight: 600;
    }

    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .modal-content select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .modal-content .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-content .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-content .modal-buttons .btn-confirm {
      background-color: #dc3545;
      color: white;
    }

    .modal-content .modal-buttons .btn-confirm:hover {
      background-color: #c82333;
    }

    .modal-content .modal-buttons .btn-cancel {
      background-color: #6c757d;
      color: white;
    }

    .modal-content .modal-buttons .btn-cancel:hover {
      background-color: #5a6268;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>æ–°é—»ç®¡ç†åå°</h1>
          <p>ç®¡ç†ç³»ç»Ÿç”¨æˆ·ã€ä¸»é¢˜è¯ã€è®¢é˜…å’Œæ–‡ç« </p>
        </div>
        <div id="logoutButtonContainer" style="display: none;">
          <button class="btn" onclick="logout()" style="background-color: #6c757d; color: white;">
            é€€å‡ºç™»å½•
          </button>
        </div>
      </div>
    </div>

    <div class="auth-section" id="authSection">
      <h3>ç®¡ç†å‘˜è®¤è¯</h3>
      <input 
        type="password" 
        id="adminToken" 
        placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜ä»¤ç‰Œ" 
        onkeypress="if(event.key==='Enter') authenticate()"
      />
      <button onclick="authenticate()">ç™»å½•</button>
    </div>

    <div id="adminContent" style="display: none;">
      <div class="message" id="message"></div>

      <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <div class="stats-section" id="statsSection">
        <div class="stat-item">
          <div class="stat-value" id="totalCount">-</div>
          <div class="stat-label">æ€»æ–°é—»æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalTopics">-</div>
          <div class="stat-label">æ€»ä¸»é¢˜æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSubscriptions">-</div>
          <div class="stat-label">æ€»è®¢é˜…æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="lastUpdated">-</div>
          <div class="stat-label">æœ€åæ›´æ–°</div>
        </div>
      </div>

      <!-- é¡µç­¾å¯¼èˆª -->
      <div class="tabs">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('overview')">æ¦‚è§ˆ</button>
          <button class="tab-button" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
          <button class="tab-button" onclick="switchTab('topics')">ä¸»é¢˜ç®¡ç†</button>
          <button class="tab-button" onclick="switchTab('subscriptions')">è®¢é˜…ç®¡ç†</button>
          <button class="tab-button" onclick="switchTab('nitter')">Nitterç®¡ç†</button>
          <button class="tab-button" onclick="switchTab('news')">æ–‡ç« ç®¡ç†</button>
        </div>

        <!-- æ¦‚è§ˆé¡µç­¾ -->
        <div id="tab-overview" class="tab-content active">
          <div class="section">
            <h2>ç³»ç»Ÿæ¦‚è§ˆ</h2>
            <p>æ¬¢è¿ä½¿ç”¨æ–°é—»ç®¡ç†åå°ã€‚è¯·ä½¿ç”¨ä¸Šæ–¹é¡µç­¾å¯¼èˆªåˆ°ä¸åŒåŠŸèƒ½æ¨¡å—ã€‚</p>
          </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç†é¡µç­¾ -->
        <div id="tab-users" class="tab-content">
          <div class="section">
            <h2>ç”¨æˆ·ç®¡ç†</h2>
        <div id="usersLoading" class="loading">åŠ è½½ä¸­...</div>
        <div class="table-container" id="usersTableContainer" style="display: none;">
          <div class="table-count" id="usersTableCount" style="display: none;">
            æ€»è®°å½•æ•°ï¼š<strong id="usersTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>ç”¨æˆ·å</th>
                <th>é‚®ç®±</th>
                <th>ä¸»é¢˜æ•°</th>
                <th>è®¢é˜…æ•°</th>
                <th>æ–‡ç« æ•°</th>
                <th>æ³¨å†Œæ—¶é—´</th>
                <th>ç®¡ç†å‘˜</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="usersBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- ä¸»é¢˜ç®¡ç†é¡µç­¾ -->
        <div id="tab-topics" class="tab-content">
          <div class="section">
            <h2>ä¸»é¢˜è¯ç®¡ç†</h2>
        <div id="topicsLoading" class="loading">åŠ è½½ä¸­...</div>
        <div class="table-container" id="topicsTableContainer" style="display: none;">
          <div class="table-count" id="topicsTableCount" style="display: none;">
            æ€»è®°å½•æ•°ï¼š<strong id="topicsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>ç”¨æˆ·ID</th>
                <th>ç”¨æˆ·å</th>
                <th>é‚®ç®±</th>
                <th>ä¸»é¢˜è¯</th>
                <th>æ–‡ç« æ•°</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="topicsBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- è®¢é˜…ç®¡ç†é¡µç­¾ -->
        <div id="tab-subscriptions" class="tab-content">
          <div class="section">
            <h2>è®¢é˜…ç®¡ç†</h2>
        <div id="subscriptionsLoading" class="loading">åŠ è½½ä¸­...</div>
        <div class="table-container" id="subscriptionsTableContainer" style="display: none;">
          <div class="table-count" id="subscriptionsTableCount" style="display: none;">
            æ€»è®°å½•æ•°ï¼š<strong id="subscriptionsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>ç”¨æˆ·ID</th>
                <th>ç”¨æˆ·å</th>
                <th>é‚®ç®±</th>
                <th>ä¿¡æ¯æºåç§°</th>
                <th>ä¿¡æ¯æºURL</th>
                <th>ç±»å‹</th>
                <th>åˆ†ç±»</th>
                <th>ä¸»é¢˜è¯</th>
                <th>è®¢é˜…æ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="subscriptionsBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- Nitterç®¡ç†é¡µç­¾ -->
        <div id="tab-nitter" class="tab-content">
          <!-- Nitterå®ä¾‹ç®¡ç† -->
          <div class="section">
            <h2>Nitterå®ä¾‹ç®¡ç†</h2>
            <p style="color: #666; margin-bottom: 15px;">
              Nitteræ˜¯Twitter/Xçš„å‰ç«¯æ›¿ä»£å·¥å…·ï¼Œå¯ä»¥å°†Twitterç”¨æˆ·è½¬æ¢ä¸ºRSSæºã€‚æ·»åŠ Nitterå®ä¾‹åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›å®ä¾‹æ¥æŠ“å–Twitter/Xæ¨æ–‡ã€‚
            </p>
            <div style="margin-bottom: 15px;">
              <button class="btn btn-primary" onclick="showAddNitterInstanceModal()">æ·»åŠ Nitterå®ä¾‹</button>
              <button class="btn btn-refresh" onclick="loadNitterInstances()">åˆ·æ–°åˆ—è¡¨</button>
            </div>
            <div id="nitterInstancesLoading" class="loading">åŠ è½½ä¸­...</div>
            <div class="table-container" id="nitterInstancesTableContainer" style="display: none;">
              <div class="table-count" id="nitterInstancesTableCount" style="display: none;">
                æ€»è®°å½•æ•°ï¼š<strong id="nitterInstancesTotalCount">0</strong>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>åç§°</th>
                    <th>URL</th>
                    <th>ä¼˜å…ˆçº§</th>
                    <th>çŠ¶æ€</th>
                    <th>æœ€åæ£€æŸ¥</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="nitterInstancesBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Nitterå®ä¾‹æŠ“å–çš„æ¨æ–‡ -->
          <div class="section" id="nitterTweetsSection" style="display: none;">
            <h2>æ¨æ–‡åˆ—è¡¨</h2>
            <div id="selectedInstanceInfo" class="nitter-instance-detail"></div>
            <div class="search-bar">
              <input 
                type="text" 
                id="nitterTweetSearch" 
                placeholder="æœç´¢æ¨æ–‡æ ‡é¢˜æˆ–å†…å®¹..." 
                onkeypress="if(event.key==='Enter') loadNitterTweets()"
              />
              <button class="btn btn-refresh" onclick="loadNitterTweets()">åˆ·æ–°</button>
              <button class="btn" onclick="clearNitterTweetsView()">è¿”å›å®ä¾‹åˆ—è¡¨</button>
            </div>
            <div id="nitterTweetsLoading" class="loading">åŠ è½½ä¸­...</div>
            <div class="table-container" id="nitterTweetsTableContainer" style="display: none;">
              <div class="table-count" id="nitterTweetsTableCount" style="display: none;">
                æ€»è®°å½•æ•°ï¼š<strong id="nitterTweetsTotalCount">0</strong>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>æ ‡é¢˜</th>
                    <th>æ¥æºç”¨æˆ·</th>
                    <th>æ‘˜è¦</th>
                    <th>å‘å¸ƒæ—¥æœŸ</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="nitterTweetsBody">
                </tbody>
              </table>
            </div>
            <div id="nitterTweetsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- æ–‡ç« ç®¡ç†é¡µç­¾ -->
        <div id="tab-news" class="tab-content">
          <div class="section">
            <h2>æ–‡ç« ç®¡ç†</h2>
        <div class="search-bar">
          <input 
            type="text" 
            id="newsSearchInput" 
            placeholder="æœç´¢æ–‡ç« æ ‡é¢˜ã€æ‘˜è¦æˆ–å†…å®¹..." 
            onkeypress="if(event.key==='Enter') loadNews(1)"
          />
          <select id="newsSourceFilter" onchange="loadNews(1)">
            <option value="">å…¨éƒ¨æ¥æº</option>
          </select>
          <button class="btn btn-refresh" onclick="loadNews(1)">åˆ·æ–°</button>
          <button class="btn btn-delete" onclick="deleteSelectedNews()" id="deleteSelectedBtn" style="display: none;">
            åˆ é™¤é€‰ä¸­
          </button>
          <button class="btn btn-delete" onclick="showDeleteAllNewsModal()">
            åˆ é™¤æ‰€æœ‰
          </button>
        </div>
        <div id="newsLoading" class="loading">åŠ è½½ä¸­...</div>
        <div class="table-container" id="newsTableContainer" style="display: none;">
          <div class="table-count" id="newsTableCount" style="display: none;">
            æ€»è®°å½•æ•°ï¼š<strong id="newsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell">
                  <input type="checkbox" id="selectAllNews" onchange="toggleSelectAllNews()">
                </th>
                <th>ID</th>
                <th>æ ‡é¢˜</th>
                <th>æ¥æº</th>
                <th>åˆ†ç±»</th>
                <th>ç”¨æˆ·ID</th>
                <th>ä¸»é¢˜è¯</th>
                <th>å‘å¸ƒæ—¥æœŸ</th>
                <th>åˆ›å»ºæ—¶é—´</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="newsBody">
            </tbody>
          </table>
        </div>
        <div id="newsPagination" class="pagination"></div>
          </div>
        </div>
      </div>

      <!-- åˆ é™¤æ‰€æœ‰æ–‡ç« æ¨¡æ€æ¡†ï¼ˆæ”¾åœ¨adminContentå†…éƒ¨ï¼Œç¡®ä¿ç™»å½•åæ‰å¯è§ï¼‰ -->
      <div id="deleteAllNewsModal" class="modal">
        <div class="modal-content">
          <h3>åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ–‡ç« </h3>
          <p style="margin-bottom: 15px; color: #666;">è¯·é€‰æ‹©è¦åˆ é™¤æ–‡ç« çš„ç”¨æˆ·ï¼š</p>
          <select id="deleteAllNewsUserSelect">
            <option value="">è¯·é€‰æ‹©ç”¨æˆ·...</option>
          </select>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeDeleteAllNewsModal()">å–æ¶ˆ</button>
            <button class="btn-confirm" onclick="confirmDeleteAllNews()">ç¡®è®¤åˆ é™¤</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API åŸºç¡€åœ°å€ï¼ˆç»Ÿä¸€éƒ¨ç½²ï¼Œå‰åç«¯åŒåŸŸï¼‰
    const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
    
    // åœ¨æ§åˆ¶å°è¾“å‡ºAPIåœ°å€ï¼Œæ–¹ä¾¿è°ƒè¯•
    console.log('[ç®¡ç†å‘˜é¡µé¢] APIåŸºç¡€åœ°å€:', API_BASE_URL);

    const ADMIN_TOKEN_KEY = 'admin_token';
    const ADMIN_TOKEN_EXPIRY_KEY = 'admin_token_expiry';
    const TOKEN_EXPIRY_HOURS = 24; // ä»¤ç‰Œæœ‰æ•ˆæœŸ24å°æ—¶
    
    let adminToken = '';
    let currentNewsPage = 1;
    const pageSize = 20;
    let selectedNewsIds = new Set();
    let currentNitterInstanceId = null;
    let currentNitterTweetsPage = 1;

    // åˆ‡æ¢é¡µç­¾
    function switchTab(tabName) {
      // æ›´æ–°é¡µç­¾æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // æ›´æ–°é¡µç­¾å†…å®¹æ˜¾ç¤º
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // æ˜¾ç¤ºé€‰ä¸­çš„é¡µç­¾å†…å®¹
      const targetTab = document.getElementById(`tab-${tabName}`);
      if (targetTab) {
        targetTab.classList.add('active');
        // æ‰¾åˆ°å¯¹åº”çš„æŒ‰é’®å¹¶æ¿€æ´»
        const buttons = document.querySelectorAll('.tab-button');
        const tabNames = ['overview', 'users', 'topics', 'subscriptions', 'nitter', 'news'];
        buttons.forEach((btn, index) => {
          if (tabNames[index] === tabName) {
            btn.classList.add('active');
          }
        });
      }
    }

    // ä¿å­˜ç®¡ç†å‘˜ä»¤ç‰Œåˆ° localStorage
    function saveAdminToken(token) {
      try {
        localStorage.setItem(ADMIN_TOKEN_KEY, token);
        // è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ24å°æ—¶åï¼‰
        const expiryTime = new Date().getTime() + (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);
        localStorage.setItem(ADMIN_TOKEN_EXPIRY_KEY, expiryTime.toString());
        console.log('[ç®¡ç†å‘˜é¡µé¢] ä»¤ç‰Œå·²ä¿å­˜åˆ° localStorage');
      } catch (error) {
        console.error('[ç®¡ç†å‘˜é¡µé¢] ä¿å­˜ä»¤ç‰Œå¤±è´¥:', error);
      }
    }

    // ä» localStorage åŠ è½½ç®¡ç†å‘˜ä»¤ç‰Œ
    function loadAdminToken() {
      try {
        const token = localStorage.getItem(ADMIN_TOKEN_KEY);
        const expiryTime = localStorage.getItem(ADMIN_TOKEN_EXPIRY_KEY);
        
        if (!token || !expiryTime) {
          return null;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        const now = new Date().getTime();
        const expiry = parseInt(expiryTime);
        if (now > expiry) {
          console.log('[ç®¡ç†å‘˜é¡µé¢] ä»¤ç‰Œå·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨');
          clearAdminToken();
          return null;
        }
        
        console.log('[ç®¡ç†å‘˜é¡µé¢] ä» localStorage åŠ è½½ä»¤ç‰Œ');
        return token;
      } catch (error) {
        console.error('[ç®¡ç†å‘˜é¡µé¢] åŠ è½½ä»¤ç‰Œå¤±è´¥:', error);
        return null;
      }
    }

    // æ¸…é™¤ç®¡ç†å‘˜ä»¤ç‰Œ
    function clearAdminToken() {
      try {
        localStorage.removeItem(ADMIN_TOKEN_KEY);
        localStorage.removeItem(ADMIN_TOKEN_EXPIRY_KEY);
        console.log('[ç®¡ç†å‘˜é¡µé¢] ä»¤ç‰Œå·²æ¸…é™¤');
      } catch (error) {
        console.error('[ç®¡ç†å‘˜é¡µé¢] æ¸…é™¤ä»¤ç‰Œå¤±è´¥:', error);
      }
    }

    // éªŒè¯ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
    async function validateAdminToken(token) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/stats`, {
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          cache: 'no-cache',
          mode: 'cors'
        });
        
        return response.ok;
      } catch (error) {
        console.error('[ç®¡ç†å‘˜é¡µé¢] éªŒè¯ä»¤ç‰Œå¤±è´¥:', error);
        return false;
      }
    }

    // ç®¡ç†å‘˜ç™»å½•
    async function authenticate() {
      const token = document.getElementById('adminToken').value.trim();
      if (!token) {
        showMessage('è¯·è¾“å…¥ç®¡ç†å‘˜ä»¤ç‰Œ', 'error');
        return;
      }
      
      // éªŒè¯ä»¤ç‰Œ
      const isValid = await validateAdminToken(token);
      if (!isValid) {
        showMessage('ç®¡ç†å‘˜ä»¤ç‰Œæ— æ•ˆï¼Œè¯·æ£€æŸ¥åé‡è¯•', 'error');
        return;
      }
      
      adminToken = token;
      saveAdminToken(token);
      
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      
      // æ˜¾ç¤ºç™»å‡ºæŒ‰é’®
      document.getElementById('logoutButtonContainer').style.display = 'block';
      
      // åŠ è½½æ‰€æœ‰æ•°æ®
      loadAllData();
    }

    // ç®¡ç†å‘˜ç™»å‡º
    function logout() {
      adminToken = '';
      clearAdminToken();
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('logoutButtonContainer').style.display = 'none';
      document.getElementById('adminToken').value = '';
      showMessage('å·²é€€å‡ºç™»å½•', 'success');
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶ç™»å½•
    async function autoLogin() {
      const savedToken = loadAdminToken();
      if (!savedToken) {
        console.log('[ç®¡ç†å‘˜é¡µé¢] æœªæ‰¾åˆ°ä¿å­˜çš„ä»¤ç‰Œï¼Œæ˜¾ç¤ºç™»å½•ç•Œé¢');
        return;
      }
      
      console.log('[ç®¡ç†å‘˜é¡µé¢] æ‰¾åˆ°ä¿å­˜çš„ä»¤ç‰Œï¼Œæ­£åœ¨éªŒè¯...');
      const isValid = await validateAdminToken(savedToken);
      
      if (isValid) {
        console.log('[ç®¡ç†å‘˜é¡µé¢] ä»¤ç‰Œæœ‰æ•ˆï¼Œè‡ªåŠ¨ç™»å½•');
        adminToken = savedToken;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        document.getElementById('logoutButtonContainer').style.display = 'block';
        loadAllData();
      } else {
        console.log('[ç®¡ç†å‘˜é¡µé¢] ä»¤ç‰Œæ— æ•ˆï¼Œæ¸…é™¤å¹¶æ˜¾ç¤ºç™»å½•ç•Œé¢');
        clearAdminToken();
        showMessage('ä¿å­˜çš„ç™»å½•å‡­è¯å·²å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•', 'error');
      }
    }

    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json',
        'X-Admin-Token': adminToken
      };
      console.log('[ç®¡ç†å‘˜é¡µé¢] è¯·æ±‚å¤´:', headers);
      return headers;
    }

    async function loadAllData() {
      try {
        console.log('[ç®¡ç†å‘˜é¡µé¢] å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...');
        console.log('[ç®¡ç†å‘˜é¡µé¢] APIåœ°å€:', API_BASE_URL);
        console.log('[ç®¡ç†å‘˜é¡µé¢] ç®¡ç†å‘˜ä»¤ç‰Œ:', adminToken ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
        
        // é¡ºåºåŠ è½½ï¼Œé¿å…å¹¶å‘è¯·æ±‚è¿‡å¤š
        await loadStats();
        await loadUsers();
        await loadTopics();
        await loadSubscriptions();
        await loadNewsSources();
        if (typeof loadNitterInstances === 'function') {
          await loadNitterInstances();
        }
        await loadNews(1);
        
        console.log('[ç®¡ç†å‘˜é¡µé¢] æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
        console.error('é”™è¯¯å †æ ˆ:', error.stack);
        showMessage('åŠ è½½æ•°æ®æ—¶å‡ºç°é”™è¯¯: ' + error.message, 'error');
      }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/stats`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥ - å“åº”:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          document.getElementById('totalCount').textContent = result.data.totalCount || 0;
          const lastUpdated = result.data.lastUpdated;
          document.getElementById('lastUpdated').textContent = lastUpdated 
            ? new Date(lastUpdated).toLocaleString('zh-CN')
            : '-';
        }
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
        // ç»Ÿè®¡ä¿¡æ¯å¤±è´¥ä¸å½±å“å…¶ä»–åŠŸèƒ½ï¼Œåªè®°å½•é”™è¯¯
        if (error.message.includes('Failed to fetch')) {
          console.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ');
        }
      }
    }

    async function loadUsers() {
      const loadingEl = document.getElementById('usersLoading');
      const containerEl = document.getElementById('usersTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥ - å“åº”:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const users = result.data || [];
          const tbody = document.getElementById('usersBody');
          tbody.innerHTML = '';
          
          // æ›´æ–°ç»Ÿè®¡
          document.getElementById('totalUsers').textContent = users.length;
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°
          document.getElementById('usersTotalCount').textContent = users.length;
          document.getElementById('usersTableCount').style.display = 'block';
          
          if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">æš‚æ— ç”¨æˆ·</td></tr>';
          } else {
            users.forEach(user => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${user.id}</td>
                <td>${escapeHtml(user.username)}</td>
                <td>${escapeHtml(user.email)}</td>
                <td>${user.topic_count || 0}</td>
                <td>${user.subscription_count || 0}</td>
                <td>${user.article_count || 0}</td>
                <td>${formatDate(user.created_at)}</td>
                <td>${user.is_admin ? 'æ˜¯' : 'å¦'}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteUserAllData(${user.id}, '${escapeHtml(user.username).replace(/'/g, "\\'")}')" title="åˆ é™¤ç”¨æˆ·æ‰€æœ‰æ•°æ®">
                    åˆ é™¤æ‰€æœ‰æ•°æ®
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          stack: error.stack,
          API_BASE_URL: API_BASE_URL,
          headers: getHeaders()
        });
        
        let errorMsg = 'åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message;
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMsg += '\n\nå¯èƒ½çš„åŸå› ï¼š\n1. åç«¯æœåŠ¡æœªè¿è¡Œæˆ–æ— æ³•è®¿é—®\n2. CORSé…ç½®é—®é¢˜\n3. ç½‘ç»œè¿æ¥é—®é¢˜\n\nè¯·æ£€æŸ¥ï¼š\n- åç«¯åœ°å€æ˜¯å¦æ­£ç¡®: ' + API_BASE_URL + '\n- æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚è¯¦æƒ…';
        }
        showMessage(errorMsg, 'error');
      }
    }

    async function loadTopics() {
      const loadingEl = document.getElementById('topicsLoading');
      const containerEl = document.getElementById('topicsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/topics`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('åŠ è½½ä¸»é¢˜è¯åˆ—è¡¨å¤±è´¥ - å“åº”:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const topics = result.data || [];
          const tbody = document.getElementById('topicsBody');
          tbody.innerHTML = '';
          
          // æ›´æ–°ç»Ÿè®¡
          document.getElementById('totalTopics').textContent = topics.length;
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°
          document.getElementById('topicsTotalCount').textContent = topics.length;
          document.getElementById('topicsTableCount').style.display = 'block';
          
          if (topics.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">æš‚æ— ä¸»é¢˜è¯</td></tr>';
          } else {
            topics.forEach(topic => {
              const row = document.createElement('tr');
              const createdDate = formatDate(topic.created_at);
              row.innerHTML = `
                <td>${topic.user_id}</td>
                <td>${escapeHtml(topic.username || '')}</td>
                <td>${escapeHtml(topic.email || '')}</td>
                <td><strong>${escapeHtml(topic.topic_keywords)}</strong></td>
                <td>${topic.article_count || 0}</td>
                <td>${createdDate}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteTopic(${topic.user_id}, '${escapeHtml(topic.topic_keywords).replace(/'/g, "\\'")}', ${topic.article_count || 0})" title="åˆ é™¤ä¸»é¢˜è¯">
                    åˆ é™¤
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || 'åŠ è½½ä¸»é¢˜è¯åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('åŠ è½½ä¸»é¢˜è¯åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½ä¸»é¢˜è¯åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function loadSubscriptions() {
      const loadingEl = document.getElementById('subscriptionsLoading');
      const containerEl = document.getElementById('subscriptionsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/subscriptions`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥ - å“åº”:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const subscriptions = result.data || [];
          const tbody = document.getElementById('subscriptionsBody');
          tbody.innerHTML = '';
          
          // æ›´æ–°ç»Ÿè®¡
          document.getElementById('totalSubscriptions').textContent = subscriptions.length;
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°
          document.getElementById('subscriptionsTotalCount').textContent = subscriptions.length;
          document.getElementById('subscriptionsTableCount').style.display = 'block';
          
          if (subscriptions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">æš‚æ— è®¢é˜…ä¿¡æ¯æº</td></tr>';
          } else {
            subscriptions.forEach(sub => {
              const row = document.createElement('tr');
              const createdDate = formatDate(sub.created_at);
              const topicKeywords = sub.topic_keywords || '';
              row.innerHTML = `
                <td>${sub.user_id}</td>
                <td>${escapeHtml(sub.username || '')}</td>
                <td>${escapeHtml(sub.email || '')}</td>
                <td><strong>${escapeHtml(sub.source_name || '')}</strong></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(sub.source_url || '')}">
                  ${escapeHtml(sub.source_url || '')}
                </td>
                <td>${escapeHtml(sub.source_type || 'æœªçŸ¥')}</td>
                <td>${escapeHtml(sub.category || 'æœªåˆ†ç±»')}</td>
                <td><strong>${escapeHtml(topicKeywords)}</strong></td>
                <td>${createdDate}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteSubscription(${sub.user_id}, '${escapeHtml(sub.source_name || '').replace(/'/g, "\\'")}', '${escapeHtml(topicKeywords).replace(/'/g, "\\'")}')" title="åˆ é™¤è®¢é˜…">
                    åˆ é™¤
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || 'åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½è®¢é˜…åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function loadNewsSources() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/sources`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          const sourceFilter = document.getElementById('newsSourceFilter');
          sourceFilter.innerHTML = '<option value="">å…¨éƒ¨æ¥æº</option>';
          
          result.data.forEach(source => {
            const option = document.createElement('option');
            option.value = source.source;
            option.textContent = `${escapeHtml(source.source)} (${source.count})`;
            sourceFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('åŠ è½½æ–°é—»æ¥æºåˆ—è¡¨å¤±è´¥:', error);
      }
    }

    async function loadNews(page = 1) {
      currentNewsPage = page;
      const loadingEl = document.getElementById('newsLoading');
      const containerEl = document.getElementById('newsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      const search = document.getElementById('newsSearchInput').value.trim();
      const source = document.getElementById('newsSourceFilter').value;
      
      try {
        const params = new URLSearchParams({
          page: currentNewsPage,
          pageSize: pageSize
        });
        if (search) params.append('search', search);
        if (source) params.append('source', source);
        
        const response = await fetch(`${API_BASE_URL}/admin/news?${params.toString()}`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const { news, totalCount, totalPages } = result.data;
          const tbody = document.getElementById('newsBody');
          tbody.innerHTML = '';
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°
          document.getElementById('newsTotalCount').textContent = totalCount || 0;
          document.getElementById('newsTableCount').style.display = 'block';
          
          if (news.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">æš‚æ— æ–°é—»</td></tr>';
          } else {
            news.forEach(item => {
              const row = document.createElement('tr');
              const isSelected = selectedNewsIds.has(item.id);
              row.innerHTML = `
                <td class="checkbox-cell">
                  <input type="checkbox" class="news-checkbox" value="${item.id}" ${isSelected ? 'checked' : ''} onchange="toggleNewsSelection(${item.id})">
                </td>
                <td>${item.id}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.title)}">
                  ${escapeHtml(item.title)}
                </td>
                <td>${escapeHtml(item.source || 'æœªçŸ¥')}</td>
                <td>${escapeHtml(item.category || 'æœªåˆ†ç±»')}</td>
                <td>${item.user_id || '-'}</td>
                <td>${escapeHtml(item.topic_keywords || '-')}</td>
                <td>${formatDate(item.publish_date)}</td>
                <td>${formatDate(item.created_at)}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteNews(${item.id})" title="åˆ é™¤æ–°é—»">åˆ é™¤</button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
          renderNewsPagination(totalPages);
          updateDeleteButton();
        } else {
          showMessage(result.message || 'åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½æ–°é—»åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
      }
    }

    function renderNewsPagination(totalPages) {
      const pagination = document.getElementById('newsPagination');
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn';
      prevBtn.textContent = 'ä¸Šä¸€é¡µ';
      prevBtn.disabled = currentNewsPage === 1;
      prevBtn.onclick = () => loadNews(currentNewsPage - 1);
      pagination.appendChild(prevBtn);
      
      const pageInfo = document.createElement('span');
      pageInfo.textContent = `ç¬¬ ${currentNewsPage} / ${totalPages} é¡µ`;
      pagination.appendChild(pageInfo);
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn';
      nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
      nextBtn.disabled = currentNewsPage === totalPages;
      nextBtn.onclick = () => loadNews(currentNewsPage + 1);
      pagination.appendChild(nextBtn);
    }

    function toggleNewsSelection(id) {
      if (selectedNewsIds.has(id)) {
        selectedNewsIds.delete(id);
      } else {
        selectedNewsIds.add(id);
      }
      updateDeleteButton();
    }

    function toggleSelectAllNews() {
      const selectAll = document.getElementById('selectAllNews');
      const checkboxes = document.querySelectorAll('.news-checkbox');
      
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        const id = parseInt(cb.value);
        if (selectAll.checked) {
          selectedNewsIds.add(id);
        } else {
          selectedNewsIds.delete(id);
        }
      });
      
      updateDeleteButton();
    }

    function updateDeleteButton() {
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      if (selectedNewsIds.size > 0) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = `åˆ é™¤é€‰ä¸­ (${selectedNewsIds.size})`;
      } else {
        deleteBtn.style.display = 'none';
      }
    }

    async function deleteNews(id) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news/${id}`, {
          method: 'DELETE',
          headers: getHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage('æ–°é—»åˆ é™¤æˆåŠŸ', 'success');
          selectedNewsIds.delete(id);
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤æ–°é—»å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function deleteSelectedNews() {
      if (selectedNewsIds.size === 0) {
        showMessage('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„æ–°é—»', 'error');
        return;
      }
      
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedNewsIds.size} æ¡æ–°é—»å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news`, {
          method: 'DELETE',
          headers: getHeaders(),
          body: JSON.stringify({ ids: Array.from(selectedNewsIds) })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(`å·²åˆ é™¤ ${result.deletedCount} æ¡æ–°é—»`, 'success');
          selectedNewsIds.clear();
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ‰¹é‡åˆ é™¤æ–°é—»å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function deleteTopic(userId, keywords, articleCount) {
      const deleteArticles = confirm(
        `ç¡®å®šè¦åˆ é™¤ä¸»é¢˜è¯ "${keywords}" å—ï¼Ÿ\n\n` +
        `è¯¥ä¸»é¢˜è¯å½“å‰æœ‰ ${articleCount} ç¯‡æ–‡ç« ã€‚\n\n` +
        `ç‚¹å‡»"ç¡®å®š"å°†åŒæ—¶åˆ é™¤è¯¥ä¸»é¢˜è¯çš„æ‰€æœ‰ä¿¡æ¯æºè®¢é˜…å’Œç›¸å…³æ–‡ç« ï¼Œ\n` +
        `ç‚¹å‡»"å–æ¶ˆ"åªåˆ é™¤ä¸»é¢˜è¯å’Œè®¢é˜…ï¼Œä¿ç•™æ–‡ç« ã€‚`
      );
      
      const confirmMessage = deleteArticles 
        ? `âš ï¸  æœ€åç¡®è®¤ï¼š\n\næ‚¨å³å°†åˆ é™¤ä¸»é¢˜è¯ "${keywords}" åŠå…¶ï¼š\n- æ‰€æœ‰ä¿¡æ¯æºè®¢é˜…\n- æ‰€æœ‰ ${articleCount} ç¯‡ç›¸å…³æ–‡ç« \n- æ¨èå†å²\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`
        : `âš ï¸  æœ€åç¡®è®¤ï¼š\n\næ‚¨å³å°†åˆ é™¤ä¸»é¢˜è¯ "${keywords}" åŠå…¶ï¼š\n- æ‰€æœ‰ä¿¡æ¯æºè®¢é˜…\n- æ¨èå†å²\n\næ–‡ç« å°†ä¿ç•™ã€‚\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/admin/topics/${userId}/${encodeURIComponent(keywords)}?deleteArticles=${deleteArticles}`,
          {
            method: 'DELETE',
            headers: getHeaders()
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || 'åˆ é™¤æˆåŠŸ', 'success');
          loadTopics();
          loadUsers();
          loadStats();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤ä¸»é¢˜è¯å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function deleteSubscription(userId, sourceName, topicKeywords) {
      const topicText = topicKeywords ? `ï¼ˆä¸»é¢˜: ${topicKeywords}ï¼‰` : '';
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ·è®¢é˜…ä¿¡æ¯æº "${sourceName}"${topicText} å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      try {
        let url = `${API_BASE_URL}/admin/subscriptions/${userId}/${encodeURIComponent(sourceName)}`;
        if (topicKeywords && topicKeywords.trim()) {
          url += `?topicKeywords=${encodeURIComponent(topicKeywords)}`;
        }
        
        const response = await fetch(url, {
          method: 'DELETE',
          headers: getHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || 'åˆ é™¤æˆåŠŸ', 'success');
          loadSubscriptions();
          loadUsers();
          loadStats();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤è®¢é˜…å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    async function deleteUserAllData(userId, username) {
      if (!confirm(`âš ï¸  è­¦å‘Šï¼šæ‚¨å³å°†åˆ é™¤ç”¨æˆ· "${username}" çš„æ‰€æœ‰æ•°æ®ï¼\n\nè¿™å°†åˆ é™¤ï¼š\n- è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¸»é¢˜è¯\n- è¯¥ç”¨æˆ·çš„æ‰€æœ‰ä¿¡æ¯æºè®¢é˜…\n- è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ–‡ç« \n- è¯¥ç”¨æˆ·çš„æ‰€æœ‰æ¨èå†å²\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
        return;
      }
      
      if (!confirm(`ğŸš¨ æœ€åç¡®è®¤ï¼š\n\næ‚¨ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œè¯·å†æ¬¡ç¡®è®¤ï¼`)) {
        return;
      }
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/admin/users/${userId}/all`,
          {
            method: 'DELETE',
            headers: getHeaders()
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || 'åˆ é™¤æˆåŠŸ', 'success');
          loadUsers();
          loadTopics();
          loadSubscriptions();
          loadStats();
          loadNews(1);
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type} show`;
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        return new Date(dateStr).toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== Nitterå®ä¾‹ç®¡ç† ==========
    
    async function loadNitterInstances() {
      const loadingEl = document.getElementById('nitterInstancesLoading');
      const containerEl = document.getElementById('nitterInstancesTableContainer');
      const bodyEl = document.getElementById('nitterInstancesBody');
      
      try {
        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances`, {
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          const instances = result.data || [];
          bodyEl.innerHTML = '';
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°
          document.getElementById('nitterInstancesTotalCount').textContent = instances.length;
          document.getElementById('nitterInstancesTableCount').style.display = 'block';
          
          if (instances.length === 0) {
            bodyEl.innerHTML = '<tr><td colspan="7" class="empty-state">æš‚æ— Nitterå®ä¾‹ï¼Œè¯·æ·»åŠ </td></tr>';
          } else {
            instances.forEach(instance => {
              const row = document.createElement('tr');
              const statusClass = instance.status === 'ok' ? 'status-ok' : 
                                 instance.status === 'error' ? 'status-error' : 'status-unknown';
              const statusText = instance.status === 'ok' ? 'æ­£å¸¸' : 
                                instance.status === 'error' ? 'é”™è¯¯' : 'æœªçŸ¥';
              const lastChecked = instance.last_checked 
                ? new Date(instance.last_checked).toLocaleString('zh-CN')
                : 'æœªæ£€æŸ¥';
              
              row.innerHTML = `
                <td>${instance.id}</td>
                <td>${instance.name || '-'}</td>
                <td><a href="${instance.url}" target="_blank">${instance.url}</a></td>
                <td>${instance.priority}</td>
                <td>
                  <span class="${statusClass}">${statusText}</span>
                  ${instance.is_active ? '<span style="color: green;">â—</span>' : '<span style="color: red;">â—</span>'}
                </td>
                <td>${lastChecked}</td>
                <td>
                  <button class="btn btn-small" onclick="testNitterInstance(${instance.id})">æµ‹è¯•</button>
                  <button class="btn btn-small" onclick="editNitterInstance(${instance.id})">ç¼–è¾‘</button>
                  <button class="btn btn-small btn-primary" onclick="viewNitterTweets(${instance.id}, '${escapeHtml(instance.name || '')}', '${escapeHtml(instance.url)}')">æŸ¥çœ‹æ¨æ–‡</button>
                  <button class="btn btn-small btn-delete" onclick="deleteNitterInstance(${instance.id})">åˆ é™¤</button>
                </td>
              `;
              bodyEl.appendChild(row);
            });
          }
          
          loadingEl.style.display = 'none';
          containerEl.style.display = 'block';
        }
      } catch (error) {
        console.error('åŠ è½½Nitterå®ä¾‹å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        showMessage('åŠ è½½Nitterå®ä¾‹å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    function showAddNitterInstanceModal() {
      const url = prompt('è¯·è¾“å…¥Nitterå®ä¾‹URLï¼ˆä¾‹å¦‚: https://nitter.netï¼‰:');
      if (!url || !url.trim()) return;
      
      const name = prompt('è¯·è¾“å…¥å®ä¾‹åç§°ï¼ˆå¯é€‰ï¼ŒæŒ‰å–æ¶ˆè·³è¿‡ï¼‰:') || null;
      const priorityStr = prompt('è¯·è¾“å…¥ä¼˜å…ˆçº§ï¼ˆæ•°å­—ï¼Œè¶Šå¤§è¶Šä¼˜å…ˆï¼Œé»˜è®¤0ï¼‰:') || '0';
      const priority = parseInt(priorityStr) || 0;
      
      addNitterInstance(url.trim(), name, priority);
    }
    
    async function addNitterInstance(url, name, priority) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ url, name, priority })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitterå®ä¾‹æ·»åŠ æˆåŠŸ', 'success');
          loadNitterInstances();
        } else {
          showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ·»åŠ Nitterå®ä¾‹å¤±è´¥:', error);
        showMessage('æ·»åŠ å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    async function testNitterInstance(id) {
      try {
        showMessage('æ­£åœ¨æµ‹è¯•Nitterå®ä¾‹...', 'info');
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}/test`, {
          method: 'POST',
          headers: getHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (result.available) {
            showMessage(`æµ‹è¯•æˆåŠŸ: ${result.message}`, 'success');
          } else {
            showMessage(`æµ‹è¯•å¤±è´¥: ${result.message}`, 'error');
          }
          loadNitterInstances();
        } else {
          showMessage(result.message || 'æµ‹è¯•å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æµ‹è¯•Nitterå®ä¾‹å¤±è´¥:', error);
        showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    function editNitterInstance(id) {
      const name = prompt('è¯·è¾“å…¥æ–°çš„å®ä¾‹åç§°ï¼ˆå¯é€‰ï¼ŒæŒ‰å–æ¶ˆè·³è¿‡ï¼‰:');
      if (name === null) return;
      
      const priorityStr = prompt('è¯·è¾“å…¥æ–°çš„ä¼˜å…ˆçº§ï¼ˆæ•°å­—ï¼Œè¶Šå¤§è¶Šä¼˜å…ˆï¼ŒæŒ‰å–æ¶ˆè·³è¿‡ï¼‰:');
      if (priorityStr === null) return;
      
      const priority = priorityStr ? parseInt(priorityStr) : undefined;
      const isActiveStr = prompt('æ˜¯å¦æ¿€æ´»ï¼Ÿ(true/falseï¼ŒæŒ‰å–æ¶ˆè·³è¿‡ï¼‰:');
      const is_active = isActiveStr ? isActiveStr.toLowerCase() === 'true' : undefined;
      
      updateNitterInstance(id, name || undefined, priority, is_active);
    }
    
    async function updateNitterInstance(id, name, priority, is_active) {
      try {
        const updateData = {};
        if (name !== undefined) updateData.name = name;
        if (priority !== undefined) updateData.priority = priority;
        if (is_active !== undefined) updateData.is_active = is_active;
        
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitterå®ä¾‹æ›´æ–°æˆåŠŸ', 'success');
          loadNitterInstances();
        } else {
          showMessage(result.message || 'æ›´æ–°å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æ›´æ–°Nitterå®ä¾‹å¤±è´¥:', error);
        showMessage('æ›´æ–°å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    async function deleteNitterInstance(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªNitterå®ä¾‹å—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}`, {
          method: 'DELETE',
          headers: getHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitterå®ä¾‹åˆ é™¤æˆåŠŸ', 'success');
          loadNitterInstances();
          if (currentNitterInstanceId === id) {
            clearNitterTweetsView();
          }
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤Nitterå®ä¾‹å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æŸ¥çœ‹Nitterå®ä¾‹æŠ“å–çš„æ¨æ–‡
    function viewNitterTweets(instanceId, instanceName, instanceUrl) {
      currentNitterInstanceId = instanceId;
      currentNitterTweetsPage = 1;
      
      // æ˜¾ç¤ºå®ä¾‹ä¿¡æ¯
      const infoEl = document.getElementById('selectedInstanceInfo');
      infoEl.innerHTML = `
        <h3>${instanceName || 'æœªå‘½åå®ä¾‹'}</h3>
        <p><strong>URL:</strong> <a href="${instanceUrl}" target="_blank">${instanceUrl}</a></p>
        <p>ä»¥ä¸‹æ˜¯é€šè¿‡NitteræŠ“å–çš„Twitter/Xæ¨æ–‡ï¼ˆæ³¨æ„ï¼šç”±äºæŠ€æœ¯é™åˆ¶ï¼Œæ— æ³•ç²¾ç¡®åŒºåˆ†æ˜¯å“ªä¸ªNitterå®ä¾‹æŠ“å–çš„ï¼Œè¿™é‡Œæ˜¾ç¤ºæ‰€æœ‰é€šè¿‡NitteræŠ“å–çš„æ¨æ–‡ï¼‰ï¼š</p>
      `;
      
      // æ˜¾ç¤ºæ¨æ–‡åˆ—è¡¨åŒºåŸŸï¼Œéšè—å®ä¾‹åˆ—è¡¨
      document.getElementById('nitterInstancesTableContainer').style.display = 'none';
      document.getElementById('nitterTweetsSection').style.display = 'block';
      
      // åŠ è½½æ¨æ–‡
      loadNitterTweets();
    }

    // æ¸…é™¤æ¨æ–‡è§†å›¾ï¼Œè¿”å›å®ä¾‹åˆ—è¡¨
    function clearNitterTweetsView() {
      currentNitterInstanceId = null;
      document.getElementById('nitterTweetsSection').style.display = 'none';
      document.getElementById('nitterInstancesTableContainer').style.display = 'block';
      document.getElementById('selectedInstanceInfo').innerHTML = '';
    }

    // åŠ è½½Nitterå®ä¾‹æŠ“å–çš„æ¨æ–‡
    async function loadNitterTweets(page = 1) {
      if (!currentNitterInstanceId) return;
      
      const loadingEl = document.getElementById('nitterTweetsLoading');
      const containerEl = document.getElementById('nitterTweetsTableContainer');
      const bodyEl = document.getElementById('nitterTweetsBody');
      const paginationEl = document.getElementById('nitterTweetsPagination');
      
      try {
        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        
        // è·å–å®ä¾‹ä¿¡æ¯
        const instanceResponse = await fetch(`${API_BASE_URL}/admin/nitter-instances/${currentNitterInstanceId}`, {
          headers: getHeaders()
        });
        const instanceResult = await instanceResponse.json();
        const instance = instanceResult.data;
        
        if (!instance) {
          throw new Error('æ— æ³•è·å–Nitterå®ä¾‹ä¿¡æ¯');
        }
        
        // æœç´¢æ‰€æœ‰Twitter/Xæ¨æ–‡ï¼ˆé€šè¿‡URLæ¨¡å¼è¯†åˆ«ï¼‰
        // æ³¨æ„ï¼šç”±äºæ¨æ–‡çš„sourceå­—æ®µå­˜å‚¨çš„æ˜¯Twitterç”¨æˆ·åï¼Œæ— æ³•ç›´æ¥åŒºåˆ†æ˜¯å“ªä¸ªNitterå®ä¾‹æŠ“å–çš„
        // è¿™é‡Œæ˜¾ç¤ºæ‰€æœ‰é€šè¿‡NitteræŠ“å–çš„æ¨æ–‡ï¼ˆURLåŒ…å«nitteråŸŸåæˆ–sourceä»¥@å¼€å¤´ï¼‰
        const searchKeyword = document.getElementById('nitterTweetSearch')?.value || '';
        let url = `${API_BASE_URL}/admin/news?page=${page}&pageSize=${pageSize}`;
        if (searchKeyword) {
          url += `&search=${encodeURIComponent(searchKeyword)}`;
        }
        
        const response = await fetch(url, {
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          // è¿‡æ»¤å‡ºTwitter/Xæ¨æ–‡ï¼ˆURLåŒ…å«nitterã€twitter.comæˆ–x.comï¼Œæˆ–sourceä»¥@å¼€å¤´ï¼‰
          let news = result.data.news || [];
          news = news.filter(article => {
            const url = (article.url || '').toLowerCase();
            const source = (article.source || '').trim();
            return url.includes('nitter') || 
                   url.includes('twitter.com') || 
                   url.includes('x.com') ||
                   source.startsWith('@') ||
                   source.includes('Twitter') ||
                   source.includes('X');
          });
          
          bodyEl.innerHTML = '';
          
          // æ›´æ–°è¡¨æ ¼æ€»è®°å½•æ•°ï¼ˆæ˜¾ç¤ºè¿‡æ»¤åçš„æ¨æ–‡æ•°é‡ï¼‰
          document.getElementById('nitterTweetsTotalCount').textContent = news.length;
          document.getElementById('nitterTweetsTableCount').style.display = 'block';
          
          if (news.length === 0) {
            bodyEl.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— æ¨æ–‡ï¼ˆæˆ–æ²¡æœ‰é€šè¿‡æ­¤Nitterå®ä¾‹æŠ“å–çš„æ¨æ–‡ï¼‰</td></tr>';
          } else {
            news.forEach(article => {
              const row = document.createElement('tr');
              const publishDate = formatDate(article.publish_date);
              const title = escapeHtml(article.title || 'æ— æ ‡é¢˜');
              const summary = escapeHtml((article.summary || '').substring(0, 100));
              
              // æå–Twitterç”¨æˆ·åï¼ˆä»æ¥æºä¸­æå–ï¼‰
              let twitterUser = article.source || '';
              if (twitterUser.startsWith('@')) {
                twitterUser = twitterUser;
              } else if (article.url) {
                // å°è¯•ä»URLæå–
                const match = article.url.match(/(?:twitter\.com|x\.com|nitter[^/]+)\/([a-zA-Z0-9_]+)/);
                if (match) {
                  twitterUser = '@' + match[1];
                }
              }
              
              row.innerHTML = `
                <td>${article.id}</td>
                <td><a href="/article.html?id=${article.id}" target="_blank">${title}</a></td>
                <td>${twitterUser}</td>
                <td>${summary}${article.summary && article.summary.length > 100 ? '...' : ''}</td>
                <td>${publishDate}</td>
                <td>
                  <button class="btn btn-delete btn-small" onclick="deleteNews(${article.id})">åˆ é™¤</button>
                </td>
              `;
              bodyEl.appendChild(row);
            });
          }
          
          // åˆ†é¡µ
          const totalPages = result.data.totalPages || 1;
          paginationEl.innerHTML = '';
          if (totalPages > 1) {
            paginationEl.innerHTML = `
              <button class="btn" onclick="loadNitterTweets(${page - 1})" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
              <span>ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${result.data.totalCount || 0} æ¡</span>
              <button class="btn" onclick="loadNitterTweets(${page + 1})" ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
            `;
          }
          
          loadingEl.style.display = 'none';
          containerEl.style.display = 'block';
          currentNitterTweetsPage = page;
        }
      } catch (error) {
        console.error('åŠ è½½æ¨æ–‡å¤±è´¥:', error);
        loadingEl.style.display = 'none';
        showMessage('åŠ è½½æ¨æ–‡å¤±è´¥: ' + error.message, 'error');
      }
    }

    // ========== åˆ é™¤æ‰€æœ‰æ–‡ç« åŠŸèƒ½ ==========
    
    // æ˜¾ç¤ºåˆ é™¤æ‰€æœ‰æ–‡ç« æ¨¡æ€æ¡†
    async function showDeleteAllNewsModal() {
      const modal = document.getElementById('deleteAllNewsModal');
      const select = document.getElementById('deleteAllNewsUserSelect');
      
      // åŠ è½½ç”¨æˆ·åˆ—è¡¨
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          const users = result.data || [];
          select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·...</option>';
          
          users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.username} (ID: ${user.id}, é‚®ç®±: ${user.email || 'æ— '})`;
            select.appendChild(option);
          });
        } else {
          showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
          return;
        }
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
        showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message, 'error');
        return;
      }
      
      modal.classList.add('show');
    }
    
    // å…³é—­åˆ é™¤æ‰€æœ‰æ–‡ç« æ¨¡æ€æ¡†
    function closeDeleteAllNewsModal() {
      const modal = document.getElementById('deleteAllNewsModal');
      modal.classList.remove('show');
      document.getElementById('deleteAllNewsUserSelect').value = '';
    }
    
    // ç¡®è®¤åˆ é™¤ç”¨æˆ·çš„æ‰€æœ‰æ–‡ç« 
    async function confirmDeleteAllNews() {
      const select = document.getElementById('deleteAllNewsUserSelect');
      const userId = parseInt(select.value);
      
      if (!userId || isNaN(userId)) {
        showMessage('è¯·é€‰æ‹©è¦åˆ é™¤æ–‡ç« çš„ç”¨æˆ·', 'error');
        return;
      }
      
      // è·å–ç”¨æˆ·ä¿¡æ¯ç”¨äºæ˜¾ç¤º
      const selectedOption = select.options[select.selectedIndex];
      const username = selectedOption.textContent.split('(')[0].trim();
      
      if (!confirm(`âš ï¸  è­¦å‘Šï¼šæ‚¨å³å°†åˆ é™¤ç”¨æˆ· "${username}" (ID: ${userId}) çš„æ‰€æœ‰æ–‡ç« ï¼\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news/user/${userId}`, {
          method: 'DELETE',
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || 'åˆ é™¤æˆåŠŸ', 'success');
          closeDeleteAllNewsModal();
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤ç”¨æˆ·æ‰€æœ‰æ–‡ç« å¤±è´¥:', error);
        showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
      const modal = document.getElementById('deleteAllNewsModal');
      if (event.target === modal) {
        closeDeleteAllNewsModal();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å°è¯•ç™»å½•
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[ç®¡ç†å‘˜é¡µé¢] é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ä¿å­˜çš„ç™»å½•å‡­è¯...');
      autoLogin();
    });
  </script>
</body>
</html>
