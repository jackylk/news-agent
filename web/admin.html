<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新闻管理后台</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }

    .auth-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      max-width: 400px;
    }

    .auth-section h3 {
      margin-bottom: 15px;
    }

    .auth-section input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .auth-section button {
      width: 100%;
      padding: 12px;
      background-color: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .auth-section button:hover {
      background-color: #5568d3;
    }

    .stats-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .section h2 {
      font-size: 20px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    table th,
    table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    table th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      position: sticky;
      top: 0;
    }

    table tr:hover {
      background-color: #f8f9fa;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.3s;
      margin-right: 5px;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #c82333;
    }

    .btn-refresh {
      background-color: #28a745;
      color: white;
    }

    .btn-refresh:hover {
      background-color: #218838;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .message {
      display: none;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
    }

    .message.show {
      display: block;
    }

    .message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }

    .search-bar input,
    .search-bar select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-bar input {
      flex: 1;
      min-width: 200px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 16px;
    }

    .pagination span {
      padding: 0 10px;
    }

    /* 页签样式 */
    .tabs {
      margin-bottom: 20px;
    }

    .tabs-header {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0;
    }

    .tab-button {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      color: #666;
      transition: all 0.3s;
      position: relative;
    }

    .tab-button:hover {
      background: #f8f9fa;
      color: #667eea;
    }

    .tab-button.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: #f8f9fa;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .checkbox-cell {
      width: 40px;
      text-align: center;
    }

    .status-ok {
      color: #28a745;
      font-weight: bold;
    }

    .status-error {
      color: #dc3545;
      font-weight: bold;
    }

    .status-unknown {
      color: #6c757d;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      margin: 0 2px;
    }

    /* 表格记录数显示 */
    .table-count {
      margin-bottom: 15px;
      padding: 10px 15px;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-size: 14px;
      color: #495057;
      border-left: 3px solid #667eea;
    }

    .table-count strong {
      color: #667eea;
      font-weight: 600;
    }

    /* 模态框样式 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow: auto;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-content h3 {
      margin-bottom: 20px;
      color: #333;
    }

    .modal-content select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      margin-bottom: 20px;
    }

    .modal-content .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .modal-content .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-content .modal-buttons .btn-confirm {
      background-color: #dc3545;
      color: white;
    }

    .modal-content .modal-buttons .btn-confirm:hover {
      background-color: #c82333;
    }

    .modal-content .modal-buttons .btn-cancel {
      background-color: #6c757d;
      color: white;
    }

    .modal-content .modal-buttons .btn-cancel:hover {
      background-color: #5a6268;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .header {
        padding: 16px;
      }

      .header h1 {
        font-size: 20px;
      }

      .header p {
        font-size: 13px;
      }

      .stats-section {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 16px;
      }

      .stat-value {
        font-size: 24px;
      }

      .section {
        padding: 16px;
      }

      .section h2 {
        font-size: 18px;
      }

      .tabs-header {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        gap: 0;
      }

      .tab-button {
        padding: 10px 14px;
        font-size: 13px;
        white-space: nowrap;
        min-height: 44px;
      }

      .search-bar {
        flex-direction: column;
      }

      .search-bar input,
      .search-bar select {
        width: 100%;
        min-width: unset;
        min-height: 44px;
      }

      .search-bar button {
        width: 100%;
        min-height: 44px;
      }

      .btn {
        padding: 10px 16px;
        font-size: 14px;
        min-height: 44px;
      }

      .btn-small {
        padding: 8px 12px;
        font-size: 13px;
        min-height: 40px;
      }

      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }

      table {
        font-size: 13px;
        min-width: 600px;
      }

      table th,
      table td {
        padding: 10px 8px;
      }

      .pagination button {
        min-height: 44px;
        padding: 10px 16px;
      }

      .auth-section {
        max-width: 100%;
        padding: 20px;
      }

      .auth-section input {
        min-height: 44px;
      }

      .auth-section button {
        min-height: 44px;
      }

      .modal-content {
        width: 95%;
        max-width: none;
        padding: 20px;
        margin: 16px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content select {
        min-height: 44px;
      }

      .modal-content .modal-buttons button {
        min-height: 44px;
        padding: 12px 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h1>新闻管理后台</h1>
          <p>管理系统用户、主题词、订阅和文章</p>
        </div>
        <div id="logoutButtonContainer" style="display: none;">
          <button class="btn" onclick="logout()" style="background-color: #6c757d; color: white;">
            退出登录
          </button>
        </div>
      </div>
    </div>

    <div class="auth-section" id="authSection">
      <h3>管理员认证</h3>
      <input 
        type="password" 
        id="adminToken" 
        placeholder="请输入管理员令牌" 
        onkeypress="if(event.key==='Enter') authenticate()"
      />
      <button onclick="authenticate()">登录</button>
    </div>

    <div id="adminContent" style="display: none;">
      <div class="message" id="message"></div>

      <!-- 统计信息 -->
      <div class="stats-section" id="statsSection">
        <div class="stat-item">
          <div class="stat-value" id="totalCount">-</div>
          <div class="stat-label">总新闻数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalUsers">-</div>
          <div class="stat-label">总用户数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalTopics">-</div>
          <div class="stat-label">总主题数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="totalSubscriptions">-</div>
          <div class="stat-label">总订阅数</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="lastUpdated">-</div>
          <div class="stat-label">最后更新</div>
        </div>
      </div>

      <!-- 页签导航 -->
      <div class="tabs">
        <div class="tabs-header">
          <button class="tab-button active" onclick="switchTab('overview')">概览</button>
          <button class="tab-button" onclick="switchTab('users')">用户管理</button>
          <button class="tab-button" onclick="switchTab('topics')">主题管理</button>
          <button class="tab-button" onclick="switchTab('subscriptions')">订阅管理</button>
          <button class="tab-button" onclick="switchTab('nitter')">Nitter管理</button>
          <button class="tab-button" onclick="switchTab('news')">文章管理</button>
        </div>

        <!-- 概览页签 -->
        <div id="tab-overview" class="tab-content active">
          <div class="section">
            <h2>系统概览</h2>
            <p>欢迎使用新闻管理后台。请使用上方页签导航到不同功能模块。</p>
          </div>
        </div>

        <!-- 用户管理页签 -->
        <div id="tab-users" class="tab-content">
          <div class="section">
            <h2>用户管理</h2>
        <div id="usersLoading" class="loading">加载中...</div>
        <div class="table-container" id="usersTableContainer" style="display: none;">
          <div class="table-count" id="usersTableCount" style="display: none;">
            总记录数：<strong id="usersTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>主题数</th>
                <th>订阅数</th>
                <th>文章数</th>
                <th>注册时间</th>
                <th>管理员</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="usersBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- 主题管理页签 -->
        <div id="tab-topics" class="tab-content">
          <div class="section">
            <h2>主题词管理</h2>
        <div id="topicsLoading" class="loading">加载中...</div>
        <div class="table-container" id="topicsTableContainer" style="display: none;">
          <div class="table-count" id="topicsTableCount" style="display: none;">
            总记录数：<strong id="topicsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>用户ID</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>主题词</th>
                <th>文章数</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="topicsBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- 订阅管理页签 -->
        <div id="tab-subscriptions" class="tab-content">
          <div class="section">
            <h2>订阅管理</h2>
        <div id="subscriptionsLoading" class="loading">加载中...</div>
        <div class="table-container" id="subscriptionsTableContainer" style="display: none;">
          <div class="table-count" id="subscriptionsTableCount" style="display: none;">
            总记录数：<strong id="subscriptionsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th>用户ID</th>
                <th>用户名</th>
                <th>邮箱</th>
                <th>信息源名称</th>
                <th>信息源URL</th>
                <th>类型</th>
                <th>分类</th>
                <th>主题词</th>
                <th>订阅时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="subscriptionsBody">
            </tbody>
          </table>
        </div>
          </div>
        </div>

        <!-- Nitter管理页签 -->
        <div id="tab-nitter" class="tab-content">
          <!-- Nitter实例管理 -->
          <div class="section">
            <h2>Nitter实例管理</h2>
            <p style="color: #666; margin-bottom: 15px;">
              Nitter是Twitter/X的前端替代工具，可以将Twitter用户转换为RSS源。添加Nitter实例后，系统会自动使用这些实例来抓取Twitter/X推文。
            </p>
            <div style="margin-bottom: 15px;">
              <button class="btn btn-primary" onclick="showAddNitterInstanceModal()">添加Nitter实例</button>
              <button class="btn btn-refresh" onclick="loadNitterInstances()">刷新列表</button>
            </div>
            <div id="nitterInstancesLoading" class="loading">加载中...</div>
            <div class="table-container" id="nitterInstancesTableContainer" style="display: none;">
              <div class="table-count" id="nitterInstancesTableCount" style="display: none;">
                总记录数：<strong id="nitterInstancesTotalCount">0</strong>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>名称</th>
                    <th>URL</th>
                    <th>优先级</th>
                    <th>状态</th>
                    <th>最后检查</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="nitterInstancesBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Nitter实例抓取的推文 -->
          <div class="section" id="nitterTweetsSection" style="display: none;">
            <h2>推文列表</h2>
            <div id="selectedInstanceInfo" class="nitter-instance-detail"></div>
            <div class="search-bar">
              <input 
                type="text" 
                id="nitterTweetSearch" 
                placeholder="搜索推文标题或内容..." 
                onkeypress="if(event.key==='Enter') loadNitterTweets()"
              />
              <button class="btn btn-refresh" onclick="loadNitterTweets()">刷新</button>
              <button class="btn" onclick="clearNitterTweetsView()">返回实例列表</button>
            </div>
            <div id="nitterTweetsLoading" class="loading">加载中...</div>
            <div class="table-container" id="nitterTweetsTableContainer" style="display: none;">
              <div class="table-count" id="nitterTweetsTableCount" style="display: none;">
                总记录数：<strong id="nitterTweetsTotalCount">0</strong>
              </div>
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>标题</th>
                    <th>来源用户</th>
                    <th>摘要</th>
                    <th>发布日期</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="nitterTweetsBody">
                </tbody>
              </table>
            </div>
            <div id="nitterTweetsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- 文章管理页签 -->
        <div id="tab-news" class="tab-content">
          <div class="section">
            <h2>文章管理</h2>
        <div class="search-bar">
          <input 
            type="text" 
            id="newsSearchInput" 
            placeholder="搜索文章标题、摘要或内容..." 
            onkeypress="if(event.key==='Enter') loadNews(1)"
          />
          <select id="newsSourceFilter" onchange="loadNews(1)">
            <option value="">全部来源</option>
          </select>
          <button class="btn btn-refresh" onclick="loadNews(1)">刷新</button>
          <button class="btn btn-delete" onclick="deleteSelectedNews()" id="deleteSelectedBtn" style="display: none;">
            删除选中
          </button>
          <button class="btn btn-delete" onclick="showDeleteAllNewsModal()">
            删除所有
          </button>
        </div>
        <div id="newsLoading" class="loading">加载中...</div>
        <div class="table-container" id="newsTableContainer" style="display: none;">
          <div class="table-count" id="newsTableCount" style="display: none;">
            总记录数：<strong id="newsTotalCount">0</strong>
          </div>
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell">
                  <input type="checkbox" id="selectAllNews" onchange="toggleSelectAllNews()">
                </th>
                <th>ID</th>
                <th>标题</th>
                <th>来源</th>
                <th>分类</th>
                <th>用户ID</th>
                <th>主题词</th>
                <th>发布日期</th>
                <th>创建时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="newsBody">
            </tbody>
          </table>
        </div>
        <div id="newsPagination" class="pagination"></div>
          </div>
        </div>
      </div>

      <!-- 删除所有文章模态框（放在adminContent内部，确保登录后才可见） -->
      <div id="deleteAllNewsModal" class="modal">
        <div class="modal-content">
          <h3>删除用户的所有文章</h3>
          <p style="margin-bottom: 15px; color: #666;">请选择要删除文章的用户：</p>
          <select id="deleteAllNewsUserSelect">
            <option value="">请选择用户...</option>
          </select>
          <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeDeleteAllNewsModal()">取消</button>
            <button class="btn-confirm" onclick="confirmDeleteAllNews()">确认删除</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // API 基础地址（统一部署，前后端同域）
    const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
    
    // 在控制台输出API地址，方便调试
    console.log('[管理员页面] API基础地址:', API_BASE_URL);

    const ADMIN_TOKEN_KEY = 'admin_token';
    const ADMIN_TOKEN_EXPIRY_KEY = 'admin_token_expiry';
    const TOKEN_EXPIRY_HOURS = 24; // 令牌有效期24小时
    
    let adminToken = '';
    let currentNewsPage = 1;
    const pageSize = 20;
    let selectedNewsIds = new Set();
    let currentNitterInstanceId = null;
    let currentNitterTweetsPage = 1;

    // 切换页签
    function switchTab(tabName) {
      // 更新页签按钮状态
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // 更新页签内容显示
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // 显示选中的页签内容
      const targetTab = document.getElementById(`tab-${tabName}`);
      if (targetTab) {
        targetTab.classList.add('active');
        // 找到对应的按钮并激活
        const buttons = document.querySelectorAll('.tab-button');
        const tabNames = ['overview', 'users', 'topics', 'subscriptions', 'nitter', 'news'];
        buttons.forEach((btn, index) => {
          if (tabNames[index] === tabName) {
            btn.classList.add('active');
          }
        });
      }
    }

    // 保存管理员令牌到 localStorage
    function saveAdminToken(token) {
      try {
        localStorage.setItem(ADMIN_TOKEN_KEY, token);
        // 设置过期时间（24小时后）
        const expiryTime = new Date().getTime() + (TOKEN_EXPIRY_HOURS * 60 * 60 * 1000);
        localStorage.setItem(ADMIN_TOKEN_EXPIRY_KEY, expiryTime.toString());
        console.log('[管理员页面] 令牌已保存到 localStorage');
      } catch (error) {
        console.error('[管理员页面] 保存令牌失败:', error);
      }
    }

    // 从 localStorage 加载管理员令牌
    function loadAdminToken() {
      try {
        const token = localStorage.getItem(ADMIN_TOKEN_KEY);
        const expiryTime = localStorage.getItem(ADMIN_TOKEN_EXPIRY_KEY);
        
        if (!token || !expiryTime) {
          return null;
        }
        
        // 检查是否过期
        const now = new Date().getTime();
        const expiry = parseInt(expiryTime);
        if (now > expiry) {
          console.log('[管理员页面] 令牌已过期，清除本地存储');
          clearAdminToken();
          return null;
        }
        
        console.log('[管理员页面] 从 localStorage 加载令牌');
        return token;
      } catch (error) {
        console.error('[管理员页面] 加载令牌失败:', error);
        return null;
      }
    }

    // 清除管理员令牌
    function clearAdminToken() {
      try {
        localStorage.removeItem(ADMIN_TOKEN_KEY);
        localStorage.removeItem(ADMIN_TOKEN_EXPIRY_KEY);
        console.log('[管理员页面] 令牌已清除');
      } catch (error) {
        console.error('[管理员页面] 清除令牌失败:', error);
      }
    }

    // 验证令牌是否有效
    async function validateAdminToken(token) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/stats`, {
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          cache: 'no-cache',
          mode: 'cors'
        });
        
        return response.ok;
      } catch (error) {
        console.error('[管理员页面] 验证令牌失败:', error);
        return false;
      }
    }

    // 管理员登录
    async function authenticate() {
      const token = document.getElementById('adminToken').value.trim();
      if (!token) {
        showMessage('请输入管理员令牌', 'error');
        return;
      }
      
      // 验证令牌
      const isValid = await validateAdminToken(token);
      if (!isValid) {
        showMessage('管理员令牌无效，请检查后重试', 'error');
        return;
      }
      
      adminToken = token;
      saveAdminToken(token);
      
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      
      // 显示登出按钮
      document.getElementById('logoutButtonContainer').style.display = 'block';
      
      // 加载所有数据
      loadAllData();
    }

    // 管理员登出
    function logout() {
      adminToken = '';
      clearAdminToken();
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('adminContent').style.display = 'none';
      document.getElementById('logoutButtonContainer').style.display = 'none';
      document.getElementById('adminToken').value = '';
      showMessage('已退出登录', 'success');
    }

    // 页面加载时自动检查并登录
    async function autoLogin() {
      const savedToken = loadAdminToken();
      if (!savedToken) {
        console.log('[管理员页面] 未找到保存的令牌，显示登录界面');
        return;
      }
      
      console.log('[管理员页面] 找到保存的令牌，正在验证...');
      const isValid = await validateAdminToken(savedToken);
      
      if (isValid) {
        console.log('[管理员页面] 令牌有效，自动登录');
        adminToken = savedToken;
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('adminContent').style.display = 'block';
        document.getElementById('logoutButtonContainer').style.display = 'block';
        loadAllData();
      } else {
        console.log('[管理员页面] 令牌无效，清除并显示登录界面');
        clearAdminToken();
        showMessage('保存的登录凭证已失效，请重新登录', 'error');
      }
    }

    function getHeaders() {
      const headers = {
        'Content-Type': 'application/json',
        'X-Admin-Token': adminToken
      };
      console.log('[管理员页面] 请求头:', headers);
      return headers;
    }

    async function loadAllData() {
      try {
        console.log('[管理员页面] 开始加载所有数据...');
        console.log('[管理员页面] API地址:', API_BASE_URL);
        console.log('[管理员页面] 管理员令牌:', adminToken ? '已设置' : '未设置');
        
        // 顺序加载，避免并发请求过多
        await loadStats();
        await loadUsers();
        await loadTopics();
        await loadSubscriptions();
        await loadNewsSources();
        if (typeof loadNitterInstances === 'function') {
          await loadNitterInstances();
        }
        await loadNews(1);
        
        console.log('[管理员页面] 所有数据加载完成');
      } catch (error) {
        console.error('加载数据失败:', error);
        console.error('错误堆栈:', error.stack);
        showMessage('加载数据时出现错误: ' + error.message, 'error');
      }
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/stats`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('加载统计信息失败 - 响应:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          document.getElementById('totalCount').textContent = result.data.totalCount || 0;
          const lastUpdated = result.data.lastUpdated;
          document.getElementById('lastUpdated').textContent = lastUpdated 
            ? new Date(lastUpdated).toLocaleString('zh-CN')
            : '-';
        }
      } catch (error) {
        console.error('加载统计信息失败:', error);
        // 统计信息失败不影响其他功能，只记录错误
        if (error.message.includes('Failed to fetch')) {
          console.error('网络请求失败，请检查后端服务是否运行');
        }
      }
    }

    async function loadUsers() {
      const loadingEl = document.getElementById('usersLoading');
      const containerEl = document.getElementById('usersTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('加载用户列表失败 - 响应:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const users = result.data || [];
          const tbody = document.getElementById('usersBody');
          tbody.innerHTML = '';
          
          // 更新统计
          document.getElementById('totalUsers').textContent = users.length;
          
          // 更新表格总记录数
          document.getElementById('usersTotalCount').textContent = users.length;
          document.getElementById('usersTableCount').style.display = 'block';
          
          if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: #999;">暂无用户</td></tr>';
          } else {
            users.forEach(user => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${user.id}</td>
                <td>${escapeHtml(user.username)}</td>
                <td>${escapeHtml(user.email)}</td>
                <td>${user.topic_count || 0}</td>
                <td>${user.subscription_count || 0}</td>
                <td>${user.article_count || 0}</td>
                <td>${formatDate(user.created_at)}</td>
                <td>${user.is_admin ? '是' : '否'}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteUserAllData(${user.id}, '${escapeHtml(user.username).replace(/'/g, "\\'")}')" title="删除用户所有数据">
                    删除所有数据
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || '加载用户列表失败', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('加载用户列表失败:', error);
        console.error('错误详情:', {
          message: error.message,
          stack: error.stack,
          API_BASE_URL: API_BASE_URL,
          headers: getHeaders()
        });
        
        let errorMsg = '加载用户列表失败: ' + error.message;
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          errorMsg += '\n\n可能的原因：\n1. 后端服务未运行或无法访问\n2. CORS配置问题\n3. 网络连接问题\n\n请检查：\n- 后端地址是否正确: ' + API_BASE_URL + '\n- 浏览器控制台的网络请求详情';
        }
        showMessage(errorMsg, 'error');
      }
    }

    async function loadTopics() {
      const loadingEl = document.getElementById('topicsLoading');
      const containerEl = document.getElementById('topicsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/topics`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('加载主题词列表失败 - 响应:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const topics = result.data || [];
          const tbody = document.getElementById('topicsBody');
          tbody.innerHTML = '';
          
          // 更新统计
          document.getElementById('totalTopics').textContent = topics.length;
          
          // 更新表格总记录数
          document.getElementById('topicsTotalCount').textContent = topics.length;
          document.getElementById('topicsTableCount').style.display = 'block';
          
          if (topics.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">暂无主题词</td></tr>';
          } else {
            topics.forEach(topic => {
              const row = document.createElement('tr');
              const createdDate = formatDate(topic.created_at);
              row.innerHTML = `
                <td>${topic.user_id}</td>
                <td>${escapeHtml(topic.username || '')}</td>
                <td>${escapeHtml(topic.email || '')}</td>
                <td><strong>${escapeHtml(topic.topic_keywords)}</strong></td>
                <td>${topic.article_count || 0}</td>
                <td>${createdDate}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteTopic(${topic.user_id}, '${escapeHtml(topic.topic_keywords).replace(/'/g, "\\'")}', ${topic.article_count || 0})" title="删除主题词">
                    删除
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || '加载主题词列表失败', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('加载主题词列表失败:', error);
        showMessage('加载主题词列表失败: ' + error.message, 'error');
      }
    }

    async function loadSubscriptions() {
      const loadingEl = document.getElementById('subscriptionsLoading');
      const containerEl = document.getElementById('subscriptionsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/subscriptions`, {
          headers: getHeaders(),
          cache: 'no-cache',
          mode: 'cors'
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('加载订阅列表失败 - 响应:', response.status, errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText || errorText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const subscriptions = result.data || [];
          const tbody = document.getElementById('subscriptionsBody');
          tbody.innerHTML = '';
          
          // 更新统计
          document.getElementById('totalSubscriptions').textContent = subscriptions.length;
          
          // 更新表格总记录数
          document.getElementById('subscriptionsTotalCount').textContent = subscriptions.length;
          document.getElementById('subscriptionsTableCount').style.display = 'block';
          
          if (subscriptions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">暂无订阅信息源</td></tr>';
          } else {
            subscriptions.forEach(sub => {
              const row = document.createElement('tr');
              const createdDate = formatDate(sub.created_at);
              const topicKeywords = sub.topic_keywords || '';
              row.innerHTML = `
                <td>${sub.user_id}</td>
                <td>${escapeHtml(sub.username || '')}</td>
                <td>${escapeHtml(sub.email || '')}</td>
                <td><strong>${escapeHtml(sub.source_name || '')}</strong></td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(sub.source_url || '')}">
                  ${escapeHtml(sub.source_url || '')}
                </td>
                <td>${escapeHtml(sub.source_type || '未知')}</td>
                <td>${escapeHtml(sub.category || '未分类')}</td>
                <td><strong>${escapeHtml(topicKeywords)}</strong></td>
                <td>${createdDate}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteSubscription(${sub.user_id}, '${escapeHtml(sub.source_name || '').replace(/'/g, "\\'")}', '${escapeHtml(topicKeywords).replace(/'/g, "\\'")}')" title="删除订阅">
                    删除
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
        } else {
          showMessage(result.message || '加载订阅列表失败', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('加载订阅列表失败:', error);
        showMessage('加载订阅列表失败: ' + error.message, 'error');
      }
    }

    async function loadNewsSources() {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/sources`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          const sourceFilter = document.getElementById('newsSourceFilter');
          sourceFilter.innerHTML = '<option value="">全部来源</option>';
          
          result.data.forEach(source => {
            const option = document.createElement('option');
            option.value = source.source;
            option.textContent = `${escapeHtml(source.source)} (${source.count})`;
            sourceFilter.appendChild(option);
          });
        }
      } catch (error) {
        console.error('加载新闻来源列表失败:', error);
      }
    }

    async function loadNews(page = 1) {
      currentNewsPage = page;
      const loadingEl = document.getElementById('newsLoading');
      const containerEl = document.getElementById('newsTableContainer');
      
      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      
      const search = document.getElementById('newsSearchInput').value.trim();
      const source = document.getElementById('newsSourceFilter').value;
      
      try {
        const params = new URLSearchParams({
          page: currentNewsPage,
          pageSize: pageSize
        });
        if (search) params.append('search', search);
        if (source) params.append('source', source);
        
        const response = await fetch(`${API_BASE_URL}/admin/news?${params.toString()}`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        loadingEl.style.display = 'none';
        
        if (result.success) {
          const { news, totalCount, totalPages } = result.data;
          const tbody = document.getElementById('newsBody');
          tbody.innerHTML = '';
          
          // 更新表格总记录数
          document.getElementById('newsTotalCount').textContent = totalCount || 0;
          document.getElementById('newsTableCount').style.display = 'block';
          
          if (news.length === 0) {
            tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">暂无新闻</td></tr>';
          } else {
            news.forEach(item => {
              const row = document.createElement('tr');
              const isSelected = selectedNewsIds.has(item.id);
              row.innerHTML = `
                <td class="checkbox-cell">
                  <input type="checkbox" class="news-checkbox" value="${item.id}" ${isSelected ? 'checked' : ''} onchange="toggleNewsSelection(${item.id})">
                </td>
                <td>${item.id}</td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(item.title)}">
                  ${escapeHtml(item.title)}
                </td>
                <td>${escapeHtml(item.source || '未知')}</td>
                <td>${escapeHtml(item.category || '未分类')}</td>
                <td>${item.user_id || '-'}</td>
                <td>${escapeHtml(item.topic_keywords || '-')}</td>
                <td>${formatDate(item.publish_date)}</td>
                <td>${formatDate(item.created_at)}</td>
                <td>
                  <button class="btn btn-delete" onclick="deleteNews(${item.id})" title="删除新闻">删除</button>
                </td>
              `;
              tbody.appendChild(row);
            });
          }
          
          containerEl.style.display = 'block';
          renderNewsPagination(totalPages);
          updateDeleteButton();
        } else {
          showMessage(result.message || '加载新闻列表失败', 'error');
        }
      } catch (error) {
        loadingEl.style.display = 'none';
        console.error('加载新闻列表失败:', error);
        showMessage('加载新闻列表失败: ' + error.message, 'error');
      }
    }

    function renderNewsPagination(totalPages) {
      const pagination = document.getElementById('newsPagination');
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      const prevBtn = document.createElement('button');
      prevBtn.className = 'btn';
      prevBtn.textContent = '上一页';
      prevBtn.disabled = currentNewsPage === 1;
      prevBtn.onclick = () => loadNews(currentNewsPage - 1);
      pagination.appendChild(prevBtn);
      
      const pageInfo = document.createElement('span');
      pageInfo.textContent = `第 ${currentNewsPage} / ${totalPages} 页`;
      pagination.appendChild(pageInfo);
      
      const nextBtn = document.createElement('button');
      nextBtn.className = 'btn';
      nextBtn.textContent = '下一页';
      nextBtn.disabled = currentNewsPage === totalPages;
      nextBtn.onclick = () => loadNews(currentNewsPage + 1);
      pagination.appendChild(nextBtn);
    }

    function toggleNewsSelection(id) {
      if (selectedNewsIds.has(id)) {
        selectedNewsIds.delete(id);
      } else {
        selectedNewsIds.add(id);
      }
      updateDeleteButton();
    }

    function toggleSelectAllNews() {
      const selectAll = document.getElementById('selectAllNews');
      const checkboxes = document.querySelectorAll('.news-checkbox');
      
      checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
        const id = parseInt(cb.value);
        if (selectAll.checked) {
          selectedNewsIds.add(id);
        } else {
          selectedNewsIds.delete(id);
        }
      });
      
      updateDeleteButton();
    }

    function updateDeleteButton() {
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      if (selectedNewsIds.size > 0) {
        deleteBtn.style.display = 'inline-block';
        deleteBtn.textContent = `删除选中 (${selectedNewsIds.size})`;
      } else {
        deleteBtn.style.display = 'none';
      }
    }

    async function deleteNews(id) {
      if (!confirm(`确定要删除这条新闻吗？此操作不可恢复！`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news/${id}`, {
          method: 'DELETE',
          headers: getHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage('新闻删除成功', 'success');
          selectedNewsIds.delete(id);
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除新闻失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    async function deleteSelectedNews() {
      if (selectedNewsIds.size === 0) {
        showMessage('请先选择要删除的新闻', 'error');
        return;
      }
      
      if (!confirm(`确定要删除选中的 ${selectedNewsIds.size} 条新闻吗？此操作不可恢复！`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news`, {
          method: 'DELETE',
          headers: getHeaders(),
          body: JSON.stringify({ ids: Array.from(selectedNewsIds) })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(`已删除 ${result.deletedCount} 条新闻`, 'success');
          selectedNewsIds.clear();
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('批量删除新闻失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    async function deleteTopic(userId, keywords, articleCount) {
      const deleteArticles = confirm(
        `确定要删除主题词 "${keywords}" 吗？\n\n` +
        `该主题词当前有 ${articleCount} 篇文章。\n\n` +
        `点击"确定"将同时删除该主题词的所有信息源订阅和相关文章，\n` +
        `点击"取消"只删除主题词和订阅，保留文章。`
      );
      
      const confirmMessage = deleteArticles 
        ? `⚠️  最后确认：\n\n您即将删除主题词 "${keywords}" 及其：\n- 所有信息源订阅\n- 所有 ${articleCount} 篇相关文章\n- 推荐历史\n\n此操作不可恢复！`
        : `⚠️  最后确认：\n\n您即将删除主题词 "${keywords}" 及其：\n- 所有信息源订阅\n- 推荐历史\n\n文章将保留。\n\n此操作不可恢复！`;
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/admin/topics/${userId}/${encodeURIComponent(keywords)}?deleteArticles=${deleteArticles}`,
          {
            method: 'DELETE',
            headers: getHeaders()
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || '删除成功', 'success');
          loadTopics();
          loadUsers();
          loadStats();
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除主题词失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    async function deleteSubscription(userId, sourceName, topicKeywords) {
      const topicText = topicKeywords ? `（主题: ${topicKeywords}）` : '';
      if (!confirm(`确定要删除用户订阅信息源 "${sourceName}"${topicText} 吗？\n\n此操作不可恢复！`)) {
        return;
      }
      
      try {
        let url = `${API_BASE_URL}/admin/subscriptions/${userId}/${encodeURIComponent(sourceName)}`;
        if (topicKeywords && topicKeywords.trim()) {
          url += `?topicKeywords=${encodeURIComponent(topicKeywords)}`;
        }
        
        const response = await fetch(url, {
          method: 'DELETE',
          headers: getHeaders()
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || '删除成功', 'success');
          loadSubscriptions();
          loadUsers();
          loadStats();
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除订阅失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    async function deleteUserAllData(userId, username) {
      if (!confirm(`⚠️  警告：您即将删除用户 "${username}" 的所有数据！\n\n这将删除：\n- 该用户的所有主题词\n- 该用户的所有信息源订阅\n- 该用户的所有文章\n- 该用户的所有推荐历史\n\n此操作不可恢复！`)) {
        return;
      }
      
      if (!confirm(`🚨 最后确认：\n\n您确定要删除用户 "${username}" 的所有数据吗？\n\n此操作不可恢复，请再次确认！`)) {
        return;
      }
      
      try {
        const response = await fetch(
          `${API_BASE_URL}/admin/users/${userId}/all`,
          {
            method: 'DELETE',
            headers: getHeaders()
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || '删除成功', 'success');
          loadUsers();
          loadTopics();
          loadSubscriptions();
          loadStats();
          loadNews(1);
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除用户数据失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    function showMessage(text, type) {
      const messageEl = document.getElementById('message');
      messageEl.textContent = text;
      messageEl.className = `message ${type} show`;
      
      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 5000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      try {
        return new Date(dateStr).toLocaleString('zh-CN');
      } catch (e) {
        return dateStr;
      }
    }

    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== Nitter实例管理 ==========
    
    async function loadNitterInstances() {
      const loadingEl = document.getElementById('nitterInstancesLoading');
      const containerEl = document.getElementById('nitterInstancesTableContainer');
      const bodyEl = document.getElementById('nitterInstancesBody');
      
      try {
        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances`, {
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          const instances = result.data || [];
          bodyEl.innerHTML = '';
          
          // 更新表格总记录数
          document.getElementById('nitterInstancesTotalCount').textContent = instances.length;
          document.getElementById('nitterInstancesTableCount').style.display = 'block';
          
          if (instances.length === 0) {
            bodyEl.innerHTML = '<tr><td colspan="7" class="empty-state">暂无Nitter实例，请添加</td></tr>';
          } else {
            instances.forEach(instance => {
              const row = document.createElement('tr');
              const statusClass = instance.status === 'ok' ? 'status-ok' : 
                                 instance.status === 'error' ? 'status-error' : 'status-unknown';
              const statusText = instance.status === 'ok' ? '正常' : 
                                instance.status === 'error' ? '错误' : '未知';
              const lastChecked = instance.last_checked 
                ? new Date(instance.last_checked).toLocaleString('zh-CN')
                : '未检查';
              
              row.innerHTML = `
                <td>${instance.id}</td>
                <td>${instance.name || '-'}</td>
                <td><a href="${instance.url}" target="_blank">${instance.url}</a></td>
                <td>${instance.priority}</td>
                <td>
                  <span class="${statusClass}">${statusText}</span>
                  ${instance.is_active ? '<span style="color: green;">●</span>' : '<span style="color: red;">●</span>'}
                </td>
                <td>${lastChecked}</td>
                <td>
                  <button class="btn btn-small" onclick="testNitterInstance(${instance.id})">测试</button>
                  <button class="btn btn-small" onclick="editNitterInstance(${instance.id})">编辑</button>
                  <button class="btn btn-small btn-primary" onclick="viewNitterTweets(${instance.id}, '${escapeHtml(instance.name || '')}', '${escapeHtml(instance.url)}')">查看推文</button>
                  <button class="btn btn-small btn-delete" onclick="deleteNitterInstance(${instance.id})">删除</button>
                </td>
              `;
              bodyEl.appendChild(row);
            });
          }
          
          loadingEl.style.display = 'none';
          containerEl.style.display = 'block';
        }
      } catch (error) {
        console.error('加载Nitter实例失败:', error);
        loadingEl.style.display = 'none';
        showMessage('加载Nitter实例失败: ' + error.message, 'error');
      }
    }
    
    function showAddNitterInstanceModal() {
      const url = prompt('请输入Nitter实例URL（例如: https://nitter.net）:');
      if (!url || !url.trim()) return;
      
      const name = prompt('请输入实例名称（可选，按取消跳过）:') || null;
      const priorityStr = prompt('请输入优先级（数字，越大越优先，默认0）:') || '0';
      const priority = parseInt(priorityStr) || 0;
      
      addNitterInstance(url.trim(), name, priority);
    }
    
    async function addNitterInstance(url, name, priority) {
      try {
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ url, name, priority })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitter实例添加成功', 'success');
          loadNitterInstances();
        } else {
          showMessage(result.message || '添加失败', 'error');
        }
      } catch (error) {
        console.error('添加Nitter实例失败:', error);
        showMessage('添加失败: ' + error.message, 'error');
      }
    }
    
    async function testNitterInstance(id) {
      try {
        showMessage('正在测试Nitter实例...', 'info');
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}/test`, {
          method: 'POST',
          headers: getHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          if (result.available) {
            showMessage(`测试成功: ${result.message}`, 'success');
          } else {
            showMessage(`测试失败: ${result.message}`, 'error');
          }
          loadNitterInstances();
        } else {
          showMessage(result.message || '测试失败', 'error');
        }
      } catch (error) {
        console.error('测试Nitter实例失败:', error);
        showMessage('测试失败: ' + error.message, 'error');
      }
    }
    
    function editNitterInstance(id) {
      const name = prompt('请输入新的实例名称（可选，按取消跳过）:');
      if (name === null) return;
      
      const priorityStr = prompt('请输入新的优先级（数字，越大越优先，按取消跳过）:');
      if (priorityStr === null) return;
      
      const priority = priorityStr ? parseInt(priorityStr) : undefined;
      const isActiveStr = prompt('是否激活？(true/false，按取消跳过）:');
      const is_active = isActiveStr ? isActiveStr.toLowerCase() === 'true' : undefined;
      
      updateNitterInstance(id, name || undefined, priority, is_active);
    }
    
    async function updateNitterInstance(id, name, priority, is_active) {
      try {
        const updateData = {};
        if (name !== undefined) updateData.name = name;
        if (priority !== undefined) updateData.priority = priority;
        if (is_active !== undefined) updateData.is_active = is_active;
        
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}`, {
          method: 'PUT',
          headers: getHeaders(),
          body: JSON.stringify(updateData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitter实例更新成功', 'success');
          loadNitterInstances();
        } else {
          showMessage(result.message || '更新失败', 'error');
        }
      } catch (error) {
        console.error('更新Nitter实例失败:', error);
        showMessage('更新失败: ' + error.message, 'error');
      }
    }
    
    async function deleteNitterInstance(id) {
      if (!confirm('确定要删除这个Nitter实例吗？')) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/nitter-instances/${id}`, {
          method: 'DELETE',
          headers: getHeaders()
        });
        
        const result = await response.json();
        
        if (result.success) {
          showMessage('Nitter实例删除成功', 'success');
          loadNitterInstances();
          if (currentNitterInstanceId === id) {
            clearNitterTweetsView();
          }
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除Nitter实例失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }

    // 查看Nitter实例抓取的推文
    function viewNitterTweets(instanceId, instanceName, instanceUrl) {
      currentNitterInstanceId = instanceId;
      currentNitterTweetsPage = 1;
      
      // 显示实例信息
      const infoEl = document.getElementById('selectedInstanceInfo');
      infoEl.innerHTML = `
        <h3>${instanceName || '未命名实例'}</h3>
        <p><strong>URL:</strong> <a href="${instanceUrl}" target="_blank">${instanceUrl}</a></p>
        <p>以下是通过Nitter抓取的Twitter/X推文（注意：由于技术限制，无法精确区分是哪个Nitter实例抓取的，这里显示所有通过Nitter抓取的推文）：</p>
      `;
      
      // 显示推文列表区域，隐藏实例列表
      document.getElementById('nitterInstancesTableContainer').style.display = 'none';
      document.getElementById('nitterTweetsSection').style.display = 'block';
      
      // 加载推文
      loadNitterTweets();
    }

    // 清除推文视图，返回实例列表
    function clearNitterTweetsView() {
      currentNitterInstanceId = null;
      document.getElementById('nitterTweetsSection').style.display = 'none';
      document.getElementById('nitterInstancesTableContainer').style.display = 'block';
      document.getElementById('selectedInstanceInfo').innerHTML = '';
    }

    // 加载Nitter实例抓取的推文
    async function loadNitterTweets(page = 1) {
      if (!currentNitterInstanceId) return;
      
      const loadingEl = document.getElementById('nitterTweetsLoading');
      const containerEl = document.getElementById('nitterTweetsTableContainer');
      const bodyEl = document.getElementById('nitterTweetsBody');
      const paginationEl = document.getElementById('nitterTweetsPagination');
      
      try {
        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        
        // 获取实例信息
        const instanceResponse = await fetch(`${API_BASE_URL}/admin/nitter-instances/${currentNitterInstanceId}`, {
          headers: getHeaders()
        });
        const instanceResult = await instanceResponse.json();
        const instance = instanceResult.data;
        
        if (!instance) {
          throw new Error('无法获取Nitter实例信息');
        }
        
        // 搜索所有Twitter/X推文（通过URL模式识别）
        // 注意：由于推文的source字段存储的是Twitter用户名，无法直接区分是哪个Nitter实例抓取的
        // 这里显示所有通过Nitter抓取的推文（URL包含nitter域名或source以@开头）
        const searchKeyword = document.getElementById('nitterTweetSearch')?.value || '';
        let url = `${API_BASE_URL}/admin/news?page=${page}&pageSize=${pageSize}`;
        if (searchKeyword) {
          url += `&search=${encodeURIComponent(searchKeyword)}`;
        }
        
        const response = await fetch(url, {
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          // 过滤出Twitter/X推文（URL包含nitter、twitter.com或x.com，或source以@开头）
          let news = result.data.news || [];
          news = news.filter(article => {
            const url = (article.url || '').toLowerCase();
            const source = (article.source || '').trim();
            return url.includes('nitter') || 
                   url.includes('twitter.com') || 
                   url.includes('x.com') ||
                   source.startsWith('@') ||
                   source.includes('Twitter') ||
                   source.includes('X');
          });
          
          bodyEl.innerHTML = '';
          
          // 更新表格总记录数（显示过滤后的推文数量）
          document.getElementById('nitterTweetsTotalCount').textContent = news.length;
          document.getElementById('nitterTweetsTableCount').style.display = 'block';
          
          if (news.length === 0) {
            bodyEl.innerHTML = '<tr><td colspan="6" class="empty-state">暂无推文（或没有通过此Nitter实例抓取的推文）</td></tr>';
          } else {
            news.forEach(article => {
              const row = document.createElement('tr');
              const publishDate = formatDate(article.publish_date);
              const title = escapeHtml(article.title || '无标题');
              const summary = escapeHtml((article.summary || '').substring(0, 100));
              
              // 提取Twitter用户名（从来源中提取）
              let twitterUser = article.source || '';
              if (twitterUser.startsWith('@')) {
                twitterUser = twitterUser;
              } else if (article.url) {
                // 尝试从URL提取
                const match = article.url.match(/(?:twitter\.com|x\.com|nitter[^/]+)\/([a-zA-Z0-9_]+)/);
                if (match) {
                  twitterUser = '@' + match[1];
                }
              }
              
              row.innerHTML = `
                <td>${article.id}</td>
                <td><a href="/article.html?id=${article.id}" target="_blank">${title}</a></td>
                <td>${twitterUser}</td>
                <td>${summary}${article.summary && article.summary.length > 100 ? '...' : ''}</td>
                <td>${publishDate}</td>
                <td>
                  <button class="btn btn-delete btn-small" onclick="deleteNews(${article.id})">删除</button>
                </td>
              `;
              bodyEl.appendChild(row);
            });
          }
          
          // 分页
          const totalPages = result.data.totalPages || 1;
          paginationEl.innerHTML = '';
          if (totalPages > 1) {
            paginationEl.innerHTML = `
              <button class="btn" onclick="loadNitterTweets(${page - 1})" ${page === 1 ? 'disabled' : ''}>上一页</button>
              <span>第 ${page} / ${totalPages} 页，共 ${result.data.totalCount || 0} 条</span>
              <button class="btn" onclick="loadNitterTweets(${page + 1})" ${page === totalPages ? 'disabled' : ''}>下一页</button>
            `;
          }
          
          loadingEl.style.display = 'none';
          containerEl.style.display = 'block';
          currentNitterTweetsPage = page;
        }
      } catch (error) {
        console.error('加载推文失败:', error);
        loadingEl.style.display = 'none';
        showMessage('加载推文失败: ' + error.message, 'error');
      }
    }

    // ========== 删除所有文章功能 ==========
    
    // 显示删除所有文章模态框
    async function showDeleteAllNewsModal() {
      const modal = document.getElementById('deleteAllNewsModal');
      const select = document.getElementById('deleteAllNewsUserSelect');
      
      // 加载用户列表
      try {
        const response = await fetch(`${API_BASE_URL}/admin/users`, {
          headers: getHeaders(),
          cache: 'no-cache'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          const users = result.data || [];
          select.innerHTML = '<option value="">请选择用户...</option>';
          
          users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.username} (ID: ${user.id}, 邮箱: ${user.email || '无'})`;
            select.appendChild(option);
          });
        } else {
          showMessage('加载用户列表失败', 'error');
          return;
        }
      } catch (error) {
        console.error('加载用户列表失败:', error);
        showMessage('加载用户列表失败: ' + error.message, 'error');
        return;
      }
      
      modal.classList.add('show');
    }
    
    // 关闭删除所有文章模态框
    function closeDeleteAllNewsModal() {
      const modal = document.getElementById('deleteAllNewsModal');
      modal.classList.remove('show');
      document.getElementById('deleteAllNewsUserSelect').value = '';
    }
    
    // 确认删除用户的所有文章
    async function confirmDeleteAllNews() {
      const select = document.getElementById('deleteAllNewsUserSelect');
      const userId = parseInt(select.value);
      
      if (!userId || isNaN(userId)) {
        showMessage('请选择要删除文章的用户', 'error');
        return;
      }
      
      // 获取用户信息用于显示
      const selectedOption = select.options[select.selectedIndex];
      const username = selectedOption.textContent.split('(')[0].trim();
      
      if (!confirm(`⚠️  警告：您即将删除用户 "${username}" (ID: ${userId}) 的所有文章！\n\n此操作不可恢复！\n\n确定要继续吗？`)) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/admin/news/user/${userId}`, {
          method: 'DELETE',
          headers: getHeaders()
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success) {
          showMessage(result.message || '删除成功', 'success');
          closeDeleteAllNewsModal();
          loadNews(currentNewsPage);
          loadStats();
        } else {
          showMessage(result.message || '删除失败', 'error');
        }
      } catch (error) {
        console.error('删除用户所有文章失败:', error);
        showMessage('删除失败: ' + error.message, 'error');
      }
    }
    
    // 点击模态框外部关闭
    window.onclick = function(event) {
      const modal = document.getElementById('deleteAllNewsModal');
      if (event.target === modal) {
        closeDeleteAllNewsModal();
      }
    }

    // 页面加载完成后自动尝试登录
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[管理员页面] 页面加载完成，检查保存的登录凭证...');
      autoLogin();
    });
  </script>
</body>
</html>
